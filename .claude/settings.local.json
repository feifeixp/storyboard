{
  "permissions": {
    "allow": [
      "Bash(find:*)",
      "Bash(npx tsc:*)",
      "Bash(npm run build:*)",
      "Bash(npm run dev:*)",
      "Bash(xxd:*)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# åœ¨ç¬¬4314è¡Œä¹‹åæ·»åŠ æ›¿æ¢ä»£ç \nold_text = \"\"\"      const sceneDesc = shot.imagePromptEn || shot.promptEn || shot.promptCn || 'empty scene';\n\n\t\t\treturn `${panelPos} panel \\(still\\):\n\t${angleInstruction ? angleInstruction + '\\\\n' : ''}Scene content: ${sceneDesc}\n\tIMPORTANT: Do NOT draw any text, labels, numbers, arrows, or captions inside the panel.`;\"\"\"\n\nnew_text = \"\"\"      const sceneDesc = shot.imagePromptEn || shot.promptEn || shot.promptCn || 'empty scene';\n      // ğŸ†• æ›¿æ¢è§’è‰²åä¸º[å›¾N]æ ‡è®°\n      const replacedSceneDesc = replaceCharacterNames\\(sceneDesc\\);\n\n\t\t\treturn `${panelPos} panel \\(still\\):\n\t${angleInstruction ? angleInstruction + '\\\\n' : ''}Scene content: ${replacedSceneDesc}\n\tIMPORTANT: Do NOT draw any text, labels, numbers, arrows, or captions inside the panel.`;\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# åœ¨ gridShots å®šä¹‰åæ·»åŠ æ”¶é›†ä¹å®«æ ¼æ¶‰åŠè§’è‰²çš„é€»è¾‘\nold_text = \"\"\"      const gridShots = shots.slice\\(startIdx, endIdx\\);\n\n      console.log\\(`[OpenRouter] ğŸ¬ å¼€å§‹ç”Ÿæˆç¬¬ ${gridIndex + 1}/${totalGrids} å¼ ä¹å®«æ ¼ \\(é•œå¤´ #${startIdx + 1} - #${endIdx}\\)`\\);\n\n      // æ„å»ºä¹å®«æ ¼æç¤ºè¯ï¼ˆğŸ†• ä¼ å…¥è§’è‰²å‚è€ƒå›¾ä¿¡æ¯ï¼Œç”¨äºåœ¨æç¤ºè¯ä¸­æ·»åŠ  [å›¾N] æ ‡è®°ï¼‰\n      const gridPrompt = buildNineGridPrompt\\(\"\"\"\n\nnew_text = \"\"\"      const gridShots = shots.slice\\(startIdx, endIdx\\);\n\n      // ğŸ†• æ”¶é›†è¯¥ä¹å®«æ ¼æ¶‰åŠçš„è§’è‰²ï¼ˆæ ¹æ® assignedCharacterIdsï¼‰\n      const characterIdsInGrid = new Set<string>\\(\\);\n      gridShots.forEach\\(shot => {\n        if \\(shot.assignedCharacterIds\\) {\n          shot.assignedCharacterIds.forEach\\(id => characterIdsInGrid.add\\(id\\)\\);\n        }\n      }\\);\n      const charactersInGrid = characterRefs.filter\\(c => characterIdsInGrid.has\\(c.id\\)\\);\n\n      console.log\\(`[OpenRouter] ğŸ¬ å¼€å§‹ç”Ÿæˆç¬¬ ${gridIndex + 1}/${totalGrids} å¼ ä¹å®«æ ¼ \\(é•œå¤´ #${startIdx + 1} - #${endIdx}\\)`\\);\n\n      // ğŸ†• ä¸ºè¯¥ä¹å®«æ ¼æ„å»ºè§’è‰²å‚è€ƒå›¾ä¿¡æ¯ï¼ˆä»…åŒ…å«æ¶‰åŠçš„è§’è‰²ï¼‰\n      let gridCharacterRefImages: { name: string; briefDesc: string; imageUrl: string }[] = [];\n      let globalImageIndex = 0;\n      for \\(const character of charactersInGrid\\) {\n        let imageUrl: string | undefined;\n        let briefDesc = '';\n        // 1. ä¼˜å…ˆï¼šæ ¹æ®é›†æ•°åŒ¹é…å½¢æ€çš„è®¾å®šå›¾\n        if \\(episodeNumber && character.forms && character.forms.length > 0\\) {\n          const matchedForm = matchFormForEpisode\\(character.forms, episodeNumber\\);\n          if \\(matchedForm?.imageSheetUrl\\) {\n            imageUrl = matchedForm.imageSheetUrl;\n            // ç®€è¦æè¿°ï¼šä½¿ç”¨å½¢æ€åï¼ˆå»é™¤emojiå‰ç¼€ï¼‰ï¼Œé™åˆ¶10å­—ä»¥å†…\n            const cleanName = matchedForm.name.replace\\(/[^\\\\\\\\u4e00-\\\\\\\\u9fa5a-zA-Z0-9]/g, ''\\).trim\\(\\);\n            briefDesc = cleanName.length > 10 ? cleanName.slice\\(0, 10\\) : cleanName;\n          }\n        }\n        // 2. å›é€€ï¼šä½¿ç”¨è§’è‰²ä¸»ä½“è®¾å®šå›¾\n        if \\(!imageUrl && character.imageSheetUrl\\) {\n          imageUrl = character.imageSheetUrl;\n          // ç®€è¦æè¿°ï¼šç”¨è§’è‰²å¤–è§‚çš„å‰10å­—\n          const desc = character.appearance || character.name;\n          briefDesc = desc.length > 10 ? desc.slice\\(0, 10\\) : desc;\n        }\n        if \\(imageUrl\\) {\n          globalImageIndex += 1;\n          gridCharacterRefImages.push\\({ name: character.name, briefDesc, imageUrl }\\);\n        }\n      }\n      if \\(gridCharacterRefImages.length > 0\\) {\n        console.log\\(`[OpenRouter] ğŸ“¸ ä¹å®«æ ¼ #${gridIndex + 1} è§’è‰²å‚è€ƒå›¾: ${gridCharacterRefImages.length}å¼ `, gridCharacterRefImages.map\\(r => `${r.name}\\(${r.briefDesc}\\)`\\)\\);\n      }\n\n      // æ„å»ºä¹å®«æ ¼æç¤ºè¯ï¼ˆğŸ†• ä¼ å…¥è§’è‰²å‚è€ƒå›¾ä¿¡æ¯ï¼Œç”¨äºåœ¨æç¤ºè¯ä¸­æ·»åŠ  [å›¾N] æ ‡è®°ï¼‰\n      const gridPrompt = buildNineGridPrompt\\(\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# ä¿®æ”¹ç¬¬3910è¡Œï¼Œä½¿ç”¨ gridCharacterRefImages è€Œé referenceImageUrls\nold_text = \"\"\"              imageUrls: referenceImageUrls.length > 0 ? referenceImageUrls : undefined,  // ğŸ†• ä¸Šä¼ è§’è‰²å‚è€ƒå›¾\"\"\"\n\nnew_text = \"\"\"              imageUrls: gridCharacterRefImages.length > 0 ? gridCharacterRefImages.map\\(r => r.imageUrl\\) : undefined,  // ğŸ†• ä¸Šä¼ æœ¬ä¹å®«æ ¼æ¶‰åŠçš„è§’è‰²å‚è€ƒå›¾\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# åœ¨ç¬¬4080è¡Œï¼ˆreferenceImageUrlsèµ‹å€¼ï¼‰ä¹‹å‰æ·»åŠ è§’è‰²æ”¶é›†é€»è¾‘\nold_text = \"\"\"  const referenceImageUrls = limitedRefImages.map\\(r => r.imageUrl\\);\"\"\"\n\nnew_text = \"\"\"  const referenceImageUrls = limitedRefImages.map\\(r => r.imageUrl\\);\n  // ğŸ†• ä¸ºå•ä¸ªé•œå¤´é‡ç»˜æ”¶é›†è§’è‰²ï¼ˆä»…å½“é•œå¤´æœ‰å…³è”è§’è‰²æ—¶ï¼‰\n  let singleShotCharacterRefImages: { name: string; briefDesc: string; imageUrl: string }[] = [];\n  let singleShotImageIndex = 0;\n  if \\(shot.assignedCharacterIds && shot.assignedCharacterIds.length > 0\\) {\n    for \\(const charId of shot.assignedCharacterIds\\) {\n      const character = characterRefs.find\\(c => c.id === charId\\);\n      if \\(!character\\) continue;\n      \n      let imageUrl: string | undefined;\n      let briefDesc = '';\n      // 1. ä¼˜å…ˆï¼šæ ¹æ®é›†æ•°åŒ¹é…å½¢æ€çš„è®¾å®šå›¾\n      if \\(episodeNumber && character.forms && character.forms.length > 0\\) {\n        const matchedForm = matchFormForEpisode\\(character.forms, episodeNumber\\);\n        if \\(matchedForm?.imageSheetUrl\\) {\n          imageUrl = matchedForm.imageSheetUrl;\n          const cleanName = matchedForm.name.replace\\(/[^\\\\\\\\u4e00-\\\\\\\\u9fa5a-zA-Z0-9]/g, ''\\).trim\\(\\);\n          briefDesc = cleanName.length > 10 ? cleanName.slice\\(0, 10\\) : cleanName;\n        }\n      }\n      // 2. å›é€€ï¼šä½¿ç”¨è§’è‰²ä¸»ä½“è®¾å®šå›¾\n      if \\(!imageUrl && character.imageSheetUrl\\) {\n        imageUrl = character.imageSheetUrl;\n        const desc = character.appearance || character.name;\n        briefDesc = desc.length > 10 ? desc.slice\\(0, 10\\) : desc;\n      }\n      if \\(imageUrl\\) {\n        singleShotImageIndex += 1;\n        singleShotCharacterRefImages.push\\({ name: character.name, briefDesc, imageUrl }\\);\n      }\n    }\n  }\n  if \\(singleShotCharacterRefImages.length > 0\\) {\n    console.log\\(`[OpenRouter] ğŸ“¸ å•æ ¼é‡ç»˜ - è§’è‰²å‚è€ƒå›¾: ${singleShotCharacterRefImages.length}å¼ `, singleShotCharacterRefImages.map\\(r => `${r.name}\\(${r.briefDesc}\\)`\\)\\);\n  }\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# ä¿®æ”¹ç¬¬4133è¡Œå’Œç¬¬4142è¡Œï¼Œä½¿ç”¨å•ä¸ªé•œå¤´çš„è§’è‰²å‚è€ƒå›¾\nold_text = \"\"\"    artStyleSection,\n    limitedRefImages\n  \\);\n\n  // ğŸ”§ ç›´æ¥è°ƒç”¨ Neodomain APIï¼ˆä¸æ‰¹é‡ç”Ÿæˆä¸€è‡´ï¼Œä¸å†è°ƒç”¨ generateSingleImage é¿å…é‡å¤è·å–æ¨¡å‹ï¼‰\n  console.log\\(`[OpenRouter] æäº¤å•æ ¼é‡ç»˜ä»»åŠ¡ #${gridIndex + 1}...`\\);\n  const task = await generateImage\\({\n    prompt: gridPrompt,\n    negativePrompt: 'blurry, low quality, watermark, signature, logo, text, typography, letters, numbers, digits, caption, subtitle, label, annotations, UI overlay, distorted, deformed',\n    modelName: effectiveModel,\n    imageUrls: referenceImageUrls.length > 0 ? referenceImageUrls : undefined,\"\"\"\n\nnew_text = \"\"\"    artStyleSection,\n    limitedRefImages\n  \\);\n\n  // ğŸ”§ ç›´æ¥è°ƒç”¨ Neodomain APIï¼ˆä¸æ‰¹é‡ç”Ÿæˆä¸€è‡´ï¼Œä¸å†è°ƒç”¨ generateSingleImage é¿å…é‡å¤è·å–æ¨¡å‹ï¼‰\n  console.log\\(`[OpenRouter] æäº¤å•æ ¼é‡ç»˜ä»»åŠ¡ #${gridIndex + 1}...`\\);\n  const task = await generateImage\\({\n    prompt: gridPrompt,\n    negativePrompt: 'blurry, low quality, watermark, signature, logo, text, typography, letters, numbers, digits, caption, subtitle, label, annotations, UI overlay, distorted, deformed',\n    modelName: effectiveModel,\n    imageUrls: singleShotCharacterRefImages.length > 0 ? singleShotCharacterRefImages.map\\(r => r.imageUrl\\) : undefined,\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3 << 'EOF'\nimport re\n\nfile_path = \"/Users/ff/Documents/visionary-storyboard-studio/services/openrouter.ts\"\n\n# è¯»å–æ–‡ä»¶\nwith open\\(file_path, 'r', encoding='utf-8'\\) as f:\n    content = f.read\\(\\)\n\n# åˆ é™¤åœ¨é”™è¯¯ä½ç½®æ·»åŠ çš„å•ä¸ªé•œå¤´é‡ç»˜ä»£ç ï¼ˆç¬¬3812-3844è¡Œï¼‰\nold_text = \"\"\"  const referenceImageUrls = limitedRefImages.map\\(r => r.imageUrl\\);\n  // ğŸ†• ä¸ºå•ä¸ªé•œå¤´é‡ç»˜æ”¶é›†è§’è‰²ï¼ˆä»…å½“é•œå¤´æœ‰å…³è”è§’è‰²æ—¶ï¼‰\n  let singleShotCharacterRefImages: { name: string; briefDesc: string; imageUrl: string }[] = [];\n  let singleShotImageIndex = 0;\n  if \\(shot.assignedCharacterIds && shot.assignedCharacterIds.length > 0\\) {\n    for \\(const charId of shot.assignedCharacterIds\\) {\n      const character = characterRefs.find\\(c => c.id === charId\\);\n      if \\(!character\\) continue;\n      \n      let imageUrl: string | undefined;\n      let briefDesc = '';\n      // 1. ä¼˜å…ˆï¼šæ ¹æ®é›†æ•°åŒ¹é…å½¢æ€çš„è®¾å®šå›¾\n      if \\(episodeNumber && character.forms && character.forms.length > 0\\) {\n        const matchedForm = matchFormForEpisode\\(character.forms, episodeNumber\\);\n        if \\(matchedForm?.imageSheetUrl\\) {\n          imageUrl = matchedForm.imageSheetUrl;\n          const cleanName = matchedForm.name.replace\\(/[^\\\\\\\\u4e00-\\\\\\\\u9fa5a-zA-Z0-9]/g, ''\\).trim\\(\\);\n          briefDesc = cleanName.length > 10 ? cleanName.slice\\(0, 10\\) : cleanName;\n        }\n      }\n      // 2. å›é€€ï¼šä½¿ç”¨è§’è‰²ä¸»ä½“è®¾å®šå›¾\n      if \\(!imageUrl && character.imageSheetUrl\\) {\n        imageUrl = character.imageSheetUrl;\n        const desc = character.appearance || character.name;\n        briefDesc = desc.length > 10 ? desc.slice\\(0, 10\\) : desc;\n      }\n      if \\(imageUrl\\) {\n        singleShotImageIndex += 1;\n        singleShotCharacterRefImages.push\\({ name: character.name, briefDesc, imageUrl }\\);\n      }\n    }\n  }\n  if \\(singleShotCharacterRefImages.length > 0\\) {\n    console.log\\(`[OpenRouter] ğŸ“¸ å•æ ¼é‡ç»˜ - è§’è‰²å‚è€ƒå›¾: ${singleShotCharacterRefImages.length}å¼ `, singleShotCharacterRefImages.map\\(r => `${r.name}\\(${r.briefDesc}\\)`\\)\\);\n  }\"\"\"\n\nnew_text = \"\"\"  const referenceImageUrls = limitedRefImages.map\\(r => r.imageUrl\\);\"\"\"\n\ncontent = content.replace\\(old_text, new_text, 1\\)\n\n# å†™å›æ–‡ä»¶\nwith open\\(file_path, 'w', encoding='utf-8'\\) as f:\n    f.write\\(content\\)\n\nprint\\(\"Done\"\\)\nEOF)",
      "Bash(python3:*)",
      "Bash(git checkout:*)",
      "Bash(curl:*)",
      "Bash(wc:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(node:*)",
      "Bash(head:*)",
      "Bash(grep:*)",
      "Bash(awk NR>=2661 && NR<=2663:*)",
      "Bash(/tmp/new_style_section.txt:*)"
    ]
  }
}

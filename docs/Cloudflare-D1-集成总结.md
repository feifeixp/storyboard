# Cloudflare D1 æ•°æ®åº“é›†æˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1ï¸âƒ£ æ•°æ®åº“è®¾è®¡

**æ–‡ä»¶**: `cloudflare/schema.sql`

åˆ›å»ºäº†å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„ï¼š

| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `users` | ç”¨æˆ·è¡¨ | id, phone, email |
| `projects` | é¡¹ç›®è¡¨ | id, user_id, name, settings, characters, scenes |
| `episodes` | å‰§é›†è¡¨ | id, project_id, episode_number, script, shots |
| `character_images` | è§’è‰²å‚è€ƒå›¾ | id, project_id, character_id, oss_url |
| `generated_images` | ç”Ÿæˆçš„å›¾ç‰‡ | id, episode_id, shot_number, oss_url |
| `chat_history` | AIå¯¹è¯å†å² | id, project_id, role, content |
| `sessions` | ç”¨æˆ·ä¼šè¯ | id, user_id, access_token, expires_at |

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨ JSON å­—æ®µå­˜å‚¨å¤æ‚æ•°æ®ï¼ˆsettings, characters, scenes, shotsï¼‰
- âœ… æ”¯æŒçº§è”åˆ é™¤ï¼ˆåˆ é™¤é¡¹ç›®æ—¶è‡ªåŠ¨åˆ é™¤å‰§é›†ï¼‰
- âœ… å®Œæ•´çš„ç´¢å¼•ä¼˜åŒ–ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
- âœ… æ”¯æŒå¤šç”¨æˆ·éš”ç¦»ï¼ˆuser_id å¤–é”®ï¼‰

---

### 2ï¸âƒ£ Cloudflare Workers API

**æ¡†æ¶**: Honoï¼ˆè½»é‡çº§ã€é«˜æ€§èƒ½ï¼‰

**æ–‡ä»¶ç»“æ„**ï¼š
```
cloudflare/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # ä¸»å…¥å£ï¼Œè·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts           # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ auth.ts           # è®¤è¯è·¯ç”±ï¼ˆç™»å½•ã€ç™»å‡ºï¼‰
â”‚       â”œâ”€â”€ projects.ts       # é¡¹ç›®è·¯ç”±ï¼ˆCRUDï¼‰
â”‚       â””â”€â”€ episodes.ts       # å‰§é›†è·¯ç”±ï¼ˆCRUDï¼‰
â”œâ”€â”€ schema.sql                # æ•°æ®åº“è¡¨ç»“æ„
â”œâ”€â”€ wrangler.toml             # Cloudflare é…ç½®
â”œâ”€â”€ package.json              # ä¾èµ–é…ç½®
â””â”€â”€ tsconfig.json             # TypeScript é…ç½®
```

**API ç«¯ç‚¹**ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ |
| `/api/auth/send-code` | POST | å‘é€éªŒè¯ç  |
| `/api/auth/login` | POST | éªŒè¯ç ç™»å½• |
| `/api/auth/logout` | POST | ç™»å‡º |
| `/api/auth/me` | GET | è·å–å½“å‰ç”¨æˆ· |
| `/api/projects` | GET | è·å–æ‰€æœ‰é¡¹ç›® |
| `/api/projects/:id` | GET | è·å–å•ä¸ªé¡¹ç›® |
| `/api/projects` | POST | åˆ›å»ºé¡¹ç›® |
| `/api/projects/:id` | PUT | æ›´æ–°é¡¹ç›® |
| `/api/projects/:id` | DELETE | åˆ é™¤é¡¹ç›® |
| `/api/episodes` | GET | è·å–å‰§é›†åˆ—è¡¨ |
| `/api/episodes/:id` | GET | è·å–å•ä¸ªå‰§é›† |
| `/api/episodes` | POST | åˆ›å»º/æ›´æ–°å‰§é›† |

---

### 3ï¸âƒ£ å‰ç«¯æ•°æ®æœåŠ¡å±‚

**æ–‡ä»¶**: `services/d1Storage.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… å®Œæ•´çš„é¡¹ç›® CRUD æ“ä½œ
- âœ… å®Œæ•´çš„å‰§é›† CRUD æ“ä½œ
- âœ… è‡ªåŠ¨è¿ç§»å·¥å…·ï¼ˆlocalStorage â†’ D1ï¼‰
- âœ… é¡¹ç›®å¯¼å‡º/å¯¼å…¥ï¼ˆå¤‡ä»½æ¢å¤ï¼‰
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨ Token ç®¡ç†

**API å‡½æ•°**ï¼š
```typescript
// é¡¹ç›®ç®¡ç†
getAllProjects(): Promise<Project[]>
getProject(projectId: string): Promise<Project | null>
saveProject(project: Project): Promise<void>
deleteProject(projectId: string): Promise<void>
createProject(name: string): Promise<Project>

// å‰§é›†ç®¡ç†
getEpisodes(projectId: string): Promise<Episode[]>
getEpisode(episodeId: string): Promise<Episode | null>
saveEpisode(projectId: string, episode: Episode): Promise<void>
updateEpisode(projectId: string, episode: Episode): Promise<void>

// æ•°æ®è¿ç§»
migrateFromLocalStorage(): Promise<MigrationResult>
exportProjectToFile(projectId: string): Promise<void>
importProjectFromFile(file: File): Promise<Project>
```

---

### 4ï¸âƒ£ è¿ç§»å·¥å…·ç»„ä»¶

**æ–‡ä»¶**: `components/DataMigrationTool.tsx`

**åŠŸèƒ½**ï¼š
- âœ… ä¸€é”®è¿ç§» localStorage æ•°æ®åˆ° D1
- âœ… å¯¼å…¥é¡¹ç›®ä» JSON æ–‡ä»¶
- âœ… è¿ç§»è¿›åº¦æ˜¾ç¤º
- âœ… é”™è¯¯æç¤ºå’Œå¤„ç†
- âœ… å‹å¥½çš„ç”¨æˆ·ç•Œé¢

---

### 5ï¸âƒ£ éƒ¨ç½²æ–‡æ¡£

**æ–‡ä»¶**: `docs/Cloudflare-D1-éƒ¨ç½²æŒ‡å—.md`

**å†…å®¹**ï¼š
- âœ… å®Œæ•´çš„éƒ¨ç½²æ­¥éª¤ï¼ˆä»é›¶å¼€å§‹ï¼‰
- âœ… æ•°æ®åº“åˆå§‹åŒ–æŒ‡å—
- âœ… å‰ç«¯é…ç½®è¯´æ˜
- âœ… æ•°æ®è¿ç§»æ–¹æ³•
- âœ… å¸¸è§é—®é¢˜è§£ç­”
- âœ… è´¹ç”¨è¯´æ˜

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. **å¤šè®¾å¤‡åŒæ­¥**
- æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯ï¼Œéšæ—¶éšåœ°è®¿é—®
- æ”¯æŒå¤šè®¾å¤‡ï¼ˆç”µè„‘ã€å¹³æ¿ã€æ‰‹æœºï¼‰åŒæ­¥

### 2. **åä½œæ”¯æŒ**
- å¤šç”¨æˆ·éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„é¡¹ç›®
- æœªæ¥å¯æ‰©å±•å›¢é˜Ÿåä½œåŠŸèƒ½

### 3. **æ•°æ®å®‰å…¨**
- Cloudflare å…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œé«˜å¯ç”¨æ€§
- è‡ªåŠ¨å¤‡ä»½ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±
- æ”¯æŒå¯¼å‡ºåˆ°æœ¬åœ°æ–‡ä»¶

### 4. **æ€§èƒ½ä¼˜åŒ–**
- è¾¹ç¼˜è®¡ç®—ï¼Œä½å»¶è¿Ÿ
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- JSON å­—æ®µå­˜å‚¨ï¼Œçµæ´»é«˜æ•ˆ

### 5. **æˆæœ¬ä½å»‰**
- Cloudflare D1 å…è´¹è®¡åˆ’ï¼š5GB å­˜å‚¨ + 500ä¸‡æ¬¡/æ—¥è¯»å–
- å¯¹äºä¸ªäººå’Œå°å›¢é˜Ÿå®Œå…¨å…è´¹

---

## ğŸ“Š æ•°æ®å¯¹æ¯”

| ç‰¹æ€§ | localStorage | Cloudflare D1 |
|------|-------------|---------------|
| å­˜å‚¨å®¹é‡ | 5-10MB | 5GBï¼ˆå…è´¹ï¼‰ |
| å¤šè®¾å¤‡åŒæ­¥ | âŒ | âœ… |
| æ•°æ®å¤‡ä»½ | âŒ | âœ… è‡ªåŠ¨ |
| åä½œæ”¯æŒ | âŒ | âœ… |
| æ•°æ®å®‰å…¨ | âš ï¸ æ¸…é™¤ç¼“å­˜ä¼šä¸¢å¤± | âœ… äº‘ç«¯å­˜å‚¨ |
| è®¿é—®é€Ÿåº¦ | âœ… æå¿«ï¼ˆæœ¬åœ°ï¼‰ | âœ… å¿«ï¼ˆè¾¹ç¼˜ç½‘ç»œï¼‰ |
| æˆæœ¬ | å…è´¹ | å…è´¹ï¼ˆ5GBå†…ï¼‰ |

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. éƒ¨ç½² Cloudflare Workers

```bash
cd cloudflare
npm install
wrangler login
wrangler d1 create storyboard-db
npm run deploy
```

### 2. é…ç½®å‰ç«¯

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½® API URLï¼š
```env
VITE_API_URL=https://your-api-url.workers.dev
```

### 3. è¿ç§»æ•°æ®

åœ¨åº”ç”¨ä¸­ä½¿ç”¨ `DataMigrationTool` ç»„ä»¶ï¼Œä¸€é”®è¿ç§»ç°æœ‰æ•°æ®ã€‚

### 4. æµ‹è¯•éªŒè¯

- åˆ›å»ºæ–°é¡¹ç›®
- åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤æ•°æ®æŒä¹…åŒ–
- åœ¨ä¸åŒè®¾å¤‡ç™»å½•ï¼Œç¡®è®¤æ•°æ®åŒæ­¥

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. è®¤è¯é›†æˆ

å½“å‰ä½¿ç”¨ç®€åŒ–çš„éªŒè¯ç ç™»å½•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®é›†æˆï¼š
- çŸ­ä¿¡éªŒè¯ç æœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰
- é‚®ä»¶éªŒè¯ç æœåŠ¡ï¼ˆå¦‚ SendGridã€Mailgunï¼‰
- OAuth ç™»å½•ï¼ˆGoogleã€GitHub ç­‰ï¼‰

### 2. æ•°æ®å‹ç¼©

D1 æ•°æ®åº“çš„ JSON å­—æ®µä¸ä¼šè‡ªåŠ¨å‹ç¼©ï¼Œå¦‚æœé¡¹ç›®æ•°æ®å¾ˆå¤§ï¼Œå»ºè®®ï¼š
- åœ¨å­˜å‚¨å‰å‹ç¼© JSONï¼ˆä½¿ç”¨ LZ-Stringï¼‰
- è¯»å–æ—¶è§£å‹ç¼©

### 3. å›¾ç‰‡å­˜å‚¨

å›¾ç‰‡æ–‡ä»¶ä¸åº”å­˜å‚¨åœ¨ D1 æ•°æ®åº“ä¸­ï¼Œè€Œæ˜¯ï¼š
- å­˜å‚¨åœ¨é˜¿é‡Œäº‘ OSSï¼ˆå·²é›†æˆï¼‰
- æ•°æ®åº“ä¸­åªå­˜å‚¨ OSS URL

### 4. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼ˆé¿å…ä¸€æ¬¡åŠ è½½æ‰€æœ‰é¡¹ç›®ï¼‰
- ä½¿ç”¨ç¼“å­˜ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- ä½¿ç”¨ CDNï¼ˆåŠ é€Ÿé™æ€èµ„æºï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Cloudflare D1 éƒ¨ç½²æŒ‡å—](./Cloudflare-D1-éƒ¨ç½²æŒ‡å—.md)
- [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)ï¼ˆå¾…åˆ›å»ºï¼‰
- [æ•°æ®è¿ç§»æŒ‡å—](./æ•°æ®è¿ç§»æŒ‡å—.md)ï¼ˆå¾…åˆ›å»ºï¼‰

---

**é›†æˆå®Œæˆï¼ç°åœ¨ä½ çš„åˆ†é•œè„šæœ¬ç”Ÿæˆé¡¹ç›®æ”¯æŒäº‘ç«¯å­˜å‚¨å’Œå¤šè®¾å¤‡åŒæ­¥äº†ï¼** ğŸ‰


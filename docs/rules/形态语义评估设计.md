# 形态语义评估设计方案

**版本**: 1.0  
**创建时间**: 2025-01-XX  
**目的**: 通过 LLM 语义判断替代硬编码黑名单，实现通用的形态过滤机制

---

## 🎯 背景和目标

### 问题

当前形态提取流程存在以下问题：

1. **硬编码黑名单不可持续**：
   - `BLOCKED_STATE_NAME_KEYWORDS` 需要不断扩展
   - 每次遇到新的垃圾形态就要加新关键词
   - 不符合"通用工具"原则

2. **规则匹配容易误判**：
   - "糙汉配合伪装" - 可能是长期伪装形态，也可能是一次性事件
   - "腹部受伤警惕" - 明显是剧情瞬间，但不包含"被"、"后"等关键词
   - 规则无法理解语义，只能机械匹配

3. **缺乏专业判断**：
   - 没有站在"造型师/导演"的角度思考
   - 没有问"这个状态值得做成长期形态吗？"

### 目标

设计一个 **LLM 驱动的形态语义评估机制**，实现：

1. ✅ **通用性**：适用于所有题材（女频、科幻、历史、现代等）
2. ✅ **专业判断**：让 LLM 像专业造型师一样思考
3. ✅ **可验证性**：输出结构化 JSON，代码可验证
4. ✅ **可解释性**：每个决策都有 `reason` 字段

---

## 📋 核心原则

遵循项目规则中的核心原则：

1. **通用工具原则**：
   - 不针对特定题材或角色类型
   - 不硬编码"避免XX元素"
   - 适用于男性、女性、儿童、老年人等所有角色

2. **专业判断原则**：
   - 让 LLM 像专业造型师/导演一样思考
   - 每个决策都要求"为什么"
   - 通过"自我批判"提升质量

3. **提问式引导**：
   - 不说"禁止使用XX"
   - 而是问"这个状态是否值得做成长期形态？"
   - 引导 LLM 自己判断

---

## 🔧 设计方案

### 调用时机

在智能形态补全流程中，位于以下位置：

```
extractCharacterStates (提取候选状态)
  ↓
refineCharacterForms (去重、数量限制) ← 现有
  ↓
🆕 evaluateFormSemantics (语义评估) ← 新增
  ↓
最终 forms 列表
```

### 输入定义

```typescript
interface FormEvaluationInput {
  characterName: string;           // 角色名称
  characterRole?: string;           // 角色定位（主角/配角/反派）
  scriptType?: string;              // 剧本类型（女频言情/科幻/历史等）
  candidateForms: Array<{
    name: string;                   // 形态名称
    description: string;            // 形态描述
    episodes: number[];             // 出现在哪几集
    changeType: string;             // 变化类型（damage/costume/transformation等）
    keyFrames?: string[];           // 关键帧描述（可选）
  }>;
}
```

### 输出定义

```typescript
interface FormEvaluationOutput {
  evaluations: Array<{
    originalName: string;           // 原始形态名称
    normalizedName: string | null;  // 规范化后的名称（如果保留）
    category: 'stable_form' | 'transient_event' | 'emotion_only';
    shouldKeepAsForm: boolean;      // 是否保留为形态
    reason: string;                 // 判断理由（50-100字）
    confidence: number;             // 置信度（0-1）
  }>;
}
```

### 分类标准

| 分类 | 说明 | 示例 | 是否保留 |
|------|------|------|----------|
| **stable_form** | 长期可复用的造型形态，可以在多个场景中反复出现 | "日常形态"、"战损形态"、"伪装西装形态" | ✅ 保留 |
| **transient_event** | 一次性剧情事件，只在特定情节中出现 | "强吻后刀疤显露"、"被踹倒在地" | ❌ 不保留 |
| **emotion_only** | 纯情绪状态，没有明显的外观变化 | "惊慌失措"、"愤怒咆哮" | ❌ 不保留 |

---

## 📝 Prompt 设计

### 核心思路

不告诉 LLM "不要XX"，而是引导它思考：

1. 这个状态是否有**稳定的视觉特征**？
2. 这个状态是否可以在**多个场景中复用**？
3. 这个状态是否值得**单独画设定图**？

### Prompt 模板

```markdown
你是一位专业的影视角色造型师和分镜导演。

现在需要你评估角色"${characterName}"的候选形态列表，判断哪些值得保留为长期形态。

## 角色信息
- 角色名称：${characterName}
- 角色定位：${characterRole}
- 剧本类型：${scriptType}

## 候选形态列表
${candidateForms.map((f, i) => `
${i + 1}. **${f.name}**
   - 描述：${f.description}
   - 出现集数：${f.episodes.join(', ')}
   - 变化类型：${f.changeType}
`).join('\n')}

## 评估标准

作为专业造型师，请从以下角度评估每个形态：

### 1. 视觉稳定性
- 这个状态是否有**明确的、稳定的视觉特征**？
- 还是只是一个**瞬间的动作或情绪**？

### 2. 复用价值
- 这个状态是否可以在**多个场景、多集中反复出现**？
- 还是只在**某一个特定情节**中出现？

### 3. 设定图价值
- 如果要为这个角色画设定图，这个状态是否值得**单独画一版**？
- 还是只需要在分镜中临时表现即可？

## 输出要求

对每个候选形态，输出以下结构化判断：

\`\`\`json
{
  "evaluations": [
    {
      "originalName": "形态原始名称",
      "normalizedName": "规范化后的名称（如果保留）或 null",
      "category": "stable_form | transient_event | emotion_only",
      "shouldKeepAsForm": true/false,
      "reason": "判断理由（50-100字，说明为什么保留或不保留）",
      "confidence": 0.0-1.0
    }
  ]
}
\`\`\`

### 分类说明

- **stable_form**：长期可复用的造型形态（如"日常形态"、"战损形态"、"伪装形态"）
- **transient_event**：一次性剧情事件（如"被打倒在地"、"强吻后惊慌"）
- **emotion_only**：纯情绪状态，没有明显外观变化（如"愤怒"、"惊慌失措"）

### 注意事项

1. **不要过度保守**：如果一个形态确实有稳定的视觉特征且可能复用，应该保留
2. **不要过度宽松**：如果一个形态只是剧情瞬间，不应该保留
3. **规范化名称**：如果保留，给出一个更规范的名称（如"糙汉配合伪装" → "糙汉伪装形态"）
```

---

## 📊 典型示例

基于本次测试中的真实案例：

### 示例 1：秦枭的候选形态

**输入**：
```json
{
  "characterName": "秦枭",
  "characterRole": "主角",
  "scriptType": "女频言情 / 重生 / 90年代农村",
  "candidateForms": [
    {
      "name": "糙汉配合伪装",
      "description": "为了配合苏曼的重生计划，秦枭伪装成粗犷的糙汉形象...",
      "episodes": [1],
      "changeType": "costume"
    },
    {
      "name": "腹部受伤警惕",
      "description": "在与家暴男对峙时腹部受伤，眼神警惕...",
      "episodes": [1],
      "changeType": "damage"
    },
    {
      "name": "强吻后挑眉露疤",
      "description": "强吻苏曼后挑眉，右眉尾的疤痕显露...",
      "episodes": [1],
      "changeType": "other"
    }
  ]
}
```

**预期输出**：
```json
{
  "evaluations": [
    {
      "originalName": "糙汉配合伪装",
      "normalizedName": "糙汉伪装形态",
      "category": "stable_form",
      "shouldKeepAsForm": true,
      "reason": "这是一个有明确视觉特征的伪装造型（粗犷、糙汉风格），在剧情中可能会反复出现，值得作为一个独立形态保留。",
      "confidence": 0.85
    },
    {
      "originalName": "腹部受伤警惕",
      "normalizedName": null,
      "category": "transient_event",
      "shouldKeepAsForm": false,
      "reason": "这是一次性的受伤事件，'警惕'更多是情绪而非稳定的外观特征。受伤状态在分镜中临时表现即可，不需要单独做形态。",
      "confidence": 0.9
    },
    {
      "originalName": "强吻后挑眉露疤",
      "normalizedName": null,
      "category": "transient_event",
      "shouldKeepAsForm": false,
      "reason": "这是一个特定剧情瞬间的动作（强吻后挑眉），不是一个可复用的造型形态。疤痕本身已经在日常形态中描述，不需要单独形态。",
      "confidence": 0.95
    }
  ]
}
```

### 示例 2：家暴男的候选形态

**输入**：
```json
{
  "characterName": "家暴男",
  "characterRole": "反派",
  "scriptType": "女频言情 / 重生 / 90年代农村",
  "candidateForms": [
    {
      "name": "噩梦中伤痕累累的家暴男",
      "description": "在苏曼的噩梦中，家暴男浑身伤痕累累...",
      "episodes": [1],
      "changeType": "damage"
    },
    {
      "name": "日常凶狠形态",
      "description": "家暴男的日常状态，眼神凶狠，体态粗壮...",
      "episodes": [1],
      "changeType": "baseline"
    }
  ]
}
```

**预期输出**：
```json
{
  "evaluations": [
    {
      "originalName": "噩梦中伤痕累累的家暴男",
      "normalizedName": null,
      "category": "transient_event",
      "shouldKeepAsForm": false,
      "reason": "这是梦境中的一次性场景，不是真实世界中的造型形态。梦境场景应该在分镜中临时处理，不需要单独形态。",
      "confidence": 0.95
    },
    {
      "originalName": "日常凶狠形态",
      "normalizedName": "日常形态",
      "category": "stable_form",
      "shouldKeepAsForm": true,
      "reason": "这是角色的日常基准形态，有明确的视觉特征（凶狠眼神、粗壮体态），是长期稳定的造型，应该保留。",
      "confidence": 0.95
    }
  ]
}
```

### 示例 3：边界案例

**输入**：
```json
{
  "characterName": "苏曼",
  "characterRole": "主角",
  "scriptType": "女频言情 / 重生 / 90年代农村",
  "candidateForms": [
    {
      "name": "重生后初始",
      "description": "重生后的苏曼，穿着破旧的衣服，眼神坚定...",
      "episodes": [1],
      "changeType": "baseline"
    },
    {
      "name": "战损逃亡",
      "description": "从家暴男手中逃脱后，衣服破损，脸上有泥土...",
      "episodes": [1],
      "changeType": "damage"
    },
    {
      "name": "绝地反击",
      "description": "反击家暴男时的状态，眼神凌厉，姿态强势...",
      "episodes": [1],
      "changeType": "other"
    }
  ]
}
```

**预期输出**：
```json
{
  "evaluations": [
    {
      "originalName": "重生后初始",
      "normalizedName": "日常形态",
      "category": "stable_form",
      "shouldKeepAsForm": true,
      "reason": "这是角色重生后的基准形态，会在多集中持续出现，是长期稳定的造型，应该保留为日常形态。",
      "confidence": 0.9
    },
    {
      "originalName": "战损逃亡",
      "normalizedName": "战损形态",
      "category": "stable_form",
      "shouldKeepAsForm": true,
      "reason": "虽然是逃亡场景，但'战损'是一个有明确视觉特征的状态（衣服破损、脸上泥土），在后续剧情中可能会有类似的战斗/逃亡场景，值得保留。",
      "confidence": 0.75
    },
    {
      "originalName": "绝地反击",
      "normalizedName": null,
      "category": "emotion_only",
      "shouldKeepAsForm": false,
      "reason": "'绝地反击'更多是一种情绪和姿态，而非稳定的外观特征。'眼神凌厉、姿态强势'可以在分镜中通过表情和动作表现，不需要单独形态。",
      "confidence": 0.8
    }
  ]
}
```

---

## 🔗 与现有流程的集成

### 调用位置

在 `storyboard/services/characterSupplement/index.ts` 中：

```typescript
// 🆕 阶段5.5: 智能形态补全（只在需要forms时执行）
if (needForms) {
  await onProgress?.('stage5.5', 'start', '🔄 阶段5.5: 智能形态补全');

  // 1. 提取所有形态（使用旧方法）
  let extractedForms = await extractCharacterStates(character, scripts, model);
  console.log(`[智能形态补全] 提取到 ${extractedForms.length} 个形态`);

  // 1.5. 形态清洗（去重、数量限制）
  if (extractedForms.length > 0) {
    extractedForms = refineCharacterForms(
      character.name,
      extractedForms,
      character.role,
      false
    );
    console.log(`[智能形态补全] 清洗后剩余 ${extractedForms.length} 个形态`);
  }

  // 🆕 1.6. 形态语义评估（新增）
  if (extractedForms.length > 0) {
    extractedForms = await evaluateFormSemantics(
      character.name,
      extractedForms,
      {
        characterRole: stage1?.characterPosition?.role,
        scriptType: stage1?.scriptType?.category,
        model: model
      }
    );
    console.log(`[智能形态补全] 语义评估后剩余 ${extractedForms.length} 个形态`);
  }

  // 2. 如果有形态，选出最重要的一个做详细设计
  if (extractedForms.length > 0) {
    // ... 现有逻辑
  }
}
```

### 函数签名

```typescript
/**
 * 形态语义评估
 *
 * 通过 LLM 判断每个候选形态是否值得保留为长期形态
 *
 * @param characterName 角色名称
 * @param candidateForms 候选形态列表
 * @param options 评估选项
 * @returns 过滤后的形态列表（只保留 shouldKeepAsForm = true 的）
 */
export async function evaluateFormSemantics(
  characterName: string,
  candidateForms: CharacterForm[],
  options: {
    characterRole?: string;
    scriptType?: string;
    model?: string;
  }
): Promise<CharacterForm[]> {
  // 实现逻辑
}
```

---

## ✅ 优势总结

相比硬编码黑名单，这个方案的优势：

1. **通用性**：
   - 不依赖特定题材的关键词
   - 适用于所有剧本类型（女频、科幻、历史、现代等）

2. **可维护性**：
   - 不需要不断扩展黑名单
   - 规则集中在 Prompt 中，易于调整

3. **专业性**：
   - 让 LLM 像专业造型师一样思考
   - 每个决策都有明确的理由

4. **可验证性**：
   - 输出结构化 JSON
   - 代码可以验证 `shouldKeepAsForm` 字段

5. **可解释性**：
   - 每个决策都有 `reason` 字段
   - 用户可以理解为什么某个形态被保留或过滤

---

## 🚀 后续步骤

1. ✅ 完成设计文档（本文档）
2. ⏳ 实现 `evaluateFormSemantics` 函数
3. ⏳ 在主流程中集成调用
4. ⏳ 测试验证效果
5. ⏳ 根据测试结果调整 Prompt

---

**创建时间**: 2025-01-XX
**维护人**: AI Assistant
**适用范围**: 形态语义评估功能



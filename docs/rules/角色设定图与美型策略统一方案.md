# 角色设定图与美型策略统一方案（架构级）

**版本**：v1.0  
**适用范围**：角色智能补全（Stage1–5）、角色设定图生成、美型/服装/身材/人种相关规则  
**主要回归用例**：秦枭角色设定图  
**最后更新**：2026-02-25

---

## 1. 背景与问题

### 1.1 现象

在秦枭测试中暴露出以下四类系统性问题：

1. **人种错误**：中文外观明确写了「中国人，男，28岁，中国九十年代」，角色设定图却生成了典型欧美白人脸。
2. **提示词主次失衡**：英文 prompt 中摄影参数/风格段落很长，但主体 identity（人种/脸型/身材）信息极其贫弱，仅有 `dark brown hair, short hair` 两个词，模型按默认白人模板生成。
3. **Stage4 多版本规则漂移**：`stage4-costume-design.ts → -v2.ts → -fast.ts → -optimized.ts` 多代文件并存，"极致美型类 + 底层 → 穷但精致"的核心规则在 fast/optimized 版本中退化为"底层/乡村→朴素实用"。
4. **身材描述偏弱**：极致美型主角的身材曲线/体态在设定图中仍偏"普通路人"。

---

## 2. 总体目标（架构层）

1. **身份一致性**：人种/族群、性别、年龄段、头身比例、身材类型在所有设定图（含各形态）中高度一致。
2. **规则单一真源**：Stage2/3/4 的 detailed/fast 版本共享同一套美型规则与服装策略配置，修改只改一处。
3. **Prompt 主次权重重构**：token 预算向 identity（人是谁）+ 身材 + 关键服装特征倾斜。
4. **通用工具原则**：身材/美型/人种策略适用于男女老少、各种剧本类型与角色定位，不预设特定对象。
5. **可回归与可验证**：以秦枭等核心角色建立固定回归用例，每次改动均通过日志+肉眼检查。

---

## 3. 现状架构梳理

### 3.1 角色补全阶段（characterSupplement）

- 入口：`services/characterSupplement/index.ts`
- 权威版本（当前实际调用）：
  - Stage3 详细：`stage3-appearance-design-optimized.ts`
  - Stage3 快速：`stage3-appearance-design-fast.ts`
  - Stage4 详细：`stage4-costume-design-optimized.ts`
  - Stage4 快速：`stage4-costume-design-fast.ts`
- 旧版文件（`stage3/4-costume-design.ts`、`-v2.ts`）已不再被实际调用，仅作历史参考。

### 3.2 角色设定图生成（ProjectDashboard）

- 数据源：`character.appearance`（中文）
- 三步处理：
  1. `sanitizeAppearanceWithLLM`：清理情绪化/剧情化描述
  2. `extractKeyAppearanceFeatures(mode: 'full'|'identity'|'baselineLook')`：产出英文关键词
  3. `translateClothingToEnglish(mode: 'baseline'|'form')`：产出英文服装段落
- 最终 Prompt 结构：`subjectPrompt` + `mediumStylePrompt` + `contextLightingPrompt` + `clothingDetailsPrompt` + 布局/表情/禁止元素
- **现状缺陷**：`subjectPrompt` 无人种/族群槽位；`negativePrompt` 无防错人种条目。

---

## 4. 第一阶段实施范围

> 优先解决最高优先级两个问题：人种错误 + fast/optimized 服装规则漂移。

### 4.1 改动文件一览

| # | 文件 | 类型 | 主要改动 |
|---|------|------|---------|
| 1 | `storyboard/components/ProjectDashboard.tsx` | 代码 | 新增 ethnicity 检测与 identity slot 注入；按需增加人种负向提示词 |
| 2 | `services/characterSupplement/stage4-costume-design-optimized.ts` | 代码 | 修复 idealized 中"底层→朴素实用"为"穷但精致" |
| 3 | `services/characterSupplement/stage4-costume-design-fast.ts` | 代码 | 与 optimized 同步"穷但精致"规则，消除 detailed/fast 漂移 |
| 4 | `.augment/rules/project_Rules.md` | 规则 | 新增 R00X「架构级问题处理规范」 |

---

## 5. 方案细节设计

### 5.1 种族/人种识别与 Prompt 注入

#### 5.1.1 分类维度（现实 + 幻想，通用）

| 类别 | 中文关键词（示例） | 英文 identity 描述 |
|------|-----------------|-------------------|
| East Asian（东亚） | 中国人、华人、东亚、日本、韩国、朝鲜 | `East Asian, Chinese/Japanese/Korean [gender], East Asian facial features` |
| Southeast Asian（东南亚） | 东南亚、泰国、越南、菲律宾、马来、印尼 | `Southeast Asian [gender], Southeast Asian facial features` |
| South Asian（南亚） | 南亚、印度、巴基斯坦、孟加拉、斯里兰卡 | `South Asian [gender], South Asian facial features` |
| African（非洲） | 非洲人、非裔 | `African [gender], African descent, characteristic facial features` |
| European（欧洲） | 欧洲人、欧美人、白人、西方人 | `European [gender], Caucasian, European facial features` |
| Latino（拉丁裔） | 拉丁、拉美 | `Latino/Latina [gender], Latin American descent` |
| Middle Eastern（中东） | 中东、阿拉伯 | `Middle Eastern [gender], Middle Eastern facial features` |
| Fantasy（幻想种族） | 魔族、妖族、精灵、兽人、龙裔、神族、恶魔 | `fantasy race: [具体种族], humanoid form` |
| Other / 无法识别 | — | 不注入，回退旧行为 |

#### 5.1.2 接口设计

```ts
type EthnicityCategory =
  | 'east_asian' | 'southeast_asian' | 'south_asian'
  | 'african' | 'european' | 'latino' | 'middle_eastern'
  | 'fantasy' | 'other';

interface EthnicitySlot {
  identityEn: string;   // 正向身份描述，前置于 subjectPrompt
  negativeEn?: string;  // 防错人种负向词（视情况使用，首版仅东亚启用）
}

// 从外观文本解析分类
function detectEthnicityCategory(text: string): EthnicityCategory | null

// 生成槽位内容
function buildEthnicitySlot(category: EthnicityCategory, gender: string): EthnicitySlot

// 对外统一入口
function getEthnicitySlot(character: Character, cleanedAppearance: string): EthnicitySlot | null
```

#### 5.1.3 注入位置

**常态设定图（无 targetForm）**

```ts
// 修改前
subjectPrompt = identityFeaturesEn;

// 修改后
const ethnicitySlot = getEthnicitySlot(character, cleanedAppearance);
const subjectParts: string[] = [];
if (ethnicitySlot?.identityEn) subjectParts.push(ethnicitySlot.identityEn);
if (identityFeaturesEn) subjectParts.push(identityFeaturesEn);
subjectPrompt = subjectParts.join(', ');
```

**形态图（编辑式 Keep 模板）**

```ts
// 在 keepUnchangedParts 数组最前面插入
if (ethnicitySlot?.identityEn) {
  keepUnchangedParts.unshift('- Ethnicity: ' + ethnicitySlot.identityEn);
}
```

**negativePrompt**

```ts
// 仅东亚角色启用，其他族群暂不加负向词
const ethnicityNegative = ethnicitySlot?.negativeEn || '';
// 拼入现有 negativePrompt 数组
```

首版东亚负向词示例：`Caucasian, Western features, European facial structure, non-Asian`

---

### 5.2 Stage4 服装规则统一："穷但精致"

#### 5.2.1 权威规则（来自原始 stage4-costume-design.ts）

- 极致美型类 + 底层/乡村：
  - 便宜但干净的布料
  - 有记忆点的小细节（碎花、刺绣、配色）
  - 日常造型**禁止**用"破旧/脏污/赤脚"做主基调
  - "破旧/脏污"只用于战损/特殊形态，不做 baseline

#### 5.2.2 修正内容（optimized 与 fast 统一改为）

```text
* 必须符合角色身份：
  - 底层/乡村 → 穷但精致：便宜但干净的布料，有记忆点的小细节（颜色/纹理/刺绣等），
    不以"破旧、脏污、赤脚"作为日常基调
  - 都市/白领 → 时尚精致：款式更现代，剪裁与搭配更讲究
- ⚠️"破旧/脏污/赤脚"只用于战损或特殊剧情形态，不作为常规日常造型
```

---

### 5.3 R00X 架构级问题处理规范

新增至 `.augment/rules/project_Rules.md`，核心内容：

- **触发条件**：多阶段流程 bug、多版本规则不一致、提示词质量严重偏差
- **必须输出**：全局根因分析 + 架构级方案 + 局部修复方案 + 回归用例
- **禁止**：只改某处 Prompt 不说明全局影响；多版本场景不说明权威版本与迁移策略

---

## 6. 验证方案

### 6.1 秦枭（东亚男主）

1. 重新生成 baseline 角色设定图
2. 检查控制台 `[提示词调试]` 日志：
   - prompt 开头应有：`East Asian, Chinese male, East Asian facial features, ...`
   - negativePrompt 中应有：`Caucasian, Western features, ...`
3. 肉眼确认：五官/肤色明显为东亚男，多次重试人种稳定

### 6.2 极致美型底层女主

1. 选"女频言情/重生 + 底层女主"剧本
2. 分别用 detailed 和 fast 模式跑 Stage4
3. 检查：
   - 两种模式 Prompt 均出现"穷但精致"语义，无"朴素实用"
   - 服装描述呈现"便宜但精致、有记忆点"的日常造型

### 6.3 无人种描述角色

- 确认：不注入 ethnicitySlot，行为与修改前完全相同

---

## 7. 后续扩展路线（第二阶段，规划中）

| 优先级 | 项目 | 说明 |
|--------|------|------|
| 高 | 规则配置模块化 | 新增 `beautyLevels.ts`、`costumeRules.ts`、`ethnicityConfig.ts`，消灭多版本复制 |
| 高 | 身材设计系统强化 | Stage3 加入体型档位（slender/athletic/soft curves/sturdy）；identity 槽显式注入身材描述 |
| 中 | Prompt 压缩与模型专用模板 | 为 Banana Pro/Flux/SDXL 设计短 prompt 模板，减少无效摄影参数 |
| 低 | 一致性单元测试 | 断言"极致美型+底层"时配置层返回正确策略，防止未来回归 |

---

*文档由 AI Assistant 整理，基于 2026-02-25 架构讨论结论生成。*


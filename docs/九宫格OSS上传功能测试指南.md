# 九宫格 OSS 上传功能测试指南

## 📋 功能概述

**更新时间**: 2024-12-26  
**功能**: 九宫格草图生成后自动上传到阿里云 OSS，替代 Neodomain 临时 URL

### 🎯 解决的问题

1. **Neodomain 图片 URL 可能过期** - 之前只保存临时 URL，图片可能失效
2. **云端保存失败** - 修复了"已应用到本地分镜表，但保存到云端失败"的错误
3. **图片永久存储** - 使用 OSS 存储，确保图片长期可用

---

## 🔧 技术实现

### 1. 核心流程

```
生成九宫格 → 获取 Neodomain 临时 URL → 下载图片 → 上传到 OSS → 返回 OSS 永久 URL → 保存到 D1
```

### 2. 涉及文件

| 文件 | 修改内容 |
|------|----------|
| `services/openrouter.ts` | 添加 `downloadAndUploadToOSS` 函数，修改 `generateMergedStoryboardSheet` 和 `generateSingleGrid` |
| `services/oss.ts` | 已有 STS 令牌获取和上传功能（无需修改） |
| `App.tsx` | 传入 `projectId` 参数到九宫格生成函数 |

### 3. OSS 路径规则

```
storyboard/{projectId}/nine-grid/grid_{gridIndex}_{timestamp}.jpg
```

**示例**:
```
storyboard/proj-1735200000000/nine-grid/grid_0_1735200123456.jpg
storyboard/proj-1735200000000/nine-grid/grid_1_1735200234567.jpg
```

---

## ✅ 测试步骤

### 前置条件

1. ✅ 已登录 Neodomain 账号
2. ✅ 已创建项目并选择剧集
3. ✅ 已生成分镜列表（至少 9 个镜头）

### 测试用例 1：生成九宫格并验证 OSS 上传

**步骤**:
1. 点击"🎨 生成九宫格草图"按钮
2. 等待生成完成（观察控制台日志）
3. 检查浏览器控制台是否有以下日志：
   ```
   [OSS] 开始下载九宫格图片 #1: https://...
   [OSS] 图片下载成功，大小: XXX KB
   [OSS] 九宫格 #1 上传进度: 20%
   [OSS] 九宫格 #1 上传进度: 40%
   ...
   [OSS] ✅ 九宫格 #1 上传成功: https://wlpaas.oss-cn-shanghai.aliyuncs.com/...
   ```
4. 点击"🎨 应用到分镜表"按钮
5. 检查是否显示"✅ 九宫格草图已应用到分镜表，并已保存到云端。"

**预期结果**:
- ✅ 控制台显示 OSS 上传成功日志
- ✅ 图片 URL 以 `https://wlpaas.oss-cn-shanghai.aliyuncs.com/` 开头
- ✅ 应用到分镜表成功，无错误提示
- ✅ 刷新页面后图片仍然可见

### 测试用例 2：单独重新生成某一张九宫格

**步骤**:
1. 在已生成的九宫格列表中，点击某一张的"🔄 重新生成"按钮
2. 等待生成完成
3. 检查控制台日志是否包含 OSS 上传成功信息

**预期结果**:
- ✅ 重新生成成功
- ✅ 新图片已上传到 OSS
- ✅ 图片 URL 已更新

### 测试用例 3：OSS 上传失败降级处理

**步骤**:
1. 断开网络连接（或修改 OSS 配置使其失败）
2. 生成九宫格
3. 检查控制台是否有降级日志：
   ```
   [OSS] ❌ 九宫格 #1 上传失败: ...
   [OSS] 降级使用 Neodomain 临时 URL: https://...
   ```

**预期结果**:
- ✅ 即使 OSS 上传失败，仍然使用 Neodomain 临时 URL
- ✅ 不影响九宫格生成流程
- ✅ 用户可以正常使用（但图片可能过期）

---

## 🐛 常见问题排查

### 问题 1：控制台显示"未登录，无法获取OSS访问凭证"

**原因**: 未登录或 accessToken 过期

**解决方案**:
1. 重新登录 Neodomain 账号
2. 检查 `localStorage.getItem('accessToken')` 是否有值

### 问题 2：OSS 上传失败，显示 403 错误

**原因**: STS 令牌权限不足或已过期

**解决方案**:
1. 检查 STS 令牌是否有效（有效期 1 小时）
2. 清除缓存重新获取令牌
3. 联系后端检查 STS 权限配置

### 问题 3：图片下载失败，显示 CORS 错误

**原因**: Neodomain 图片 URL 不允许跨域访问

**解决方案**:
1. 检查 Neodomain API 是否返回了正确的图片 URL
2. 联系 Neodomain 团队配置 CORS 白名单

---

## 📊 验证清单

测试完成后，请确认以下所有项：

- [ ] 九宫格生成成功
- [ ] 控制台显示 OSS 上传成功日志
- [ ] 图片 URL 以 `https://wlpaas.oss-cn-shanghai.aliyuncs.com/` 开头
- [ ] 应用到分镜表成功，无"保存到云端失败"错误
- [ ] 刷新页面后图片仍然可见
- [ ] 单独重新生成某一张九宫格成功
- [ ] OSS 上传失败时能降级到 Neodomain 临时 URL

---

## 🎉 测试通过标准

**所有测试用例通过 + 验证清单全部勾选 = 功能上线**

如有任何问题，请查看浏览器控制台的详细日志，或联系开发团队。


# 九宫格云端保存失败问题排查与修复

## 📋 问题描述

**错误信息**:
```
❌ 已应用到本地分镜表，但保存到云端失败，请稍后重试。
[Error] [D1存储] 保存九宫格草图映射失败:
TypeError: Load failed
```

**发生场景**: 点击"🎨 应用到分镜表"按钮时

---

## 🔍 根本原因分析

### 原因 1：数据量过大（最可能）

**问题**:
- 每个 Shot 对象包含大量字段（提示词、描述等）
- 30 个镜头的完整数据可能超过 **100KB**
- Cloudflare Workers 默认请求体限制为 **100KB**
- 超过限制时，fetch 请求会失败并抛出 `TypeError: Load failed`

**证据**:
- 错误类型是 `TypeError: Load failed`（典型的网络请求失败）
- 发生在 `patchEpisode` 调用时（传输 shots 数组）

### 原因 2：网络超时

**问题**:
- 原超时时间为 30 秒
- 数据量大时可能超时

### 原因 3：API 配置问题

**问题**:
- 线上环境的 `API_BASE_URL` 可能配置错误
- CORS 跨域问题

---

## 🛠️ 已实施的修复方案

### 修复 1：数据优化（核心修复）

**文件**: `services/d1Storage.ts`

**改动**:
1. 新增 `optimizeShotsForTransfer` 函数
2. 在保存前自动移除不必要的字段
3. 仅保留核心字段和九宫格相关字段

**优化效果**:
- 移除冗余的提示词字段（`promptCn`, `promptEn` 等）
- 预计减少 **30-50%** 的数据量
- 示例：60KB → 30KB

**保留的字段**:
```typescript
{
  // 核心字段
  id, shotNumber, duration, shotType, sceneId, videoMode,
  storyBeat, dialogue, shotSize, angleDirection, angleHeight,
  foreground, midground, background, lighting, cameraMove,
  
  // 九宫格字段（必须保留）
  storyboardGridUrl,
  storyboardGridCellIndex,
  storyboardGridGenerationMeta,
  
  // 可选字段（仅在有值时保留）
  startFrame, endFrame, theory, directorNote, technicalNote,
  assignedCharacterIds, startFrameUrl, endFrameUrl,
  imagePromptEn, videoPromptCn
}
```

### 修复 2：增加超时时间和重试次数

**改动**:
- 超时时间：30秒 → **60秒**（仅针对 shots 数据）
- 重试次数：3次 → **5次**（仅针对 shots 数据）

### 修复 3：详细的错误提示

**改动**:
- 提供更友好的错误信息
- 告知用户可能的原因和解决方案
- 引导用户查看控制台日志

---

## 📊 验证方法

### 1. 查看控制台日志

打开浏览器控制台（F12），应该看到：

```
[D1存储] 准备更新 30 个镜头
[D1存储] 数据优化: 65.23 KB → 32.45 KB (减少 50.2%)
[D1存储] 超时时间: 60000ms，重试次数: 5
```

### 2. 检查数据大小

如果优化后仍然显示：
```
[D1存储] ⚠️ 优化后数据仍然较大 (95.67 KB)，可能导致请求失败
```

**解决方案**:
- 减少镜头数量（分批保存）
- 或联系后端增加请求体大小限制

### 3. 检查网络请求

在浏览器开发者工具的 Network 标签中：
- 找到 `PATCH /api/episodes/{id}` 请求
- 查看 Request Payload 大小
- 查看 Response 状态码

---

## 🚀 测试步骤

1. **清除缓存并刷新页面**
2. **生成九宫格草图**（至少 27 个镜头，生成 3 张九宫格）
3. **点击"应用到分镜表"**
4. **观察控制台日志**：
   - 应该看到数据优化日志
   - 应该看到成功保存的日志
5. **验证结果**：
   - 应该显示"✅ 九宫格草图已应用到分镜表，并已保存到云端。"
   - 刷新页面后九宫格仍然可见

---

## ❌ 如果仍然失败

### 方案 A：分批保存

如果镜头数量特别多（>50个），可以分批保存：

```typescript
// 将 shots 分成多个批次
const BATCH_SIZE = 20;
for (let i = 0; i < updatedShots.length; i += BATCH_SIZE) {
  const batch = updatedShots.slice(i, i + BATCH_SIZE);
  await patchEpisode(currentEpisode.id, { shots: batch });
}
```

### 方案 B：检查 API 配置

**检查项**:
1. `services/d1Storage.ts` 中的 `API_BASE_URL` 是否正确
2. Cloudflare Workers 的请求体大小限制是否足够
3. CORS 配置是否正确

### 方案 C：使用压缩

如果数据量仍然过大，可以使用 gzip 压缩：

```typescript
// 在 patchEpisode 中
const compressed = pako.gzip(JSON.stringify(patch));
// 发送压缩数据
```

---

## 📝 后续优化建议

1. **完全移除提示词字段**：如果不需要在云端查看提示词，可以完全不保存
2. **使用增量更新**：只更新变化的镜头，而不是全量更新
3. **使用数据库分表**：将 shots 存储在单独的表中，而不是 JSON 字段
4. **使用 CDN**：将图片 URL 缩短（使用短链接服务）

---

## 🎉 预期效果

修复后，应该能够：
- ✅ 成功保存 30-50 个镜头的九宫格数据
- ✅ 数据量减少 30-50%
- ✅ 请求成功率提升到 95% 以上
- ✅ 即使失败也会自动重试 5 次

---

**更新时间**: 2024-12-26  
**修复版本**: v1.1.0


# 🚀 快速开始：数据迁移到 Cloudflare D1

**目标**: 将现有的 localStorage 数据迁移到云端数据库

---

## 📋 前置条件

- ✅ Cloudflare Workers API 已部署
- ✅ API 地址: https://storyboard-api.feifeixp.workers.dev
- ✅ 前端 `.env` 文件已配置

---

## 🎯 三步完成迁移

### 步骤 1：更新前端代码

在 `App.tsx` 中，将数据存储服务切换到 D1：

```typescript
// 找到这一行（约在文件顶部）
import { 
  getAllProjects, 
  saveProject, 
  deleteProject, 
  getCurrentProjectId, 
  setCurrentProjectId, 
  getProject 
} from './services/projectStorage';

// 替换为
import { 
  getAllProjects, 
  saveProject, 
  deleteProject, 
  getCurrentProjectId, 
  setCurrentProjectId, 
  getProject 
} from './services/d1Storage';
```

### 步骤 2：添加迁移工具

在项目设置页面或主页面添加迁移工具组件：

```typescript
import { DataMigrationTool } from './components/DataMigrationTool';

// 在适当的位置渲染（例如在项目列表页面）
function App() {
  return (
    <div>
      {/* 其他内容 */}
      
      {/* 添加迁移工具 */}
      <DataMigrationTool />
    </div>
  );
}
```

### 步骤 3：执行迁移

1. **启动开发服务器**:
   ```bash
   npm run dev
   ```

2. **登录应用**（如果还没有账号，会自动创建）

3. **点击"开始迁移"按钮**

4. **等待迁移完成**，你会看到：
   ```
   ✅ 迁移成功！
   
   已迁移 X 个项目到云端数据库。
   ```

5. **验证数据**：
   - 刷新页面，确认项目仍然存在
   - 在 Cloudflare Dashboard 查看数据库记录

---

## 🔍 验证迁移成功

### 方法 1：前端验证

1. 刷新浏览器页面
2. 确认所有项目都显示正常
3. 打开一个项目，确认数据完整

### 方法 2：数据库验证

```bash
cd cloudflare
./node_modules/.bin/wrangler d1 execute storyboard-db --remote --command "SELECT COUNT(*) FROM projects"
```

应该显示你迁移的项目数量。

### 方法 3：多设备验证

1. 在另一台设备或浏览器登录
2. 使用相同的手机号/邮箱
3. 确认能看到所有项目

---

## ⚠️ 注意事项

### 1. 迁移前备份

建议先导出项目到本地文件：

```typescript
import { exportProjectToFile } from './services/d1Storage';

// 导出每个项目
projects.forEach(async (project) => {
  await exportProjectToFile(project.id);
});
```

### 2. 迁移不会删除 localStorage

- 迁移后，localStorage 中的数据仍然保留
- 可以作为备份
- 如果需要，可以手动清除

### 3. 大型项目迁移

- 如果项目很大（>100个镜头），迁移可能需要几分钟
- 请保持浏览器窗口打开
- 不要刷新页面

---

## 🐛 常见问题

### Q1: 迁移失败怎么办？

**错误**: "Failed to migrate project"

**解决方案**:
1. 检查网络连接
2. 确认已登录
3. 查看浏览器控制台错误信息
4. 重试迁移

### Q2: 迁移后数据丢失？

**解决方案**:
1. 检查是否已登录正确的账号
2. 在 Cloudflare Dashboard 查看数据库
3. 从备份文件恢复：
   ```typescript
   await importProjectFromFile(backupFile);
   ```

### Q3: 如何回滚到 localStorage？

**解决方案**:
```typescript
// 在 App.tsx 中改回
import { ... } from './services/projectStorage';
```

---

## 📊 迁移进度示例

```
🔄 正在迁移...

✅ 项目 "仙侠世界观" 迁移成功
✅ 项目 "科幻短剧" 迁移成功
✅ 项目 "古风漫剧" 迁移成功

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 迁移完成！

已迁移 3 个项目到云端数据库。
```

---

## 🎉 迁移完成后

### 你现在可以：

- ✅ 在任何设备访问项目
- ✅ 多设备实时同步
- ✅ 数据自动备份到云端
- ✅ 不用担心浏览器缓存清除
- ✅ 支持团队协作（未来功能）

### 建议操作：

1. **定期导出备份**:
   ```typescript
   // 每周导出一次重要项目
   await exportProjectToFile(importantProjectId);
   ```

2. **清理旧数据**:
   ```typescript
   // 确认迁移成功后，可以清除 localStorage
   localStorage.removeItem('visionary_projects');
   ```

3. **测试多设备同步**:
   - 在手机上登录
   - 在平板上登录
   - 确认数据同步正常

---

## 📚 相关文档

- [Cloudflare D1 部署完成报告](./Cloudflare-D1-部署完成.md)
- [Cloudflare D1 集成总结](./Cloudflare-D1-集成总结.md)
- [数据存储服务 API 文档](../services/d1Storage.ts)

---

**准备好了吗？开始迁移吧！** 🚀


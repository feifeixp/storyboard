# 批量生成角色/场景设定图功能说明

**创建时间**: 2026-02-09  
**功能版本**: v1.0

---

## 📋 功能概述

在角色库和场景库的顶部添加了批量生成按钮，允许用户一键批量生成所有未生成设定图的角色和场景。

---

## 🎯 功能特性

### 1. 批量生成角色设定图

**位置**: 项目管理 → 角色库标签页 → 顶部控制栏

**功能**:
- ✅ 自动筛选所有未生成设定图的角色
- ✅ 显示待生成角色列表供用户确认
- ✅ 实时显示批量生成进度（X/Y）
- ✅ 自动间隔2秒，避免请求过快
- ✅ 生成完成后显示成功/失败统计

**使用方法**:
1. 选择"角色生图模型"
2. 选择"角色风格"
3. 点击"🎨 批量生成所有角色设定图"按钮
4. 确认待生成角色列表
5. 等待批量生成完成

---

### 2. 批量生成场景设定图

**位置**: 项目管理 → 场景库标签页 → 顶部控制栏

**功能**:
- ✅ 自动筛选所有未生成设定图的场景
- ✅ 显示待生成场景列表供用户确认
- ✅ 实时显示批量生成进度（X/Y）
- ✅ 自动间隔2秒，避免请求过快
- ✅ 生成完成后显示成功/失败统计

**使用方法**:
1. 选择"场景生图模型"
2. 选择"场景风格"
3. 点击"🎨 批量生成所有场景设定图"按钮
4. 确认待生成场景列表
5. 等待批量生成完成

---

## 🎨 UI 设计

### 角色库批量生成按钮

```
┌─────────────────────────────────────────────────────────┐
│ 角色生图模型 │ 角色风格 │ 生成内容说明 + 批量生成按钮 │
├─────────────────────────────────────────────────────────┤
│ [模型选择器] │ [风格选择器] │ 生成内容：单张 16:9...    │
│              │              │ [🎨 批量生成所有角色设定图] │
└─────────────────────────────────────────────────────────┘
```

### 场景库批量生成按钮

```
┌─────────────────────────────────────────────────────────┐
│ 场景生图模型 │ 场景风格 │ 生成内容说明 + 批量生成按钮 │
├─────────────────────────────────────────────────────────┤
│ [模型选择器] │ [风格选择器] │ 生成内容：单张 16:9...    │
│              │              │ [🎨 批量生成所有场景设定图] │
└─────────────────────────────────────────────────────────┘
```

### 生成中状态

```
[⏳ 批量生成中 (3/10)]
```

---

## 💡 使用场景

### 场景 1: 新项目初始化

**问题**: 新创建的项目有大量角色和场景需要生成设定图

**解决方案**:
1. 一次性选择好模型和风格
2. 点击批量生成按钮
3. 系统自动依次生成所有设定图

**优势**: 节省大量手动点击时间

---

### 场景 2: 补充缺失的设定图

**问题**: 部分角色/场景之前未生成设定图

**解决方案**:
1. 批量生成功能自动筛选未生成的项
2. 只生成缺失的设定图
3. 已有设定图的项自动跳过

**优势**: 智能筛选，避免重复生成

---

## ⚙️ 技术实现

### 核心函数

#### 1. `handleBatchGenerateCharacters()`

**功能**: 批量生成所有角色设定图

**流程**:
```typescript
1. 筛选未生成设定图的角色
2. 显示确认对话框
3. 循环调用 handleGenerateCharacterImageSheet()
4. 每次生成后等待2秒
5. 统计成功/失败数量
6. 显示结果
```

#### 2. `handleBatchGenerateScenes()`

**功能**: 批量生成所有场景设定图

**流程**:
```typescript
1. 筛选未生成设定图的场景
2. 显示确认对话框
3. 循环调用 handleGenerateSceneImageSheet()
4. 每次生成后等待2秒
5. 统计成功/失败数量
6. 显示结果
```

---

## 📊 状态管理

### 新增状态

```typescript
// 批量生成角色状态
const [isBatchGeneratingCharacters, setIsBatchGeneratingCharacters] = useState(false);
const [batchCharacterProgress, setBatchCharacterProgress] = useState<{ current: number; total: number } | null>(null);

// 批量生成场景状态
const [isBatchGeneratingScenes, setIsBatchGeneratingScenes] = useState(false);
const [batchSceneProgress, setBatchSceneProgress] = useState<{ current: number; total: number } | null>(null);
```

---

## 🔍 错误处理

### 1. 未选择模型

```
❌ 请先选择生图模型
```

### 2. 所有项已生成

```
✅ 所有角色都已有设定图！
```

### 3. 生成失败

```
批量生成完成！

✅ 成功: 8 个
❌ 失败: 2 个

失败的角色：
• 张三
• 李四
```

---

## 📝 修改的文件

- `components/ProjectDashboard.tsx` - 添加批量生成功能

**修改内容**:
1. 添加批量生成状态管理
2. 实现 `handleBatchGenerateCharacters()` 函数
3. 实现 `handleBatchGenerateScenes()` 函数
4. 在角色库UI添加批量生成按钮
5. 在场景库UI添加批量生成按钮
6. 将批量生成相关props传递给 ScenesTab 组件

---

## 🎉 总结

**新增功能**:
- ✅ 批量生成所有角色设定图
- ✅ 批量生成所有场景设定图
- ✅ 实时进度显示
- ✅ 智能筛选未生成项
- ✅ 详细的结果统计

**用户体验提升**:
- 🚀 大幅减少手动操作时间
- 📊 清晰的进度反馈
- 🎯 智能筛选，避免重复
- 💡 友好的错误提示

---

**创建时间**: 2026-02-09  
**维护人**: AI Assistant


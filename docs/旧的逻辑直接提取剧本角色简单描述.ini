








我先做一轮“只读排查”：用 `codebase-retrieval` 把“项目创建时角色外观从哪里生成/保存”链路定位出来，同时用 grep（PowerShell `Select-String`）把所有相关引用一次性搜全，确认到底是哪段“旧逻辑”在生效。







## 核心原因（已定位，确实是“旧逻辑在生效”）

你判断得对：**项目创建阶段就把“从剧本提取出来的外观”写进了 `project.characters[].appearance`**，导致后续 CoT 自动补充的判断条件被满足，于是直接跳过，日志才会一直出现：

- `[自动补充] 所有主要角色都已有完整描述`

关键链路是：

1) **`services/projectAnalysis.ts`** 在项目分析提示词里明确要求 LLM 输出 `characters[].appearance`（三段式标记），并在归一化时把它写进 `CharacterRef.appearance`  
2) **`components/ProjectWizard.tsx`** 创建项目时直接把 `project.characters`（已经带了 `appearance`）传给 `autoSupplementMainCharacters`  
3) **`characterSupplement/identifyMainCharacters.ts::needsSupplement()`** 只要 `appearance` 里有结构化标记且长度够，就认为“已完整”→ **不触发 CoT** → 你看到的就是“剧本简单提取版”

下面三段代码能直接证明这一点（均为当前仓库逻辑）：

````ts path=storyboard/services/projectAnalysis.ts mode=EXCERPT
- **外观描述（appearance）**：⚠️ **必须使用三段式标记格式**...
  - ✅ 必须使用：【主体人物】【外貌特征】【服饰造型】
...
return {
  ...
  appearance: c.appearance || '',
}
````

````tsx path=storyboard/components/ProjectWizard.tsx mode=EXCERPT
const updatedCharacters = await autoSupplementMainCharacters(
  project.characters || [],
  scripts,
  { ... }
);
project.characters = updatedCharacters;
````

````ts path=storyboard/services/characterSupplement/identifyMainCharacters.ts mode=EXCERPT
export function needsSupplement(char: CharacterRef): boolean {
  if (!hasStructuredAppearance(char?.appearance)) return true;
  if (!hasStructuredCostume(char?.appearance)) return true;
  return false;
}
````

---

## 额外发现：确实还有一套“从剧本提取角色外观”的旧功能

在 **`services/openrouter.ts`** 还存在 `extractCharactersFromScript()`，并在 **`App.tsx`** 里被用于“智能提取/回退到AI提取新角色”。  
但这条链路更多影响“单集角色提取”，**不一定是你当前项目创建/主要角色补全这条链路的直接原因**。当前你卡住的核心，还是 `projectAnalysis → appearance 预填充 → needsSupplement 跳过`。

---

## 修复方向（先给你选择，确认后我再改代码）

### 方案 A（推荐，最小改动，立刻让 CoT 生效）
**改 `ProjectWizard.tsx`**：在调用 `autoSupplementMainCharacters()` 前，**对“将要补全的主要角色”临时清空 `appearance`**（只清空 mainChars，其他角色不动），让 `needsSupplement()` 必然返回 true，从而强制走 CoT 生成；CoT 完成后再写回项目。

- **优点**：不改类型、不动存储结构；见效最快；风险低（发生在“新建项目”流程，用户还没手工编辑外观）
- **影响**：自动补全会比现在更“必然触发”，意味着会产生 LLM 调用（但这是你想要的）
- **风险**：几乎无（仅在创建阶段清空草稿外观）

### 方案 B（更彻底，减少成本与歧义）
**改 `projectAnalysis.ts`**：让项目分析阶段**不再生成/写入 `characters[].appearance`**（或只写入一个明确标记为“草稿/剧本提取”的字段），把“角色外观/服装”完全交给 `characterSupplement(CoT)`。

- **优点**：从源头移除旧逻辑，token 更省，也不会再出现“分析阶段的外观误判为完整”
- **影响范围更大**：涉及 prompt/schema/归一化/可能还要考虑 UI 展示默认值

---

## 我建议的执行顺序（更稳）
1) 先做 **方案 A**：保证 CoT 立刻生效（你能马上验证“主要角色不再是简单提取”）  
2) 你确认效果后，再决定是否做 **方案 B** 来“彻底移除旧逻辑/降本”

---

## 修改清单（等你确认后才会动手）
### 需要修改的文件
1. `storyboard/components/ProjectWizard.tsx`
   - 在调用 `autoSupplementMainCharacters` 前：
     - 复用现有 `mainChars` 结果，构造 `charactersForSupplement`
     - 对 `mainChars` 中的角色：`appearance` 置空（或置为明确占位符）
   - 调用补全时改为传 `charactersForSupplement`
2. （可选）`storyboard/services/projectAnalysis.ts`（仅当你选方案 B）
   - 调整 prompt：不再要求输出 `appearance`（或输出到其它字段）
   - `normalizeAnalysisResult()`：不再写入 `appearance`

### 验证步骤（改完我会按这个跑/你也可复现）
1) 删除项目 → 新建项目  
2) 控制台应出现：`[自动补充] 将补充 X 个主要角色`（不再是“所有主要角色都已有完整描述”）  
3) 补全完成后打开角色详情：  
   - `appearance` 必须包含 `【主体人物】【外貌特征】【服饰造型】`
   - 描述显著更“设计化/完整”，而不是剧本原句拼接

---

## 需要你确认的点（我不猜）
你希望我先实施哪一种？
- 回复 **“先做方案A”**（推荐，最快看到效果）
- 或回复 **“直接做方案B（彻底移除旧逻辑）”**
- 或两者都做（我会先 A 后 B，分两步提交修改）

# 角色设定图布局和多形态支持升级计划

**创建时间**: 2026-02-09  
**状态**: 规划中

---

## 📋 需求概述

### 1. 布局变更
- **当前**: 2×2 grid layout (4个面板，2行2列)
- **目标**: 1×4 horizontal grid layout (4个面板，1行4列)
- **面板顺序**: 从左到右
  1. 正面全身 (front full-body standing)
  2. 侧面全身 (side profile full-body)
  3. 背面全身 (back full-body)
  4. 面部特写 (face close-up portrait)

### 2. 多形态支持
- **需求**: 如果角色有多个子形象（forms），需要为每个形态生成单独的设定图
- **示例**: 角色"晋安"有12种形态（高中校服→焚衣半裸→类人尖兵→神性素体...）
- **实现**: 
  - 主形态生成1张设定图
  - 每个子形态生成1张设定图
  - 总计: 1 + forms.length 张设定图

---

## 🔧 技术实现

### 步骤 1: 更新数据结构 ✅

**文件**: `types.ts`

**修改内容**:
```typescript
export interface CharacterForm {
  id: string;
  name: string;
  episodeRange?: string;
  description: string;
  note?: string;
  visualPromptCn?: string;
  visualPromptEn?: string;
  
  // 🆕 形态设定图（1×4 横向四分屏）
  imageSheetUrl?: string;
  
  // 🆕 生图元信息
  imageGenerationMeta?: {
    modelName: string;
    styleName: string;
    generatedAt: string;
    taskCode?: string;
    taskCreatedAt?: string;
  };
}
```

**状态**: ✅ 已完成

---

### 步骤 2: 修改生成提示词

**文件**: `components/ProjectDashboard.tsx`

**当前提示词**:
```
'16:9 canvas, 2x2 grid layout with 4 equal panels, edge-to-edge, clean background, consistent character, consistent outfit, consistent face.',
'Panels: (1) front full-body standing, (2) side profile full-body, (3) back full-body, (4) face close-up portrait.',
```

**目标提示词**:
```
'16:9 canvas, 1x4 horizontal grid layout with 4 equal panels, edge-to-edge, clean background, consistent character, consistent outfit, consistent face.',
'Panels from left to right: (1) front full-body standing, (2) side profile full-body, (3) back full-body, (4) face close-up portrait.',
```

**状态**: ✅ 已完成

---

### 步骤 3: 实现多形态生成逻辑

**文件**: `components/ProjectDashboard.tsx`

**函数签名变更**:
```typescript
// 旧版本
const handleGenerateCharacterImageSheet = async (characterId: string) => { ... }

// 新版本
const handleGenerateCharacterImageSheet = async (characterId: string, formId?: string) => { ... }
```

**生成逻辑**:
1. 如果未指定 `formId` 且角色有 `forms`：
   - 先生成主形态设定图
   - 依次生成每个子形态设定图（间隔2秒）
   - 显示总进度

2. 如果指定了 `formId`：
   - 只生成该形态的设定图

**状态**: 🔄 进行中

---

### 步骤 4: 更新保存逻辑

**保存位置**:
- **主形态**: `character.imageSheetUrl`
- **子形态**: `character.forms[i].imageSheetUrl`

**文件命名**:
- **主形态**: `character_sheet_{characterId}`
- **子形态**: `character_sheet_{characterId}_form_{formId}`

**状态**: ⏳ 待实现

---

### 步骤 5: 更新UI显示

**需要修改的组件**:
1. `CharacterCard` - 显示主形态设定图
2. `CharacterCard` (展开状态) - 显示所有形态的设定图
3. 生成按钮 - 支持为单个形态生成

**UI设计**:
```
┌─────────────────────────────────────────────────────────┐
│ 角色名称                                    [生成所有形态] │
├─────────────────────────────────────────────────────────┤
│ 主形态设定图                                [🖼️ 生成]    │
│ [1×4 横向布局图片]                                       │
├─────────────────────────────────────────────────────────┤
│ 形态1: 高中校服                             [🖼️ 生成]    │
│ [1×4 横向布局图片]                                       │
├─────────────────────────────────────────────────────────┤
│ 形态2: 类人尖兵                             [🖼️ 生成]    │
│ [1×4 横向布局图片]                                       │
└─────────────────────────────────────────────────────────┘
```

**状态**: ⏳ 待实现

---

## 📝 实现步骤总结

- [x] 步骤 1: 更新 `CharacterForm` 数据结构
- [x] 步骤 2: 修改生成提示词（2×2 → 1×4）
- [ ] 步骤 3: 实现多形态生成逻辑
- [ ] 步骤 4: 更新保存逻辑（支持 form.imageSheetUrl）
- [ ] 步骤 5: 更新UI显示（显示所有形态的设定图）
- [ ] 步骤 6: 测试功能
- [ ] 步骤 7: 更新文档

---

## 🧪 测试计划

### 测试用例 1: 单形态角色
- 创建一个没有 forms 的角色
- 生成设定图
- 验证布局为 1×4 横向
- 验证图片保存到 `character.imageSheetUrl`

### 测试用例 2: 多形态角色
- 创建一个有 3 个 forms 的角色
- 点击"生成所有形态"
- 验证生成 4 张设定图（1主 + 3子）
- 验证每张图片布局为 1×4 横向
- 验证图片分别保存到正确位置

### 测试用例 3: 单独生成某个形态
- 为某个 form 单独生成设定图
- 验证只生成该形态的设定图
- 验证不影响其他形态

---

## 📚 相关文档

- `types.ts` - 数据结构定义
- `components/ProjectDashboard.tsx` - 角色设定图生成逻辑
- `docs/批量生成角色场景设定图功能说明.md` - 批量生成功能说明

---

**创建时间**: 2026-02-09  
**维护人**: AI Assistant


/**
 * 阶段1：剧本理解与分析
 * 思维链提示词
 */

export const STAGE1_SCRIPT_ANALYSIS_PROMPT = `
# 任务：剧本深度分析与预处理

你是一位资深电影分镜师，正在分析一个剧本。请按照以下步骤逐步推理，**必须展示每一步的思考过程**。

---

## 🧹 预处理：剧本清洗（在分析前执行）

在正式分析前，先对剧本进行"清洗"，区分画面信息和非画面信息：

### 信息分类
| 类型 | 处理方式 |
|-----|---------|
| 角色动作 / 场景描述 / 对白 / 字幕UI | ✅ 核心画面内容，保留 |
| **音效 / BGM** | ⚠️ 仅作情绪参考，不画面化 |
| **时间码**（如 8-18s） | ❌ 忽略 |
| **镜头建议** | ⚠️ 仅作参考 |

### 提取剧本设定约束
识别剧本中的"规则/设定"，后续分镜不可违反：
- 如"无物理杀伤力" → 禁止画物体破碎
- 如"虚拟空间" → 可以有数字化视觉效果

---

## 推理步骤

### Step 1.1: 通读剧本，提取关键信息

**思考过程**（必须输出）：
请回答以下问题：
- 这个故事发生在哪里？（地点）
- 涉及哪些角色？（人物）
- 时间跨度是多久？（时长）
- 主要动作有哪些？（事件）

**输出格式**：
\`\`\`json
{
  "location": "...",
  "characters": [...],
  "timespan": "...",
  "keyEvents": [...]
}
\`\`\`

---

### Step 1.2: 识别情绪转折点

**思考过程**（必须输出）：
请分析：
- 故事的情绪是如何变化的？
- 哪些时刻是情绪的转折点？
- 高潮在哪里？
- 情绪强度如何量化（1-10分）？

**输出格式**：
\`\`\`json
{
  "emotionArc": [
    {"event": "...", "emotion": "...", "intensity": 3},
    {"event": "...", "emotion": "...", "intensity": 5}
  ],
  "climax": "..."
}
\`\`\`

---

### Step 1.3: 确定核心冲突

**思考过程**（必须输出）：
请分析：
- 主角面临的主要矛盾是什么？
- 这是哪种类型的冲突？（角色vs角色/环境/内心/社会）
- 这个冲突如何推动故事？
- 冲突如何解决（或未解决）？

**输出格式**：
\`\`\`json
{
  "type": "角色 vs 环境",
  "description": "...",
  "resolution": "..."
}
\`\`\`

---

### Step 1.4: 划分场景段落

**思考过程**（必须输出）：
请分析：
- 故事可以分为几个自然段落？
- 每个段落的核心是什么？
- 每个段落的时长大约多久？
- 每个段落的情绪基调是什么？

**输出格式**：
\`\`\`json
{
  "scenes": [
    {
      "id": "S1",
      "description": "...",
      "duration": "30s",
      "mood": "..."
    }
  ]
}
\`\`\`

---

### Step 1.5: 剧本清洗与设定提取

**思考过程**（必须输出）：
请分析：
- 剧本中有哪些"音效/BGM"描述？这些只作为情绪参考，不应画面化
- 剧本中有哪些"时间码"（如8-18s）？这些应该忽略
- 剧本中有哪些"镜头建议"（如镜头：中景→特写）？这些只作参考
- 剧本中有哪些**设定约束**？（如"无物理杀伤力"）这些必须遵守

**输出格式**：
\`\`\`json
{
  "scriptCleaning": {
    "audioEffects": ["音效描述1", "音效描述2"],
    "musicCues": ["BGM描述1"],
    "timeCodes": ["(8-18s)"],
    "cameraSuggestions": ["镜头：中景→特写"],
    "constraints": [
      {"rule": "无物理杀伤力", "implication": "波纹不能破坏物体"}
    ]
  }
}
\`\`\`

---

### Step 1.6: 剧情连续性与空间设定补全建议（供后续“加戏”参考）

**思考过程**（必须输出）：
请在**不改写原始剧本文本**的前提下，分析：
- 哪些地方存在**剧情/信息缺口**？例如：
  - 场景A结束在树林，场景B直接到达祭坛，中间缺少到达过程
  - 某个关键物品突然出现在角色手中，但之前没有交代拿取动作
  - 人物/物体的**空间相对位置**不够清楚，可能导致后续“瞬移感”
- 对于每个缺口，可以用哪些**安全的视觉补充**（环境反应、角色反应、UI/提示、氛围渲染）来弥补？
  - 这些补充**不能新增对白**、不能改变剧情结果，只是让过程更顺畅
- 为每个场景勾勒一个**简要空间布局**（只为分镜服务的“隐形设定”）：
  - 关键地标在哪里（树、石台、门、悬崖、控制台等）？
  - 主要角色在该场景的**默认站位**如何？
  - 是否存在只在画面中体现、不写回剧本文字的空间设定？

⚠️ **重要约束**：sceneLayouts 与 Step 1.4 场景 **一一对应**，每个场景独立一条（禁止 "S1-S6" 合并写法）。

**输出格式**：
\`\`\`json
{
  "continuityNotes": {
    "gaps": [
      {
        "id": "G1",
        "type": "plotGap",
        "relatedScenes": ["S1", "S2"],
        "description": "S1 结束时角色还在树林，S2 直接来到祭坛，缺少到达过程",
        "safeExpansionIdeas": ["增加角色穿过树林接近祭坛的奔跑镜头"]
      }
    ],
    "sceneLayouts": [
      {
        "sceneId": "S1",
        "spatialSummary": "林间空地左侧是古树，右侧是石台，远处是悬崖边",
        "landmarks": ["古树", "石台", "悬崖边"],
        "defaultPositions": {"晋安": "靠近古树一侧，面向石台", "林溪": "靠近石台，背对悬崖"},
        "hiddenSettings": "古树后有一条通往悬崖的小径"
      }
    ]
  }
}
\`\`\`

---

## 执行指令

**现在，请对以下剧本执行 Step 1.1 - 1.6 的推理过程。**

**重要要求**：
1. ✅ **必须展示每一步的思考过程**（用自然语言描述你的推理）
2. ✅ **必须按顺序执行**（1.1 → 1.2 → 1.3 → 1.4 → 1.5 → 1.6，不能跳步）
3. ✅ **必须输出结构化结果**（使用 JSON 格式）
4. ❌ **禁止直接给答案**（必须先思考，再输出）
5. ⚠️ **Step 1.5的约束**在后续分镜生成中必须遵守
6. ⚠️ **Step 1.6 只给出“分镜用的安全加戏建议和隐形设定”**，不得改写或删除原始剧本文字

---

## 剧本

{{SCRIPT}}

---

【最终输出格式】

完成 Step 1.1 - 1.6 所有推理步骤后，**必须**将所有结果合并为一个完整的 JSON 对象输出（用 \`\`\`json 代码块包裹）：

\`\`\`json
{
  "basicInfo": {"location": "...", "characters": [...], "timespan": "...", "keyEvents": [...]},
  "emotionArc": [{"event": "...", "emotion": "...", "intensity": 5}],
  "climax": "...",
  "conflict": {"type": "...", "description": "...", "resolution": "..."},
  "scenes": [{"id": "S1", "description": "...", "duration": "30s", "mood": "..."}],
  "scriptCleaning": {
    "audioEffects": [...],
    "musicCues": [...],
    "timeCodes": [...],
    "cameraSuggestions": [...],
    "constraints": [{"rule": "...", "implication": "..."}]
  },
  "continuityNotes": {
    "gaps": [...],
    "sceneLayouts": [{"sceneId": "S1", "spatialSummary": "...", "landmarks": [...], "defaultPositions": {}, "hiddenSettings": "..."}]
  }
}
\`\`\`

---

**现在开始执行！**
`;

/**
 * 替换剧本占位符
 */
export function buildStage1Prompt(script: string): string {
  return STAGE1_SCRIPT_ANALYSIS_PROMPT.replace('{{SCRIPT}}', script);
}


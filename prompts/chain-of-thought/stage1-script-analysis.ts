/**
 * 阶段1：剧本理解与分析
 * 思维链提示词
 */

export const STAGE1_SCRIPT_ANALYSIS_PROMPT = `
# 任务：剧本深度分析与预处理

你是一位资深电影分镜师，正在分析一个剧本。请按照以下步骤逐步推理，**必须展示每一步的思考过程**。

---

## 🧹 预处理：剧本清洗（在分析前执行）

在正式分析前，先对剧本进行"清洗"，区分画面信息和非画面信息：

### 信息分类
| 类型 | 处理方式 | 举例 |
|-----|---------|------|
| 角色动作 | ✅ 核心画面内容 | "晋安双手合十" |
| 场景描述 | ✅ 核心画面内容 | "波纹扩散" |
| 对白 | ✅ 保留 | "抓到你了……" |
| 字幕/UI | ✅ 画内元素 | "[警告：核心温度 300%]" |
| **音效** | ⚠️ 情绪参考，不画面化 | "音效：滋滋声" → 紧张氛围 |
| **BGM** | ⚠️ 情绪参考，不画面化 | "BGM：紧张音" → 恐惧氛围 |
| **时间码** | ❌ 忽略 | "(8–18s)" |
| **镜头建议** | ⚠️ 仅作参考 | "镜头：中景→特写" |

### 提取剧本设定约束
识别剧本中的"规则/设定"，后续分镜不可违反：
- 如"无物理杀伤力" → 禁止画物体破碎
- 如"虚拟空间" → 可以有数字化视觉效果

---

## 推理步骤

### Step 1.1: 通读剧本，提取关键信息

**思考过程**（必须输出）：
请回答以下问题：
- 这个故事发生在哪里？（地点）
- 涉及哪些角色？（人物）
- 时间跨度是多久？（时长）
- 主要动作有哪些？（事件）

**输出格式**：
\`\`\`json
{
  "location": "...",
  "characters": [...],
  "timespan": "...",
  "keyEvents": [...]
}
\`\`\`

---

### Step 1.2: 识别情绪转折点

**思考过程**（必须输出）：
请分析：
- 故事的情绪是如何变化的？
- 哪些时刻是情绪的转折点？
- 高潮在哪里？
- 情绪强度如何量化（1-10分）？

**输出格式**：
\`\`\`json
{
  "emotionArc": [
    {"event": "...", "emotion": "...", "intensity": 3},
    {"event": "...", "emotion": "...", "intensity": 5}
  ],
  "climax": "..."
}
\`\`\`

---

### Step 1.3: 确定核心冲突

**思考过程**（必须输出）：
请分析：
- 主角面临的主要矛盾是什么？
- 这是哪种类型的冲突？（角色vs角色/环境/内心/社会）
- 这个冲突如何推动故事？
- 冲突如何解决（或未解决）？

**输出格式**：
\`\`\`json
{
  "type": "角色 vs 环境",
  "description": "...",
  "resolution": "..."
}
\`\`\`

---

### Step 1.4: 划分场景段落

**思考过程**（必须输出）：
请分析：
- 故事可以分为几个自然段落？
- 每个段落的核心是什么？
- 每个段落的时长大约多久？
- 每个段落的情绪基调是什么？

**输出格式**：
\`\`\`json
{
  "scenes": [
    {
      "id": "S1",
      "description": "...",
      "duration": "30s",
      "mood": "..."
    }
  ]
}
\`\`\`

---

### Step 1.5: 剧本清洗与设定提取

**思考过程**（必须输出）：
请分析：
- 剧本中有哪些"音效/BGM"描述？这些只作为情绪参考，不应画面化
- 剧本中有哪些"时间码"（如8-18s）？这些应该忽略
- 剧本中有哪些"镜头建议"（如镜头：中景→特写）？这些只作参考
- 剧本中有哪些**设定约束**？（如"无物理杀伤力"）这些必须遵守

**输出格式**：
\`\`\`json
{
  "scriptCleaning": {
    "audioEffects": ["音效描述1", "音效描述2"],
    "musicCues": ["BGM描述1"],
    "timeCodes": ["(8-18s)"],
    "cameraSuggestions": ["镜头：中景→特写"],
    "constraints": [
      {"rule": "无物理杀伤力", "implication": "波纹不能破坏物体"}
    ]
  }
}
\`\`\`

---

### Step 1.6: 剧情连续性与空间设定补全建议（供后续“加戏”参考）

**思考过程**（必须输出）：
请在**不改写原始剧本文本**的前提下，分析：
- 哪些地方存在**剧情/信息缺口**？例如：
  - 场景A结束在树林，场景B直接到达祭坛，中间缺少到达过程
  - 某个关键物品突然出现在角色手中，但之前没有交代拿取动作
  - 人物/物体的**空间相对位置**不够清楚，可能导致后续“瞬移感”
- 对于每个缺口，可以用哪些**安全的视觉补充**（环境反应、角色反应、UI/提示、氛围渲染）来弥补？
  - 这些补充**不能新增对白**、不能改变剧情结果，只是让过程更顺畅
- 为每个场景勾勒一个**简要空间布局**（只为分镜服务的“隐形设定”）：
  - 关键地标在哪里（树、石台、门、悬崖、控制台等）？
  - 主要角色在该场景的**默认站位**如何？
  - 是否存在只在画面中体现、不写回剧本文字的空间设定？

⚠️ **重要约束**：
- sceneLayouts 中的每个条目必须与 Step 1.4 中划分的场景 **一一对应**
- 如果 Step 1.4 划分了 4 个场景（S1, S2, S3, S4），则 sceneLayouts 也必须有 4 个条目
- **禁止**使用 "S1-S6" 这种合并写法，每个场景必须独立描述
- 即使多个场景在同一物理地点，也要分开描述（因为角色站位可能不同）

**输出格式**：
\`\`\`json
{
  "continuityNotes": {
    "gaps": [
      {
        "id": "G1",
        "type": "plotGap", // 或 "objectUnclear" / "spaceUnclear"
        "relatedScenes": ["S1", "S2"],
        "description": "S1 结束时角色还在树林，S2 直接来到祭坛，缺少到达过程",
        "safeExpansionIdeas": [
          "增加角色穿过树林接近祭坛的奔跑镜头",
          "利用反复出现的古树和石像作为空间锚点"
        ]
      }
    ],
    "sceneLayouts": [
      {
        "sceneId": "S1",  // ⚠️ 必须是单个场景ID，禁止 "S1-S3" 合并写法
        "spatialSummary": "林间空地左侧是古树，右侧是石台，远处是悬崖边",
        "landmarks": ["古树", "石台", "悬崖边"],
        "defaultPositions": {
          "晋安": "靠近古树一侧，面向石台",
          "林溪": "靠近石台，背对悬崖"
        },
        "hiddenSettings": "古树后有一条通往悬崖的小径"
      },
      {
        "sceneId": "S2",  // 每个场景独立一个条目
        "spatialSummary": "祭坛广场中央有石台，四周是断壁残垣",
        "landmarks": ["石台", "断壁", "祭坛火盆"],
        "defaultPositions": {
          "晋安": "站在石台前方，面向祭坛",
          "林溪": "站在晋安身后两步"
        },
        "hiddenSettings": ""
      }
      // ... 必须与 Step 1.4 中的 scenes 数量一一对应
    ]
  }
}
\`\`\`

---

## 执行指令

**现在，请对以下剧本执行 Step 1.1 - 1.6 的推理过程。**

**重要要求**：
1. ✅ **必须展示每一步的思考过程**（用自然语言描述你的推理）
2. ✅ **必须按顺序执行**（1.1 → 1.2 → 1.3 → 1.4 → 1.5 → 1.6，不能跳步）
3. ✅ **必须输出结构化结果**（使用 JSON 格式）
4. ❌ **禁止直接给答案**（必须先思考，再输出）
5. ⚠️ **Step 1.5的约束**在后续分镜生成中必须遵守
6. ⚠️ **Step 1.6 只给出“分镜用的安全加戏建议和隐形设定”**，不得改写或删除原始剧本文字

---

## 剧本

{{SCRIPT}}

---

## 输出格式示例

请严格按照以下格式输出：

\`\`\`
【Step 1.1 执行中】

思考过程：
我先通读剧本...
- 地点：我注意到故事开始在森林小径，后来进入地下洞穴
- 角色：主要是小女孩，还有萤火虫群作为引导元素
- 时间：从黄昏（还有光线）到夜晚（洞穴中漆黑），大约10分钟
- 关键动作：发现虫群 → 追逐 → 跌落 → 探索遗迹

输出结果：
\`\`\`json
{
  "location": "森林小径 → 地下洞穴",
  "characters": ["小女孩", "萤火虫群"],
  "timespan": "黄昏到夜晚，约10分钟",
  "keyEvents": [
    "小女孩发现发光虫群",
    "追逐虫群",
    "跌入洞穴",
    "发现古老遗迹"
  ]
}
\`\`\`

---

【Step 1.2 执行中】

思考过程：
现在分析情绪变化...
- 开始是好奇（发现新事物），强度约3分
- 然后是兴奋（追逐的乐趣），强度上升到5分
- 突然转为恐惧（失足跌落），强度急升到8分
- 最后是震撼（发现遗迹），强度达到9分
情绪曲线呈现"上升 → 急降 → 再上升"的过山车式变化。
高潮应该是"跌入洞穴"这一刻，因为这是情绪最剧烈的转折点。

输出结果：
\`\`\`json
{
  "emotionArc": [
    {"event": "发现虫群", "emotion": "好奇", "intensity": 3},
    {"event": "追逐虫群", "emotion": "兴奋", "intensity": 5},
    {"event": "跌入洞穴", "emotion": "恐惧", "intensity": 8},
    {"event": "发现遗迹", "emotion": "震撼", "intensity": 9}
  ],
  "climax": "跌入洞穴"
}
\`\`\`

---

【Step 1.3 执行中】

思考过程：
[你的思考...]

输出结果：
\`\`\`json
{...}
\`\`\`

---

【Step 1.4 执行中】

思考过程：
[你的思考...]

输出结果：
\`\`\`json
{...}
\`\`\`

---

【最终输出】

请将所有结果合并为一个完整的 JSON 对象：

\`\`\`json
{
  "basicInfo": {...},
  "emotionArc": [...],
  "climax": "...",
  "conflict": {...},
  "scenes": [...],
  "scriptCleaning": {
    "audioEffects": [...],
    "musicCues": [...],
    "timeCodes": [...],
    "cameraSuggestions": [...],
    "constraints": [...]
  },
  "continuityNotes": {
    "gaps": [...],
    "sceneLayouts": [...]
  },
  "thinking": {
    "step1_1": "我先通读剧本...",
    "step1_2": "现在分析情绪变化...",
    "step1_3": "...",
    "step1_4": "...",
    "step1_5": "...",
    "step1_6": "..."
  }
}
\`\`\`
\`\`\`

---

**现在开始执行！**
`;

/**
 * 替换剧本占位符
 */
export function buildStage1Prompt(script: string): string {
  return STAGE1_SCRIPT_ANALYSIS_PROMPT.replace('{{SCRIPT}}', script);
}


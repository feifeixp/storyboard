/**
 * 阶段3：镜头分配计划
 *
 * 输入：原始剧本 + 阶段1剧本分析 + 阶段2视觉策略
 * 输出：详细的镜头分配方案（严格按照剧本内容）
 *
 * ⚠️ 角度规则依据：.augment/rules/角度规则优化总结.ini
 * 核心规则：
 * - 正面镜头占比 ≤7%（30个镜头最多2个）
 * - 平视镜头占比 10-15%（禁止连续2个以上）
 * - 默认选择：轻微仰拍/轻微俯拍（40-50%）
 * - 极端角度占比 ≥15%
 */

import type { ScriptAnalysis, VisualStrategy } from './types';

export function buildStage3Prompt(
  originalScript: string,
  stage1: ScriptAnalysis,
  stage2: VisualStrategy
): string {
  // 🚨 基于情绪节奏计算镜头数，而非机械的"段落×3"
  // 从Stage 2的emotionDrivenAllocation获取建议镜头数
  const emotionAllocation = stage2.rhythmControl?.emotionDrivenAllocation || [];
  const emotionBasedTotal = emotionAllocation.reduce((sum, scene) =>
    sum + (scene.suggestedShotCount || 3), 0);

  // 如果Stage 2没有提供，则使用基于情绪强度的估算
  const scenes = stage1.scenes || [];
  const emotionArc = stage1.emotionArc || [];

  // 根据情绪强度估算每个场景的镜头数
  const estimatedByEmotion = scenes.reduce((sum, scene) => {
    // 找到该场景对应的情绪强度
    const matchedEmotion = emotionArc.find(e =>
      scene.description?.includes(e.event) || e.event?.includes(scene.id || '')
    );
    const intensity = matchedEmotion?.intensity || 5;

    // 情绪驱动的镜头分配：
    // 强度8-10：5个镜头（高潮/转折）
    // 强度5-7：3个镜头（发展/对抗）
    // 强度1-4：2个镜头（铺垫/抒情）
    if (intensity >= 8) return sum + 5;
    if (intensity >= 5) return sum + 3;
    return sum + 2;
  }, 0);

  // 使用情绪驱动的值，或Stage 2建议的值
  const minimumShots = Math.max(emotionBasedTotal, estimatedByEmotion, 22);
  const recommendedShots = Math.round(minimumShots * 1.15);

  // 基于 Stage 1.6 的 sceneLayouts，提炼空间锚点摘要
  const sceneLayouts = stage1.continuityNotes?.sceneLayouts || [];
  const sceneLayoutSummary = sceneLayouts.length
    ? sceneLayouts
        .map((layout) => {
          const landmarks = (layout.landmarks || []).join('、') || '（未指定地标）';
          const defaultPositionsEntries = Object.entries(layout.defaultPositions || {});
          const defaultPositionsStr = defaultPositionsEntries.length
            ? defaultPositionsEntries
                .map(([name, pos]) => `${name}：${pos}`)
                .join('；')
            : '（未指定默认站位）';
          const hidden = layout.hiddenSettings
            ? `\n  - 隐藏设定：${layout.hiddenSettings}`
            : '';
          return `- 场景 ${layout.sceneId}：${layout.spatialSummary}\n  - 地标：${landmarks}\n  - 默认站位：${defaultPositionsStr}${hidden}`;
        })
        .join('\n')
    : '（当前剧本未提供 sceneLayouts；如无空间锚点信息，请依然保证同一场景内角色与地标的相对关系在不同镜头之间保持一致，避免“瞬移感”。）';

  return `# 阶段3：镜头分配计划

你是一位资深电影分镜师，精通《Framed Ink》系列理论。
现在你需要根据**原始剧本**、剧本分析和视觉策略，制定详细的镜头分配计划。

---

## 🚨🚨🚨 情绪节奏驱动的镜头分配（核心原则） 🚨🚨🚨

**⚠️ 镜头分配不是机械的"段落×3"，而是根据情绪强度动态分配！**

参考《分镜脚本设计新手手册》第八章：
| 情绪强度 | 节奏类型 | 镜头密度 | 每镜时长 | 示例场景 |
|---------|---------|---------|---------|---------|
| **8-10分** | 快节奏 | **4-6个/段落** | 2-3秒 | 打斗、追逐、情绪爆发、高潮 |
| **5-7分** | 中节奏 | **3-4个/段落** | 3-4秒 | 对话、对抗、信息传递 |
| **1-4分** | 慢节奏 | **1-2个/段落** | 5-8秒 | 铺垫、环境建立、抒情沉思 |

### 本次任务镜头目标（基于Stage 2情绪分析）
| 参数 | 数值 |
|-----|------|
| 最少镜头数（基于情绪节奏计算） | **${minimumShots}个** |
| 推荐镜头数 | **${recommendedShots}个** |

### 镜头分配原则
- ✅ **高潮段落**（情绪8-10）：多镜头快速剪辑，每段4-6个镜头
- ✅ **发展段落**（情绪5-7）：中等密度，每段3-4个镜头
- ✅ **铺垫段落**（情绪1-4）：稀疏镜头，每段1-2个镜头
- ❌ 禁止：所有段落都用相同的镜头密度！
- ❌ 禁止：shotList.length < ${minimumShots}

### 如何增加镜头（按优先级）
1. **桥接缺口**：两段之间的因果关系镜头（如"拔剑后→持剑指向"）
2. **环境反应**：波纹扫过石柱、天空变色
3. **角色反应**：配角惊恐、群众骚动
4. **动作拆分**：「准备→动作→效果」三步
5. **UI特写**：警告弹窗、错误代码

---

## 🎬 原始剧本（必须严格遵循）

\`\`\`
${originalScript}
\`\`\`

---

## ⚠️⚠️⚠️ 剧本内容约束

**你必须严格按照原始剧本的内容来设计镜头！**

1. **不能自由发挥**：每个镜头的内容必须来自剧本，不能添加剧本没有的情节
2. **不能跳过内容**：剧本中的每一句对话、每一个动作都必须有镜头来表现
3. **对话必须保留**：剧本中的所有对话都需要在镜头描述中体现
4. **按顺序设计**：镜头顺序必须与剧本叙事顺序一致

---

## 🧹 剧本预处理规则

### 非画面信息处理
| 类型 | 处理方式 |
|-----|---------|
| **音效** | ⚠️ 只作情绪参考，不画面化。如"音效：滋滋声"不能画成"电路火花" |
| **BGM** | ⚠️ 只作情绪参考，不画面化 |
| **时间码** | ❌ 忽略。如"(8–18s)"直接删除 |
| **镜头建议** | ⚠️ 仅作参考，不照搬。如"镜头：中景→特写"可根据情境调整 |

### 设定约束（必须遵守）
- 识别剧本中的规则设定，如"无物理杀伤力" → 禁止画物体破碎/爆炸
- 不能添加与设定矛盾的画面

---

## 🎬 加戏规则（当剧本内容不足时）

### 🚫 禁止的加戏
1. **违反设定**：如"无物理杀伤力"时禁止画"石狮子裂开"
2. **音效画面化**："音效：滋滋声" ❌ 不能画成"血液流入电路"
3. **过度拆分**：单一动作最多2-3个镜头，禁止拆成7+个
4. **无意义重复**：相似画面（如惊恐表情）不连续超过2次

### ✅ 允许的加戏（优先级从高到低）
1. **环境反应**：周围物体/空间变化（如"浮尘悬浮"）
2. **角色反应**：其他角色的表情/动作反应
3. **UI/界面**：科幻设定的虚拟界面、警告弹窗
4. **氛围渲染**：天空变色、云层翻滚（不违反物理设定）

### 节奏分配
- 开场不拖沓：第一个场景≤5个镜头
- 高潮多镜头：转折点3-5个镜头
- 过渡要快：铺垫场景1-2个镜头

---

## 输入信息

### 阶段1：剧本分析摘要
- 地点：${stage1.basicInfo.location}
- 角色：${stage1.basicInfo.characters.join('、')}
- 故事内时间跨度：${stage1.basicInfo.timespan}
- 高潮：${JSON.stringify(stage1.climax)}
- 场景段落：${(stage1.scenes || []).map(s => `${s.id}（${s.duration}）`).join('、')}

### 阶段1.6：空间布局锚点（sceneLayouts）

这些是只为分镜服务的**场景空间锚点**，在本阶段和阶段4中视为**选景 / 机位的硬约束**：
- 同一 sceneId 的所有镜头，角色和地标在空间中的相对关系必须与这里保持一致；
- 如果需要改变角色站位或离开原有地标，必须通过清晰的镜头序列表现移动过程，不能出现突然换位置的“瞬移感”。

${sceneLayoutSummary}

### 阶段2：视觉策略摘要
- 视觉风格：${stage2.overallStyle?.visualTone || '待定'}
- 运镜分布：${JSON.stringify(stage2.cameraStrategy?.cameraMoveDistribution || {})}
- 整体节奏：${stage2.rhythmControl?.overallPace || '待定'}

---

## ⚠️⚠️⚠️ 技术约束（必须严格遵守！）

1. **AI视频生成限制**：每段视频只能 5秒 或 10秒
2. **剧本"分镜"≠实际镜头**：剧本中的"分镜01-06"是叙事段落，每个段落需拆分为多个镜头
3. **🚨 成片总时长约束（本项目统一规格）**：
   - 每集成片总时长必须控制在 **90-110秒（1分30秒-1分50秒）** 之间，**不允许少于90秒**；
   - 如 Stage 1 的 timespan 明显短于90秒，视为“故事内时间被压缩”，你需要通过节奏与加镜头手段，将成片剪辑控制在上述区间内。

4. **🚨 目标镜头数（强制！）**：
   | 成片总时长 | 最少镜头数 | 目标镜头数 | 绝对禁止 |
   |-----------|----------|----------|---------|
   | 90-110秒 | **25个** | **28-32个** | **<22个** |

   **⚠️ 如果你的 shotList 长度 < 25 个，你必须返工增加镜头！**

5. **动态运镜为主**：固定镜头控制在10%以内
6. **每个镜头必须可生成**：考虑AI视频生成的可行性

### 🚨 镜头数量自检清单（必须执行！）

在生成shotList后，立即检查：
- [ ] shotList.length >= 25？如果不是，增加镜头！
- [ ] 每个场景段落至少3-5个镜头？
- [ ] 高潮场景至少4-6个镜头？
- [ ] 没有任何场景只有1个镜头？

**增加镜头的方式（按优先级）**：
1. 为重要动作增加**环境反应镜头**（如"波纹扫过石像"）
2. 为关键时刻增加**角色反应镜头**（如"独孤云惊恐表情"）
3. 将复合动作拆分为**2-3个连贯镜头**（如"双手合十"→准备+合十+光芒）
4. 增加**UI/界面镜头**（科幻设定的警告弹窗、系统界面）
5. 增加**氛围渲染镜头**（天空变色、地面裂纹扩散）

---

## 推理步骤

### 【Step 3.1】基于情绪节奏计算目标镜头数 ⭐核心步骤

⚠️ **不要使用机械的"段落×3"！必须根据每个段落的情绪强度分配镜头！**

思考过程：
1. 回顾Stage 1的情绪弧线，为每个场景段落标注情绪强度（1-10）
2. 根据Stage 2的rhythmControl.emotionDrivenAllocation（如果有）
3. 按情绪强度分配镜头：
   - 情绪8-10分 → 4-6个镜头（快速剪辑）
   - 情绪5-7分 → 3-4个镜头（中等节奏）
   - 情绪1-4分 → 1-2个镜头（慢节奏）
4. 检查总数是否达到最低要求（${minimumShots}）

输出格式：
\`\`\`json
{
  "shotCount": {
    "totalDuration": "总时长（秒）",
    "emotionBasedAllocation": [
      {
        "sceneId": "S1",
        "sceneName": "场景描述",
        "emotionIntensity": 8,
        "rhythmType": "快节奏",
        "shotCount": 5,
        "avgDuration": "2.5s",
        "rationale": "高潮场景，情绪爆发需要快速剪辑"
      },
      {
        "sceneId": "S2",
        "sceneName": "铺垫过渡",
        "emotionIntensity": 3,
        "rhythmType": "慢节奏",
        "shotCount": 2,
        "avgDuration": "6s",
        "rationale": "铺垫场景，需要留白和呼吸空间"
      }
    ],
    "targetTotal": "目标总镜头数（所有场景相加）",
    "rhythmCurve": "铺垫→发展→高潮→收尾 的节奏曲线描述"
  }
}
\`\`\`

### 【Step 3.2】分配景别、角度和运镜（Framed Ink理论）

思考过程：
1. 根据视觉策略的运镜分布，分配每个场景的运镜类型
2. 确定景别分布（远景/中景/近景/特写）
3. **结合 Stage 1.6 的 sceneLayouts 信息**：对每个 sceneId，明确可用的空间锚点（landmarks）和角色默认站位（defaultPositions），所有镜头的机位选择、角色站位和景别切换都必须与这些设定保持一致，避免角色或地标在不同镜头间无故“瞬移”。
4. **确定角度分布（平视/仰拍/俯拍/极端角度）← 避免视觉单调！**
5. **确定透视类型分布（一点/两点/三点透视）← 增加画面冲击力！**
6. 确保动态运镜占90%以上

#### 🚨 朝向角度分布要求（硬性规则，违反=任务失败！）：
⚠️ 规则依据：.augment/rules/角度规则优化总结.ini

| 角度 | 硬性规则 | 适用场景 |
|-----|---------|---------|
| 正面 Front | **≤7%（30镜最多2个）** | ⚠️极少用，仅关键情绪节点 |
| 3/4正面 3/4 Front | **≤25%** | ✅最常用，对话、表情展示 |
| 正侧面 Full Side | **~20%** | 动作、追逐 |
| 3/4背面 3/4 Back | **~15%** | 悬念、环境展示 |
| 背面 Back | **~10%** | 远去、环境 |
| 1/3侧面/背面 | **~20%** | 行走、窥探 |
| **主观视角 POV** | **≤5%（30镜最多1-2个）** | 🎯特殊用途：角色发现关键线索、惊恐时刻、追逐中的威胁视角 |

**⚠️ 违反正面占比规则（>7%）= 任务失败！必须重新分配！**

**🎯 主观视角(POV)使用指南**：
- **定义**：从角色眼睛看出去的第一人称视角
- **适用场景**：
  1. 角色发现关键线索（如：晋安看到墙上的神秘符号）
  2. 惊恐/震撼时刻（如：林溪看到巨型怪物逼近）
  3. 追逐中的威胁视角（如：从敌人视角看向逃跑的主角）
  4. 探索未知空间（如：角色推开门，看到神秘房间）
- **使用频率**：极少用，30个镜头最多1-2个
- **提示词格式**："主观视角，[目标物体/角色的状态和位置]"
- **示例**：
  - [正确] "主观视角，敌人正面站立在3米外，表情凶狠"
  - [正确] "主观视角，走廊向前延伸，尽头是发光的门"
  - [错误] "从晋安眼睛看出去，敌人在前方" （会画眼睛特写）

#### 🚨 高度角度分布要求（硬性规则，违反=任务失败！）：
⚠️ 规则依据：.augment/rules/角度规则优化总结.ini

| 角度类型 | 硬性规则 | 情绪效果 |
|---------|---------|---------|
| 平视(Eye Level) | **10-15%（30镜约3-5个）** | ⚠️仅用于无情绪说明性镜头 |
| 轻微仰/俯(Mild) | **~40%** | ✅默认选择 |
| 中度仰/俯(Moderate) | **~30%** | 力量/压抑感 |
| **极端角度(Extreme/Bird/Worm)** | **≥15%（30镜至少5个）** | **冲击力、戏剧性** |
| **荷兰角(Dutch)** | **每8-10镜1个** | 不安、混乱 |

**⚠️ 违反平视占比规则（<10% 或 >15%）= 任务失败！必须重新分配！**
**⚠️ 违反极端角度规则（<15%）= 任务失败！必须重新分配！**

⚠️ **绝对禁止**：
- 连续2个以上平视镜头！
- 连续3个以上3/4正面镜头！
- 违反=任务失败！

🚨🚨🚨 **输出JSON前的强制自检步骤（必须执行！）**：

**Step 1: 统计正面镜头数量**
- 遍历所有镜头，统计 angleDirection = "正面(Front)" 的数量
- 如果 > 2个：
  - ⚠️⚠️⚠️ **立即停止！这是最高优先级规则！**
  - 将多余的正面镜头改为 "3/4正面(3/4 Front)"
  - 重新统计，确保 ≤ 2个
  - **违反此规则 = 任务失败，必须重新生成！**

**Step 2: 统计平视镜头占比**
- 遍历所有镜头，统计 angleHeight = "平视(Eye Level)" 的数量
- 计算占比 = 平视数量 / 总镜头数
- 如果 < 10% 或 > 15%：
  - ⚠️⚠️⚠️ **立即停止！这是最高优先级规则！**
  - 如果 < 10%：将部分"轻微仰拍"或"轻微俯拍"改为"平视"
  - 如果 > 15%：将多余的"平视"改为"轻微仰拍(Mild Low)"（默认选择）
  - 重新统计，确保在 10-15% 范围内
  - **违反此规则 = 任务失败，必须重新生成！**

**Step 3: 检查连续平视镜头**
- 遍历所有镜头，检查是否有连续2个以上的"平视(Eye Level)"
- 如果发现连续平视：
  - ⚠️⚠️⚠️ **立即停止！这是最高优先级规则！**
  - 将第2个及之后的平视镜头改为"轻微仰拍(Mild Low)"或"轻微俯拍(Mild High)"
  - 重新检查，确保无连续平视
  - **违反此规则 = 任务失败，必须重新生成！**

**Step 4: 统计极端角度占比**
- 统计以下角度的总数：
  - 极端俯拍(Extreme High)
  - 极端仰拍(Extreme Low)
  - 鸟瞰(Bird's Eye)
  - 虫视(Worm's Eye)
  - 荷兰角(Dutch Angle)
- 计算占比 = 极端角度数量 / 总镜头数
- 如果 < 15%：
  - ⚠️⚠️⚠️ **立即停止！这是最高优先级规则！**
  - 将部分"中度仰拍"或"中度俯拍"升级为"极端仰拍"或"极端俯拍"
  - 或添加荷兰角
  - 重新统计，确保 ≥ 15%
  - **违反此规则 = 任务失败，必须重新生成！**

**✅ 自检通过后，才能输出最终JSON！**

#### 透视类型分布要求：
| 透视类型 | 目标占比 | 用途 |
|---------|---------|------|
| 一点透视 | 30-40% | 纵深感、引导视线 |
| 两点透视 | 30-40% | 空间立体感 |
| **三点透视** | **15-25%** | **极端角度、戏剧冲击** |
| 平面构图 | <15% | 特写、静态情绪 |

#### 🎬 运镜分布要求（避免呆板！）：
| 运镜类型 | 占比 | 说明 |
|---------|------|------|
| **完全固定 Static** | **≤5%（一集最多1-2个）** | ⚠️极少使用！ |
| 轻微推拉 | ~25% | "固定"也应有轻微运动 |
| 推镜/拉镜 | ~25% | 强调/建立 |
| 横摇/竖摇 | ~20% | 展示空间/跟随 |
| 跟拍 | ~15% | 动态感 |
| 升降/环绕 | ~10% | 史诗感/揭示 |

**⚠️ 即使标注"固定"，也应有"轻微缓慢推进"或"微弱呼吸感"**

输出格式（30个镜头的分布示例）：
\`\`\`json
{
  "shotDistribution": {
    "byShotSize": {
      "ELS": { "count": 2, "percentage": "7%" },
      "LS": { "count": 5, "percentage": "17%" },
      "MS": { "count": 10, "percentage": "33%" },
      "CU": { "count": 8, "percentage": "27%" },
      "ECU": { "count": 5, "percentage": "17%" }
    },
    "byAngleDirection": {
      "front": { "count": 2, "percentage": "7%", "note": "≤7%，30个镜头最多2个，极少用" },
      "threeQuarterFront": { "count": 7, "percentage": "23%", "note": "≤25%，最常用" },
      "fullSide": { "count": 6, "percentage": "20%" },
      "threeQuarterBack": { "count": 5, "percentage": "17%" },
      "back": { "count": 3, "percentage": "10%" },
      "otherAngles": { "count": 7, "percentage": "23%", "note": "1/3侧面+1/3背面" }
    },
    "byAngleHeight": {
      "eyeLevel": { "count": 4, "percentage": "13%", "note": "10-15%，禁止连续2个" },
      "mildAngles": { "count": 12, "percentage": "40%", "note": "轻微仰/俯拍，默认选择" },
      "moderateAngles": { "count": 9, "percentage": "30%" },
      "extremeAngles": { "count": 5, "percentage": "17%", "note": "≥15%，极端仰拍/俯拍/鸟瞰/虫视" }
    },
    "dutchAngle": { "count": 3, "percentage": "10%", "note": "每8-10镜至少1个" },
    "byPerspective": {
      "onePoint": { "count": 10, "percentage": "33%" },
      "twoPoint": { "count": 10, "percentage": "33%" },
      "threePoint": { "count": 6, "percentage": "20%", "note": "用于极端角度，增加冲击力" },
      "flat": { "count": 4, "percentage": "13%" }
    },
    "byCameraMove": {
      "push": { "count": 7, "percentage": "23%" },
      "pull": { "count": 5, "percentage": "17%" },
      "pan": { "count": 6, "percentage": "20%" },
      "track": { "count": 5, "percentage": "17%" },
      "crane": { "count": 3, "percentage": "10%" },
      "handheld": { "count": 3, "percentage": "10%" },
      "static": { "count": 1, "percentage": "3%", "note": "≤5%，一集最多1-2个" }
    }
  }
}
\`\`\`

### 【Step 3.3】设计节奏曲线

思考过程：
1. 根据情绪弧线设计镜头时长变化
2. 高潮前镜头加快，高潮后可能放缓
3. 规划每个场景的节奏类型

输出格式：
\`\`\`json
{
  "pacingCurve": {
    "scenes": [
      {
        "sceneId": "S1",
        "pacing": "紧张",
        "shotDurations": [4, 3, 5, 3, 4, 3, 4, 4],
        "description": "快速剪辑建立紧张感"
      }
    ],
    "climaxShots": ["#12", "#13", "#14"],
    "rhythmNotes": "整体节奏描述"
  }
}
\`\`\`

### 【Step 3.4】生成镜头列表大纲

为每个镜头生成简要大纲（详细设计在阶段4）

输出格式：
\`\`\`json
{
  "shotList": [
    {
      "shotNumber": "#01",
      "sceneId": "S1",
      "duration": 4,
      "shotSize": "LS",
      "cameraMove": "track",
      "briefDescription": "二人冲入管道，跟随移动"
    }
  ]
}
\`\`\`

---

## 【最终输出】

请将所有步骤的结果合并为一个完整的JSON：

\`\`\`json
{
  "shotCount": { ... },
  "shotDistribution": { ... },
  "pacingCurve": { ... },
  "shotList": [ ... ],
  "thinking": {
    "step3_1": "镜头数量计算思考过程",
    "step3_2": "景别运镜分配思考过程",
    "step3_3": "节奏曲线设计思考过程",
    "step3_4": "镜头列表生成思考过程"
  }
}
\`\`\`

---

## 🚨🚨🚨 最终自检（必须通过！）

在输出JSON之前，**必须**执行以下检查：

### ✅ 第一步：数镜头数量（最重要！）

数一数你的 shotList 数组有多少个对象？

\`\`\`
shotList.length = ?
- 如果 >= ${minimumShots} → ✅ 合格
- 如果 < ${minimumShots} → ❌ 不合格！必须增加镜头！
\`\`\`

**如果镜头数不足，从以下方式增加：**
1. 为动作段落增加「准备」和「效果」镜头
2. 增加「环境反应镜头」
3. 增加「角色反应镜头」
4. 增加「UI界面特写镜头」

### ✅ 第二步：场景覆盖检查
\`\`\`
每个场景段落都有3-5个镜头？
- 如果 是 → ✅ 继续
- 如果 否 → ❌ 返工！补充镜头数不足的场景！
\`\`\`

### ✅ 第三步：角度分布检查
\`\`\`
极端角度(Extreme/Bird/Worm) >= 15%？
连续平视镜头 <= 2个？
- 如果 是 → ✅ 继续
- 如果 否 → ❌ 调整角度分布！
\`\`\`

---

## 🚨 再次强调

**shotList.length 必须 >= ${minimumShots}！如果不足，你必须增加镜头后再输出！**
`;
}



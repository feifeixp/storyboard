/**
 * 角色补充提取服务
 * 针对完整度不足的角色，智能补充缺失信息
 */

import { CharacterRef, CharacterForm } from '../types';
import { ScriptFile } from '../types/project';
import { MissingField } from './characterCompleteness';

const DEFAULT_MODEL = 'google/gemini-2.0-flash-001';

/**
 * 合并形态数组（去重）
 * @param oldForms 原有形态数组
 * @param newForms 新增形态数组
 * @returns 合并后的形态数组
 */
function mergeUniqueForms(oldForms?: CharacterForm[], newForms?: CharacterForm[]): CharacterForm[] {
  if (!newForms || newForms.length === 0) return oldForms || [];
  if (!oldForms || oldForms.length === 0) return newForms;

  const merged = [...oldForms];
  for (const newForm of newForms) {
    // 根据 name 或 id 判断是否已存在
    const exists = merged.find(f => f.name === newForm.name || f.id === newForm.id);
    if (!exists) {
      merged.push(newForm);
    }
  }
  return merged;
}

/**
 * 合并能力数组（去重 + 合并相似项）
 * @param oldAbilities 原有能力数组
 * @param newAbilities 新增能力数组
 * @returns 合并后的能力数组
 */
function mergeUniqueAbilities(oldAbilities?: string[], newAbilities?: string[]): string[] {
  if (!newAbilities || newAbilities.length === 0) return oldAbilities || [];
  if (!oldAbilities || oldAbilities.length === 0) return newAbilities;

  // 🔧 智能去重：合并相似的能力
  const merged = [...oldAbilities];

  for (const newAbility of newAbilities) {
    // 检查是否已存在完全相同或相似的能力
    const similar = merged.find(existing => {
      // 完全相同
      if (existing === newAbility) return true;

      // 包含关系（如"暴力威胁"包含"威胁"）
      if (existing.includes(newAbility) || newAbility.includes(existing)) return true;

      // 相似度检查（如"威胁恐吓"和"威胁"）
      const commonChars = [...existing].filter(char => newAbility.includes(char)).length;
      const similarity = commonChars / Math.max(existing.length, newAbility.length);
      if (similarity > 0.6) return true;

      return false;
    });

    if (!similar) {
      merged.push(newAbility);
    }
  }

  // 🔧 限制数量：最多保留6个核心能力
  if (merged.length > 6) {
    return merged.slice(0, 6);
  }

  return merged;
}


/**
 * 补充角色详细信息
 * @param character 需要补充的角色
 * @param missingFields 缺失的字段列表
 * @param scripts 项目的所有剧本
 * @param model AI模型
 * @param onProgress 进度回调函数
 * @returns 补充后的角色信息
 */
export async function supplementCharacterDetails(
  character: CharacterRef,
  missingFields: MissingField[],
  scripts: ScriptFile[],
  model: string = DEFAULT_MODEL,
  onProgress?: (stage: string, content?: string) => void
): Promise<CharacterRef> {

  try {
    // 构建提示词
    onProgress?.('正在构建提示词...');
    const prompt = buildSupplementPrompt(character, missingFields, scripts);

    // 调用 LLM（流式输出）
    onProgress?.('正在调用AI模型...');
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${import.meta.env.VITE_OPENROUTER1_API_KEY}`,
        'HTTP-Referer': window.location.origin,
      },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.3,
        max_tokens: 4000,
        stream: true, // 🆕 启用流式输出
      })
    });

    if (!response.ok) {
      if (response.status === 402) {
        throw new Error('API余额不足，请检查OpenRouter账户余额');
      }
      if (response.status === 401) {
        throw new Error('API Key无效，请检查VITE_OPENROUTER1_API_KEY配置');
      }
      throw new Error(`API请求失败: ${response.status}`);
    }

    // 🆕 处理流式响应
    const reader = response.body?.getReader();
    if (!reader) {
      throw new Error('无法读取响应流');
    }

    const decoder = new TextDecoder();
    let fullContent = '';
    let currentStage = '';

    onProgress?.('AI正在思考...');

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value, { stream: true });
      const lines = chunk.split('\n').filter(line => line.trim() !== '');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;

          try {
            const parsed = JSON.parse(data);
            const delta = parsed.choices?.[0]?.delta?.content;
            if (delta) {
              fullContent += delta;

              // 🆕 检测思维链阶段
              if (fullContent.includes('## 第一步：剧本分析') && currentStage !== 'script') {
                currentStage = 'script';
                onProgress?.('📖 正在分析剧本...');
              } else if (fullContent.includes('## 第二步：视觉标签设计') && currentStage !== 'visual') {
                currentStage = 'visual';
                onProgress?.('🎨 正在设计视觉标签...');
              } else if (fullContent.includes('## 第三步：外貌描述创作') && currentStage !== 'appearance') {
                currentStage = 'appearance';
                onProgress?.('🎬 正在创作外貌描述...');
              } else if (fullContent.includes('## 第四步：服化道设计') && currentStage !== 'costume') {
                currentStage = 'costume';
                onProgress?.('👗 正在设计服装造型...');
              } else if (fullContent.includes('<最终结果>') && currentStage !== 'final') {
                currentStage = 'final';
                onProgress?.('✨ 正在生成最终结果...');
              }
            }
          } catch (e) {
            // 忽略解析错误
          }
        }
      }
    }

    if (!fullContent) {
      throw new Error('API 返回内容为空');
    }

    // 解析返回的内容
    onProgress?.('正在解析结果...');
    const supplementData = parseSupplementResponse(fullContent);

    // 🔧 增量合并：数组字段合并去重，字符串字段保留非空值
    const updatedCharacter: CharacterRef = {
      ...character,
      ...supplementData,
      id: character.id, // 保持原ID不变

      // 🔧 数组字段：合并去重（不覆盖）
      forms: mergeUniqueForms(character.forms, supplementData.forms),
      abilities: mergeUniqueAbilities(character.abilities, supplementData.abilities),

      // 🔧 字符串字段：保留非空值（新值为空时保留旧值）
      appearance: supplementData.appearance || character.appearance,
      quote: supplementData.quote || character.quote,
      identityEvolution: supplementData.identityEvolution || character.identityEvolution,
    };

    return updatedCharacter;

  } catch (error) {
    console.error('补充角色信息失败:', error);
    throw error;
  }
}

/**
 * 构建补充提示词
 */
function buildSupplementPrompt(
  character: CharacterRef,
  missingFields: MissingField[],
  scripts: ScriptFile[]
): string {
  // 合并所有剧本内容
  const combinedContent = scripts.map(s =>
    `=== 第${s.episodeNumber || '?'}集 ===\n${s.content}`
  ).join('\n\n');

  const missingFieldsList = missingFields.map(f => `- ${f.label} (权重: ${f.weight}分)`).join('\n');

  return `# 任务：补充角色"${character.name}"的详细信息

⚠️ **重要：本次任务由多个专业角色协作完成，请严格按照以下流程思考！**

**参与角色**：
1. 📖 剧本分析师 - 分析剧本中的角色信息
2. 🎨 AI视觉设计师 - 设计独特的视觉标签
3. 👗 服化道设计师 - 设计符合时代和角色的服装
4. 🎬 影视美学专家 - 确保角色有吸引力和辨识度

**核心原则**：
- ✅ 根据剧本内容创造独特的设计
- ❌ 不要套用固定模板
- ❌ 不要直接复制示例
- ❌ 不要千篇一律

**🎬 影视化美学原则**（最重要！）：
- **不要过度写实**：即使是底层角色，也不要描述得太过朴素粗糙
- **要有视觉吸引力**：每个角色都要让观众觉得美、有质感、有层次
- **要有设计感**：服装要有色彩搭配、剪裁线条、装饰细节，不是随便穿衣
- **要有电影感**：想象这是电影画面，要有艺术化处理，不是纪录片

**专业判断标准**（请像真正的专业人士一样思考）：

1. **影视美学专家的核心原则**（最重要！）：

   **角色定位与美学标准**：
   - 主角/重要配角：必须有吸引力，五官精致，气质出众
   - 底层角色：要"美得真实"，不是"丑得真实"
   - 反派/恶人：可以凶狠，但要有气场，不是单纯的丑
   - 即使是"90年代农村女孩"，也要"清贫但自尊"，不是"邋遢丑陋"

   **具体判断方法**：
   - 分析角色在剧本中的定位（主角/配角/反派）
   - 主角：必须让观众产生共鸣和喜爱，所以要有吸引力
   - 底层角色：可以朴素、消瘦、粗糙，但要有"清秀"、"坚韧"等美感
   - 反派：可以凶狠、冷酷，但要有"气场"、"威慑力"等魅力

   **静态特征 vs 动态表情**：
   - 要描述"眼型"（如眼尾上挑、眼型狭长、内双），而不是"眼神"（如眼神锐利、眼神清澈）
   - 要描述"唇形"（如唇形饱满、下唇略厚），而不是"表情"（如嘴唇紧抿、嘴角下压）
   - 原因：设定图要展示角色的基础外貌，而不是某个特定场景的表情

2. **服化道设计师的判断标准**：

   **社会阶层与描述精致度**：
   - 富裕阶层/都市白领：可以使用"精致的"、"考究的"、"保养得当"
   - 底层/农村角色：使用"面部线条柔和"、"清秀"、"朴素但整洁"
   - 关键：底层角色可以"朴素"，但不能"丑陋"；可以"消瘦"，但要"清秀"

   **美学平衡**：
   - 即使是贫困角色，也要有美感：如"皮肤虽略显粗糙，但五官清秀"
   - 即使是劳作角色，也要有尊严：如"衣服虽旧但洗得干净，裤线笔直"
   - 原因：影视作品需要美学价值，观众需要视觉享受

3. **服装设计师的判断标准**：

   **细节展现故事**：
   - 不要使用笼统的描述（如"款式简单"、"没有过多装饰"）
   - 要通过具体细节展现角色的故事（如"袖口有手工缝制的补丁"体现勤劳节俭）
   - 要分析时代背景、经济状况、性格特点，然后设计符合逻辑的服装细节

   **清贫但自尊**：
   - 贫困角色的服装可以旧、可以补丁，但要"整洁"、"利落"
   - 体现自尊：如"衣服虽旧但擦拭干净"、"鞋带系得整齐"、"裤线笔直"
   - 原因：服装是角色性格的视觉化表达，"清贫但自尊"比"邋遢丑陋"更有戏剧张力

## 当前角色信息
- 名称：${character.name}
- 性别：${character.gender || '未知'}
- 外观：${character.appearance || '未填写'}
- 身份演变：${character.identityEvolution || '未填写'}
- 经典台词：${character.quote || '未填写'}
- 已有形态数：${character.forms?.length || 0}
- 已有能力数：${character.abilities?.length || 0}

## 需要补充的信息
${missingFieldsList}

## 补充要求

### 1. 多形态/换装图鉴（如果缺失）

⚠️ **重要**：深入理解剧情，识别角色的**真实形态变化**

**形态识别原则**：
1. **时间线变化**：重生前/重生后、过去/现在、年轻/年老、穿越前/穿越后
2. **身份变化**：学生→职场、平民→贵族、普通人→觉醒者、凡人→修仙者
3. **服装变化**：日常装→战斗装、便装→礼服、校服→职业装
4. **外貌变化**：受伤/痊愈、化妆/卸妆、变装/还原、觉醒前/觉醒后

**禁止错误识别**：
- ❌ 不要将"角色对他人造成的伤害"识别为"角色自己的形态"
  - 示例：剧本中"苏曼用暖水壶烫伤了苏强" → ❌ 错误：识别为"苏曼的烫伤妆形态"
  - 正确：这不是苏曼的形态变化，忽略
- ❌ 不要将"道具/武器"识别为"形态"
  - 示例："张三拿起宝剑" → ❌ 错误：识别为"持剑形态"
  - 正确：这只是动作，不是形态
- ❌ 不要将"一次性事件"识别为"持续形态"
  - 示例："李四被雨淋湿了" → ❌ 错误：识别为"淋雨形态"
  - 正确：这是临时状态，不是持续形态

**正确示例**：
- 剧本："序幕中苏曼32岁满脸伤痕衣衫褴褛，重生后回到1993年22岁年轻状态"
  - ✅ 正确：识别为两个形态
    - 形态1：重生前（32岁，满脸伤痕，衣衫褴褛，绝望）
    - 形态2：重生后（22岁，年轻，眼神坚定，重获新生）

**补充要求**：
- ⚠️ **集数范围**：episodeRange必须在实际剧本集数范围内（当前剧本：第${scripts.map(s => s.episodeNumber).filter(Boolean).join('、')}集）
- ⚠️ **数量限制**：如果角色已有${character.forms?.length || 0}个形态，只补充剧本中**明确描述但未记录**的形态
- ⚠️ **重要**：形态描述必须基于主形态，只描述变化的部分

**形态描述格式**（必须遵循）：

⚠️ **核心原则**：形态描述是"在主形态基础上的变化描述"，不是"完全重新描述"

**正确格式**（只描述变化）：

【保持不变】基本脸型、眼型、鼻型、唇形、身高比例

【状态变化】
- 发型：从齐耳短发变为披肩长发，干枯毛躁，失去光泽
- 面容：略显憔悴，脸颊消瘦，眼窝略深，但五官轮廓依然清晰
- 肤色：从白皙变为暗沉粗糙，有浅浅的伤痕
- 身材：从纤细匀称变为消瘦，略微佝偻
- 服装：一件看不出原本颜色的粗布上衣，多处破损，用深色布料随意缝补

❌ **错误格式**（完全重新描述，会导致认不出是同一个人）：

【主体人物】中国人，女性，32岁
【外貌特征】头发干枯毛躁，面容憔悴，脸颊消瘦...
【服饰造型】一件看不出原本颜色的粗布上衣...

- 每个形态必须包含：
  - name: 形态名称（带emoji，如 "🎒 高中校服"、"⏰ 重生前"）
  - episodeRange: 出现集数（如 "Ep 1-5"，必须在实际剧本范围内）
  - description: **基于主形态的变化描述**（100-150字，只描述变化的部分）
  - note: 备注（如 "日常伪装期"、"32岁绝望状态，被折磨十年后"）
  - visualPromptCn: 中文视觉提示词（用于AI生图）
  - visualPromptEn: 英文视觉提示词（用于AI生图）

⚠️ **形态变化的度把握**（关键！避免形态图与常态图完全不像同一个人）：

**原则**：形态是"同一个人的不同状态"，不是"完全不同的人"

**正确做法**：
- ✅ **保持基本面部特征**：眼型、鼻型、脸型、五官结构
- ✅ **只改变状态**：憔悴、伤痕、衣衫褴褛、发型凌乱
- ✅ **适度描述**：不要过度夸张，保持可识别性

**错误做法**：
- ❌ 改变五官结构：如"颧骨高耸"（常态是"颧骨微高"）
- ❌ 改变脸型：如"脸颊凹陷"（常态是"鹅蛋脸"）
- ❌ 过度老化：如"布满皱纹"、"背部佝偻"、"步履蹒跚"（会变成老太太）
- ❌ 完全不同的人：如"面容扭曲"、"五官变形"

**示例对比**（重生前形态）：

❌ **错误示例**（太过，完全不像同一个人）：
"头发枯黄凌乱，面容憔悴，布满伤痕，眼神空洞绝望。颧骨高耸，脸颊凹陷，嘴唇干裂起皮。皮肤粗糙黝黑，布满皱纹。身材瘦弱，骨瘦如柴，背部佝偻，步履蹒跚。"
→ 问题：颧骨高耸、脸颊凹陷、布满皱纹、背部佝偻 → 这是70岁老太太，不是32岁女性

✅ **正确示例**（憔悴但可识别）：
"发质干枯无光泽，面容憔悴但五官轮廓依然清晰，眼窝略深，嘴唇干裂，肤色粗糙失去光泽，脸上有几道浅浅的伤痕，身材消瘦但保持基本体态。"
→ 效果：保持了基本特征，只是状态变差，依然能看出是同一个人

**示例**（重生类剧本）：
- 角色常态描述：重生后的状态（如22岁）
- 特殊形态：重生前的状态（如32岁，作为一个形态）
  - ⚠️ 重生前应该是"憔悴版的同一个人"，不是"完全不同的人"
  - ⚠️ 保持基本面部特征，只改变状态

### 2. 经典台词（如果缺失）
- 提取最能代表"${character.name}"性格/理念的一句话
- 要求：原文引用，不要改编

### 3. 身份演变（如果缺失）
- 用箭头连接身份变化，如："高中生 ➔ 觉醒者 ➔ 救世主"
- 要求：简洁，3-5个阶段

### 4. 能力进化（如果缺失）
- ⚠️ **重要**：角色已有${character.abilities?.length || 0}个能力，**不要重复添加**
- ⚠️ **数量限制**：最多保留3-5个**核心能力**，不要列举所有行为
- ⚠️ **去重要求**：如果已有"暴力威胁"，不要再添加"威胁"、"威胁恐吓"等相似项
- 格式：数组，如 ["基础感知", "数据操控", "现实改写"]
- 示例（错误）：["暴力威胁", "威胁", "威胁恐吓", "精神控制", "暴力控制"] ❌ 太多重复
- 示例（正确）：["暴力控制", "精神操控", "赌博成瘾"] ✅ 简洁核心

### 5. 外观描述（如果缺失或不足100字）

⚠️ **重要**：外观描述用于生成角色设定图，只描述角色本身特征，不包含美术风格！

⚠️ **特别注意**：
- 对于重生/穿越类剧本，外观描述应该是**重生后/穿越后的常态**（如22岁），而不是重生前/穿越前的状态
- 重生前/穿越前的状态应该作为一个**特殊形态**记录在forms数组中

⚠️ **视觉设计优化**（关键！确保角色有记忆点和辨识度）：

**第一步：分析角色特点**
- 从剧本中提取角色的关键行为、台词、性格特征
- 理解角色在故事中的定位（主角/反派/配角）
- 分析角色的时代背景和社会阶层

**第二步：创建独特的视觉标签**
- 根据剧本内容，为角色设计至少3个标志性视觉符号
- 每个符号必须是**具体的、可见的**视觉特征（如发型、疤痕、配饰）
- 符号要能体现角色在剧本中的行为和性格
- 符号要符合时代背景的真实性

**视觉标签设计原则**：
- 每个标签必须是**具体的、可见的**视觉特征
- 标签要能体现角色在剧本中的行为和性格
- 标签要符合时代背景，但要有**艺术化处理**
- 不要过度写实，要有**影视美学**

**第三步：融入外观描述**
- 将视觉标签自然融入【外貌特征】和【服饰造型】中
- 确保描述详细、具体、有画面感
- 不要生硬堆砌，要自然流畅
- **关键**：即使是朴素角色，也要有视觉吸引力和设计感

**生成规范**（目标长度：150-250字）：

**必须使用结构化格式**：
  【主体人物】人种、性别、年龄、时代背景
  【外貌特征】发型、眼睛、五官、表情、体态、肤色、特殊标记
  【服饰造型】时代特征、服装款式、颜色、材质、细节、配饰

**详细要求**：

【主体人物】（必须包含）：
- ⚠️ **人种**：必须明确标注（如"中国人"、"亚洲人"、"欧美人"、"非洲人"等）
- 性别：男/女
- 年龄：如"中年"、"20岁左右"、"老年"
- ⚠️ **时代背景**：必须明确标注（如"中国90年代"、"唐朝"、"民国时期"、"现代都市"、"2020年代"）

【外貌特征】（必须包含 + 影视美学标准）：

⚠️ **影视美学原则**：
- 主角/重要配角：必须有吸引力，五官精致，气质出众
- 底层角色：可以朴素，但要"美得真实"，不是"丑得真实"
- 反派/恶人：可以凶狠，但要有气场，不是单纯的丑
- 即使是"90年代农村女孩"，也要"清贫但自尊"，不是"邋遢丑陋"

**描述要求**（多角色协作设计）：

⚠️ **核心原则：由AI视觉设计师、服化道设计师、影视美学专家协作，根据剧本内容创造独特的角色视觉设计！**

**设计流程**（思维链 - Chain of Thought）：

⚠️ **重要：请按照以下步骤思考，并输出完整的思考过程！**

**输出格式要求**：

\`\`\`
<思考过程>

## 第一步：剧本分析（由剧本分析师完成）

### 1.1 时代背景分析
[分析【主体人物】中的时代背景、年龄、性别]

### 1.2 角色行为分析
[从剧本中提取角色的关键行为、台词]

### 1.3 角色定位分析
[分析角色在故事中的定位：主角/配角/反派]

### 1.4 社会阶层分析
[分析角色的社会阶层和生活状态]

### 1.5 分析结论
[总结角色的核心特征]

---

## 第二步：视觉标签设计（由AI视觉设计师完成）

### 2.1 设计思路
[说明为什么选择这些视觉标签]

### 2.2 视觉标签列表
1. [标签1]：[具体描述] - [体现的性格/行为]
2. [标签2]：[具体描述] - [体现的性格/行为]
3. [标签3]：[具体描述] - [体现的性格/行为]
4. [标签4]：[具体描述] - [体现的性格/行为]（可选）
5. [标签5]：[具体描述] - [体现的性格/行为]（可选）

---

## 第三步：外貌描述创作（由影视美学专家完成）

### 3.1 影视化真实 vs 纪录片真实（核心区分！）

⚠️ **最重要的原则**：

**影视化真实**（我们要的）：
- 真实感来源：自然 + 美感 + 微小的美学瑕疵
- 示例：发质略粗但**富有光泽**、皮肤**略有雀斑**、发尾**自然内扣**
- 效果：让观众觉得真实、自然、有美感

**纪录片真实**（严格禁止）：
- 真实感来源：脏乱差 + 破旧 + 缺陷
- 示例：**沾着灰尘**、**杂乱凌乱**、**手指上的印泥**、**眉毛杂乱未经修饰**
- 效果：让观众觉得脏、乱、丑

**核心原则**：真实 ≠ 脏乱差，真实 = 自然 + 美感

### 3.2 词汇选择原则（如何选择美学词汇）

⚠️ **不要机械地从词汇库中选择，而要学会判断！**

**核心判断方法**：

1. **聚焦美的细节，而不是缺陷**：
   - ✅ 好：发质略粗但**富有光泽**（聚焦光泽这个美的细节）
   - ❌ 差：发质**杂乱**、**未经修饰**（聚焦缺陷）

2. **描述质感和美感，而不是状态**：
   - ✅ 好：睫毛**纤长浓密**、鼻翼**精致**、唇形**优美**（描述美的质感）
   - ❌ 差：眉毛**杂乱**、额前发丝**沾着灰尘**（描述脏乱状态）

3. **通过微小瑕疵增加真实感，而不是脏乱差**：
   - ✅ 好：皮肤**略有雀斑**、发质**略粗但富有光泽**（微小的美学瑕疵）
   - ❌ 差：**手指上沾着印泥**、**额前沾着灰尘**、**眉毛杂乱未经修饰**（脏乱差）

**自我检查**（创作时问自己）：
- 这个词汇是在描述"美的细节"还是"缺陷"？
- 这个词汇会让观众觉得"美"还是"丑"？
- 这个词汇是"自然的瑕疵"还是"脏乱差的状态"？

### 3.3 静态特征 vs 动态状态（严格区分！）

**严格禁止的动态描述**：
- ❌ 表情状态：眼神清澈而坚定、眼神锐利、嘴角微微向下、略带倔强
- ❌ 临时状态：手指上沾着印泥、额前有凌乱的发丝沾着灰尘
- ❌ 动作暗示：透着狠劲、透出倔强、充满绝望、眉头微蹙、嘴唇紧抿

**必须使用的静态描述**：
- ✅ 物理特征：眼型、唇形、发型、脸型、鼻型
- ✅ 固定特征：眼尾上挑、唇形饱满、发尾内扣、睫毛纤长浓密、鼻翼精致

**原因**：角色设定图展示的是基础外貌，不是特定场景的表情或临时状态

### 3.4 角色定位与美学标准

1. **角色定位分析**：
   - 主角/重要配角：必须有吸引力，五官精致，气质出众
   - 底层角色：要"美得真实"（清秀、朴素、自然），不是"丑得真实"
   - 反派/恶人：可以凶狠，但要有气场和魅力，不是单纯的丑

2. **精致度平衡**：
   - 富裕阶层：五官精致、皮肤细腻、发质柔顺、睫毛纤长浓密
   - 底层角色：可以朴素、发质略粗，但要**富有光泽**、**毛孔细腻**、**五官清秀**
   - 核心：即使是底层角色，也要通过美学词汇体现美感

3. **真实感的正确来源**：
   - ✅ 微小的美学瑕疵：略有雀斑、发质略粗但富有光泽、肤色略深但健康
   - ❌ 脏乱差的状态：灰尘、印泥、凌乱、杂乱、污渍、未经修饰

### 3.5 头身比例判断

**判断标准**：

1. **分析角色定位**：
   - 男女主角 → 8头身左右（影视剧演员标准）
   - 关键美型配角 → 8头身左右
   - 普通配角 → 7-7.5头身

2. **分析剧本类型**：
   - 女频/偶像剧/言情剧 → 主角8-8.5头身
   - 古装剧/仙侠剧 → 主角8-8.5头身
   - 现实主义剧 → 主角7.5-8头身
   - 喜剧/生活剧 → 7-7.5头身

3. **检查剧本特殊要求**：
   - 剧本明确要求"矮胖" → 5-6头身
   - 剧本明确要求"高挑" → 8.5-9头身
   - 前期肥胖后期逆袭 → 前期5-6头身，后期8头身

### 3.6 外貌描述创作

[创作详细的外貌描述，包含：发型、脸型、眼睛、眉毛、鼻子、嘴唇、皮肤、身材比例、特殊标记等]

**创作要求**：
- ✅ 使用美学词汇（富有光泽、纤长浓密、精致、优美、细腻）
- ✅ 描述静态的物理特征，不要描述动态的表情状态
- ✅ 通过微小的美学瑕疵增加真实感（略有雀斑、发质略粗但富有光泽）
- ❌ 不要通过脏乱差增加真实感（灰尘、印泥、凌乱、杂乱）
- ✅ 根据角色定位和剧本类型选择合适的头身比（主角8头身，配角7-7.5头身）
- ✅ 即使是底层角色，也要让观众觉得美、有质感、自然

---

## 第四步：服化道设计（由服化道设计师完成）

### 4.1 服装风格判断方法（根据角色选择合适风格）

⚠️ **不是所有角色都"简约"，要根据角色定位选择合适的风格！**

**风格选择的判断维度**：

1. **社会阶层决定精致度**：
   - 富裕阶层：可以华丽、精致、考究（如丝绸旗袍、刺绣华丽、珍珠配饰）
   - 中产阶层：可以简约、得体、有品味（如剪裁合身的职业装、质感良好）
   - 底层阶层：可以朴素、简单，但要整洁、有设计感（如棉布衬衫，但洗得干净、熨得平整）

2. **角色性格决定风格**：
   - 温婉女性：可以柔美、优雅、精致（如碎花裙、蕾丝边、飘逸裙摆）
   - 英气女性：可以利落、简约、帅气（如衬衫+西裤、肩线利落）
   - 叛逆少女：可以个性、前卫、混搭（如皮夹克+破洞牛仔裤，但破洞是设计感的）
   - 传统女性：可以保守、端庄、得体（如旗袍、长裙、立领）

3. **时代背景决定款式**：
   - 90年代：可以复古、怀旧，但要有时代美感（不是破旧）
   - 现代：可以时尚、简约、潮流
   - 古代：可以传统、典雅、华丽

**核心原则**：
- 不是所有角色都"简约"
- 根据角色的社会阶层、性格、职业、时代综合判断
- 富裕角色可以华丽，底层角色可以朴素，叛逆角色可以个性
- 但都要有美感和设计感

### 4.2 底层角色的服装描述标准（朴素自尊 vs 邋遢丑陋）

⚠️ **核心原则**：遵循剧本 + 影视美学

**判断流程**（重要！）：

**第一步：检查剧本是否有明确要求**
- ✅ 如果剧本明确描述"破旧的衣服"、"鞋子开胶"等 → **必须遵循剧本**
- ✅ 如果剧本描述角色处于极端困境（如流浪汉、乞丐、刚经历灾难）→ **可以描述破旧**
- ⚠️ 如果剧本只说"90年代农村女孩"、"底层角色"等 → **不要自己添加破旧描述**

**第二步：如果剧本没有明确要求，选择合适的描述方式**

**❌ 邋遢丑陋**（剧本没要求时禁止）：
- 褪色严重、起球严重、破洞、脏污、凌乱、开胶
- 示例："一件褪色严重的衬衫，已经起球，纽扣掉了几颗，衣领脏污"
- **何时可用**：仅当剧本明确要求或角色设定为极端贫困/流浪汉时

**✅ 朴素自尊**（默认选择）：
- 衣服虽旧但洗得干净、虽简单但熨得平整、虽有磨损但整洁利落
- 示例："一件浅蓝色棉布衬衫，虽是旧衣，但洗得干净，熨得平整，纽扣整齐"
- **何时使用**：普通底层角色、农村角色、贫困但有尊严的角色

**第三步：如果需要描述破旧，也要体现人物尊严**

**对比示例**：

**场景：剧本要求"破旧的衣服"**

❌ **差的描述**（只有破旧，没有尊严）：
"一件褪色严重的衬衫，已经起球，纽扣掉了几颗，衣领脏污，裤子破了个洞"

✅ **好的描述**（破旧但有尊严）：
"一件已经褪色的蓝色衬衫，虽然布料有些起球，但洗得干净，纽扣虽旧但系得整齐。裤子膝盖处有补丁，针脚细密，显示出主人的用心"

**核心区别**：
- 差的描述：只强调"破、旧、脏" → 让人厌恶
- 好的描述：承认"破、旧"，但强调"干净、整齐、用心" → 让人尊重

**判断标准**：
- 问自己：剧本是否明确要求这个破旧细节？
- 问自己：如果要描述破旧，是否也体现了人物的尊严和自尊？
- 问自己：这个角色会让观众产生同情和尊重，还是厌恶和嫌弃？

### 4.3 款式多样性要求

⚠️ **重要**：每次生成都要有创意，不要重复相同的款式！

**领型选择**（根据角色选择，不要总是V领）：
- 圆领、方领、立领、一字领、小翻领、V领、U领、荷叶领等
- 根据角色的性格、职业、时代选择合适的款式

**款式创意**：
- 不要总是"V领设计"、"修身剪裁"
- 要根据角色的个性和时代背景创造独特的款式

### 4.4 服装设计思路
[根据角色的社会阶层、性格、时代背景，选择合适的服装风格]

**判断过程**：
- 分析角色的社会阶层 → 决定精致度（富裕→华丽，底层→朴素）
- 分析角色的性格 → 决定风格（温婉→优雅，英气→利落，叛逆→个性）
- 分析时代背景 → 决定款式（90年代→复古，现代→时尚）

### 4.5 服装描述创作
[创作服装描述，包含6个维度：时代特征、款式剪裁、色彩搭配、材质质感、设计细节、配饰搭配]

**创作要求**：
- ✅ 根据角色定位选择风格（不是所有角色都简约）
- ✅ 有色彩搭配，不是灰暗单调
- ✅ 整洁利落，不是凌乱脏污
- ✅ 每次生成都要有创意，不要重复款式（不要总是V领设计）
- ✅ 底层角色要体现"朴素自尊"，不是"邋遢丑陋"

</思考过程>

<最终结果>

【主体人物】
[输出最终的主体人物描述]

【外貌特征】
[输出最终的外貌特征描述，不要包含任何提醒或说明文字]

【服饰造型】
[输出最终的服饰造型描述，不要包含任何提醒或说明文字]

</最终结果>
\`\`\`

**核心要求**：
- ✅ 必须输出完整的思考过程
- ✅ 每个步骤都要有具体的分析和创作
- ✅ 不要套用固定模板
- ✅ 要根据剧本内容创造独特的设计
- ❌ 不要直接跳到最终结果

**身材比例描述**（关键！避免大头娃娃）：

⚠️ **必须添加头身比，且要根据角色定位和剧本类型智能选择！**

**头身比选择标准**：

1. **根据角色定位选择**：
   - 男女主角：8头身左右（影视剧演员标准，更美型）
   - 关键美型配角：8头身左右
   - 普通配角：7-7.5头身
   - 特殊角色（如矮胖、高挑）：遵循剧本要求

2. **根据剧本类型选择**：
   - 女频/偶像剧/言情剧：主角8-8.5头身（追求美感）
   - 古装剧/仙侠剧：主角8-8.5头身（仙气飘飘）
   - 现实主义剧：主角7.5-8头身（真实但美型）
   - 喜剧/生活剧：7-7.5头身（更接地气）

3. **特殊情况**：
   - 剧本明确要求"矮胖" → 5-6头身
   - 剧本明确要求"高挑" → 8.5-9头身
   - 前期肥胖后期逆袭 → 前期5-6头身，后期8头身

**其他比例要求**：
- 肩宽比例：如"肩宽适中"、"宽肩窄腰"、"溜肩"
- 四肢比例：如"四肢修长"、"腿长比例优越"、"手臂纤长"
- 整体协调：如"比例匀称"、"身材协调"、"黄金比例"

**示例**：
- ❌ 错误："身材纤细" → AI不知道比例，可能生成大头娃娃
- ❌ 错误："标准七头身"（女频剧女主） → 不够美型
- ✅ 正确："修长八头身，身材纤细匀称，四肢修长，比例协调"（女频剧女主）
- ✅ 正确："标准七头身，身材匀称"（普通配角）

**个性化创造**（不要千篇一律）：
- 清冷美人：强调"眼尾微微上扬"、"下颌线流畅"
- 温婉女性：强调"眉眼温柔"、"唇角微微上扬"
- 英气女性：强调"眉峰利落"、"鼻梁高挺"
- 硬汉男性：强调"方正脸型"、"浓眉"、"下颌线硬朗"
- 儒雅男性：强调"眉眼清秀"、"鼻梁挺拔"、"唇形优美"

**视觉气质**（可以保留）：
- ✅ "清冷出尘"、"温婉大方"、"英气飒爽"、"凶悍有威慑力"

**专业提醒**（影视美学专家的判断标准）：
- 角色设定图描述的是"静态的物理特征"，不是"动态的表情状态"
- 要描述"眼型"（如眼尾上挑、眼型狭长、内双），而不是"眼神"（如眼神锐利、眼神清澈）
- 要描述"唇形"（如唇形饱满、下唇略厚），而不是"表情"（如嘴唇紧抿、嘴角下压）
- 要描述"整体气质"（如清秀、坚韧、温婉），而不是"动态状态"（如透着狠劲、透出倔强）
- 原因：设定图要展示角色的基础外貌，而不是某个特定场景的表情或状态

【服饰造型】（必须包含 + 影视服化道标准）：

⚠️ **影视服化道原则**：
- 服装是角色的第二张脸，要有设计感和故事性
- AI视频中可以更大胆设计，不受制作成本限制
- 即使是底层角色，服装也要有细节和层次感

**必须包含的6个维度**：

1. **时代特征**（必须）：
   - 如"90年代常见的"、"唐朝宫廷"、"现代职场"、"民国风"
   - 要符合时代背景的真实性

2. **服装款式 + 剪裁版型**（关键！）：
   - ❌ 错误："衬衫" → 太简单
   - ✅ 正确："衬衫，V领设计，修身剪裁，肩线流畅，腰部有收省"
   - 要描述：款式、剪裁、版型、线条
   - **影视化要点**：即使是朴素服装，也要强调剪裁线条的美感

3. **色彩搭配**（视觉冲击力）：
   - ❌ 错误："深色" → 太笼统
   - ✅ 正确："深蓝色上衣搭配米白色裤子，色彩对比鲜明，视觉层次丰富"
   - 要描述：主色、辅色、色彩关系、视觉效果
   - **影视化要点**：用色彩对比提升视觉吸引力，避免单调灰暗

4. **材质 + 质感**（细节感）：
   - ❌ 错误："布料" → 太简单
   - ✅ 正确："棉麻混纺材质，质地柔软，表面有自然的肌理感，光泽度适中"
   - 要描述：材质、质感、触感、光泽
   - **影视化要点**：通过材质质感展现层次，避免过于粗糙

5. **设计细节 + 装饰元素**（设计感）：
   - ❌ 错误："简单的衣服" → 太单薄
   - ✅ 正确："领口有精致的滚边，袖口有暗纹装饰，纽扣采用木质材质，腰部有细腻的褶皱设计"
   - 要描述：细节、装饰、工艺、图案
   - **影视化要点**：即使是朴素角色，也要有设计亮点，体现服化道的用心

6. **配饰 + 整体搭配**（造型感）：
   - ❌ 错误："鞋子" → 太简单
   - ✅ 正确："复古款布鞋，鞋面有刺绣图案，鞋底有防滑纹理。腰间系着编织腰带，手腕戴着手工编织的饰品"
   - 要描述：鞋子、配饰、整体搭配、层次感
   - **影视化要点**：通过配饰提升造型感，展现角色的审美和品味

**影视化美学原则**（最重要！）：
- **不要过度写实**：即使是90年代底层角色，也不要描述得太过朴素粗糙
- **要有视觉吸引力**：通过色彩搭配、剪裁线条、装饰细节提升美感
- **要有设计感**：每个角色都要有服化道的用心设计，不是随便穿衣
- **要有电影感**：想象这是电影画面，要让观众觉得美、有质感、有层次

**故事性**（通过服装讲述角色）：
- 底层角色：朴素但有设计感，干净利落，色彩搭配和谐
- 富裕角色：精致但不浮夸，有品味，细节考究
- 反派角色：粗犷但有气场，有威慑力，造型有冲击力
- 主角角色：即使朴素也要有亮点，有记忆点，有视觉吸引力

⚠️ **严禁包含以下内容**（这些属于项目级美术风格）：
- 风格引用：如"现实主义风格"、"日系动漫风格"、"王家卫美学"
- 镜头参数：如"90mm镜头"、"f/1.8"、"广角"
- 光线描述：如"侧逆光"、"自然光"、"柔光"
- 拍摄角度：如"45度俯拍"、"仰拍"
- 胶片类型：如"柯达Vision3 500T"、"黑白胶片"
- 画面质量：如"高动态范围"、"4K"、"景深"

⚠️ **重要提醒**：
- ❌ 不要直接复制任何示例或模板
- ✅ 要根据剧本内容创造独特的设计
- ✅ 每个角色都应该有自己的特点和个性

## 剧本内容
${combinedContent.slice(0, 80000)}

## 输出格式要求

⚠️ **必须按照思维链格式输出，包含完整的思考过程和最终结果！**

请严格按照以下格式输出：

\`\`\`
<思考过程>

## 第一步：剧本分析（由剧本分析师完成）

### 1.1 时代背景分析
[分析【主体人物】中的时代背景、年龄、性别]

### 1.2 角色行为分析
[从剧本中提取角色的关键行为、台词]

### 1.3 角色定位分析
[分析角色在故事中的定位：主角/配角/反派]

### 1.4 社会阶层分析
[分析角色的社会阶层和生活状态]

### 1.5 剧本类型分析（影响美学标准）
[分析剧本属于哪种类型，决定角色的美学标准]

**剧本类型分类**：
- **极致美型类**（女频、偶像剧、言情剧、古装仙侠、玄幻）→ 追求完美、精致、梦幻
- **自然真实类**（现实主义剧、文艺片、传记片）→ 追求真实、自然、有瑕疵
- **接地气类**（生活剧、喜剧、农村剧、年代剧）→ 追求亲切、朴素、普通

**判断依据**：剧本题材、故事背景、角色设定

### 1.6 服装风格判断
[根据角色的社会阶层、职业、性格、剧本要求判断服装风格]

**判断维度**：
1. **社会阶层**：富裕/中产/底层？
2. **职业**：白领/学生/农民/商人/家庭主妇？
3. **性格**：保守/时尚/随性/严谨/叛逆？
4. **剧本要求**：是否有明确的服装描述？

**风格选择**：
- 富裕角色 → 华丽、精致、高级
- 中产角色 → 得体、干练、有品味
- 底层角色但有自尊 → 朴素但整洁、简约但有设计感
- 底层角色且剧本要求破旧 → 破旧但体现尊严（干净、整齐）
- 时尚角色 → 潮流、个性、前卫
- 保守角色 → 传统、端庄、稳重

⚠️ 重要：不要默认所有角色都是"朴素"的，要根据具体情况判断

### 1.7 分析结论
[总结角色的核心特征、剧本类型、美学标准方向、服装风格]

---

## 第二步：视觉标签设计（由AI视觉设计师完成）

### 2.1 设计思路
[说明为什么选择这些视觉标签]

### 2.2 视觉标签列表
1. [标签1]：[具体描述] - [体现的性格/行为]
2. [标签2]：[具体描述] - [体现的性格/行为]
3. [标签3]：[具体描述] - [体现的性格/行为]
...

⚠️ **个性化要求**：
- 每个角色都要有独特的标签，不要千篇一律
- 根据角色的性格、经历、社会阶层选择标签
- 即使是同类型的角色，也要有不同的侧重点

---

## 第三步：外貌描述创作（由影视美学专家完成）

### 3.1 美学标准选择（根据剧本类型）

[根据第一步分析的剧本类型，选择对应的美学标准]

**如果是极致美型类**（女频、偶像剧、言情剧、古装仙侠）：
- 五官标准：追求完美精致，立体感强，轮廓分明，几乎没有瑕疵
- 皮肤标准：追求白皙细腻，光滑无瑕，毛孔几乎不可见
- 发质标准：追求柔顺有光泽，发量丰盈，质感飘逸
- 身材标准：8-8.5头身，比例完美，曲线优美
- 真实感来源：极少的微小瑕疵（如略有雀斑，但要很少很淡）
- 整体效果：让观众觉得"完美"、"梦幻"、"令人心动"
- ⚠️ 重要：根据角色个性选择合适的描述词汇，不要千篇一律

**如果是自然真实类**（现实主义剧、文艺片）：
- 五官标准：追求清秀自然，有特点，不刻意追求完美
- 皮肤标准：可以有雀斑，毛孔细腻但可见，肤色自然健康
- 发质标准：可以略粗但富有光泽，自然蓬松，有生活感
- 身材标准：7.5-8头身，比例自然协调
- 真实感来源：适度的美学瑕疵（雀斑、发质略粗、肤色略深、微小疤痕）
- 整体效果：让观众觉得"真实"、"自然"、"有生活气息"
- ⚠️ 重要：在真实的基础上突出角色的独特气质

**如果是接地气类**（生活剧、喜剧、农村剧）：
- 五官标准：追求普通亲切，有辨识度，不追求精致
- 皮肤标准：可以略粗糙但健康，肤色自然偏深，有生活痕迹
- 发质标准：普通自然，实用为主
- 身材标准：7-7.5头身，比例正常
- 真实感来源：明显的生活痕迹（但要干净整洁、体现自尊）
- 整体效果：让观众觉得"亲切"、"接地气"、"像身边的人"
- ⚠️ 重要：通过细节展现角色的性格和生活状态

### 3.2 头身比例判断
[根据角色定位和剧本类型选择合适的头身比]
- 角色定位：主角/配角/特殊角色？
- 剧本类型：极致美型类/自然真实类/接地气类？
- 特殊要求：剧本是否有明确要求（如矮胖、高挑）？
- 判断结果：选择X头身

### 3.3 外貌描述创作
[基于选定的美学标准，创作外貌描述，融入视觉标签，包含头身比例]

⚠️ **个性化要求**（最重要！）：
- 在符合美学标准的前提下，突出角色的个性特征
- 不要机械地套用标准中的词汇，要根据角色选择合适的描述
- 每个角色都应该有自己独特的外貌特点
- 即使是同类型的角色，也要有不同的侧重点

---

## 第四步：服化道设计（由服化道设计师完成）

### 4.1 服装设计思路

请根据以下维度进行专业分析：

**分析维度**：

1. **时代背景分析**：
   - 这个时代的服装有什么特点？（分析时代特征，但不要照搬）
   - 这个时代的审美是什么？
   - **影视化处理**：在符合时代的基础上，进行艺术化美化

2. **社会阶层与美学平衡**：
   - 富裕阶层：衣服精致、考究、有设计感
   - 中产阶层：衣服材质更好、款式更新
   - 底层角色：衣服可能有补丁、褪色、磨损，但要体现"清贫但自尊"
   - **关键原则**：即使是贫困角色，也要通过细节展现自尊和美感
     * ✅ "衣服虽旧但洗得干净，裤线笔直"
     * ✅ "鞋子虽褪色但擦拭干净，鞋带系得整齐"
     * ❌ "衣衫褴褛，破烂不堪，邋遢丑陋"

3. **性格与故事体现**：
   - 如何通过服装细节展现角色的性格和故事？
   - 勤劳节俭：手工缝制的补丁、针脚细密
   - 自尊自爱：衣服虽旧但整洁、裤线笔直、鞋子擦拭干净
   - 倔强坚韧：背部挺直、衣服穿着利落、腰带系得牢固
   - **美学原则**：通过细节展现"清贫但自尊"，而不是"邋遢丑陋"

### 4.2 服装描述草稿

[基于以上分析，创作服装描述，必须包含以下6个维度的具体细节]

⚠️ **个性化要求**（最重要！）：
- 参考示例的细节程度，但要根据角色创造独特的描述
- 不要直接套用示例中的具体内容
- 要根据角色的性格、社会阶层、时代背景创造合适的服装
- 每个角色的服装都应该有自己的特点和故事

**必须包含的6个维度**（每个维度都要有具体细节）：

1. **材质与纹理**（必须包含）：
   - 要求：具体说明材质成分、纹理结构、质感描述
   - 参考细节程度："100%天然棉布，斜纹结构，哑光质感"
   - ⚠️ 不要直接套用，要根据角色创造独特的材质描述

2. **版型与剪裁**（必须包含）：
   - 要求：具体说明版型风格、尺寸细节、剪裁工艺
   - 参考细节程度："宽松落肩版型，肩线略低，领口1cm明线包边"
   - ⚠️ 不要直接套用，要根据角色创造独特的版型描述

3. **色彩与花纹**（必须包含）：
   - 要求：具体说明色调、色彩效果、花纹样式
   - 参考细节程度："低饱和度雾霾蓝，色织渐变效果，复古色泽"
   - ⚠️ 不要直接套用，要根据角色创造独特的色彩描述

4. **设计细节**（必须包含）：
   - 要求：具体说明纽扣/拉链、口袋、装饰元素
   - 参考细节程度："圆形树脂扣，竖纹肌理；隐藏式插袋，明线装饰"
   - ⚠️ 不要直接套用，要根据角色创造独特的设计细节

5. **新旧程度与细节**（必须包含）：
   - 要求：具体说明整体状态、具体痕迹、清洁程度
   - 参考细节程度："略显陈旧，领口袖口褪色，但洗得干净，熨得平整"
   - ⚠️ 不要直接套用，要根据角色创造独特的新旧描述

6. **配饰与整体搭配**（必须包含）：
   - 要求：具体说明鞋子、腰带、其他配饰、整体搭配
   - 参考细节程度："黑色布鞋，略有磨损但擦拭干净；手工编织腰带，宽2cm"
   - ⚠️ 不要直接套用，要根据角色创造独特的配饰描述

**根据剧本类型调整细节程度**：

**如果是极致美型类**（女频、偶像剧、言情剧）：
- 材质：更高级（如"真丝"、"高支棉"、"羊绒混纺"）
- 设计细节：更精致（如"手工刺绣"、"蕾丝边"、"珍珠扣"、"精致滚边"）
- 新旧程度：通常是全新或九成新
- 整体效果：精致、考究、有品味

**如果是自然真实类**（现实主义剧、文艺片）：
- 材质：更普通（如"棉布"、"涤卡"、"混纺"）
- 设计细节：适中（如"简单的纽扣"、"基本的剪裁"、"实用的口袋"）
- 新旧程度：可以略显陈旧，但要干净整洁
- 整体效果：真实、生活化、有质感

**如果是接地气类**（生活剧、喜剧、农村剧）：
- 材质：更便宜（如"棉布"、"化纤"、"粗布"）
- 设计细节：简单（如"塑料扣"、"简单剪裁"、"实用为主"）
- 新旧程度：可以有明显的使用痕迹，但要体现自尊（干净、整洁）
- 整体效果：朴素、实用、亲切

**专业原则**：
- 通过每个细节讲述角色的故事，而不是简单罗列
- **影视化美学**：不要过度写实，要有视觉吸引力和设计感
- 即使是贫困角色，也要"美得真实"：通过色彩搭配、剪裁线条、装饰细节展现美感
- 想象这是电影画面：要让观众觉得美、有质感、有层次
- **重要**：参考示例的细节程度，但要根据角色创造独特的描述，不要机械套用

</思考过程>

<最终结果>

【主体人物】
[输出最终的主体人物描述]

【外貌特征】
[输出最终的外貌描述，不要包含任何提醒或说明文字，只输出纯粹的描述内容]

【服饰造型】
[输出最终的服饰描述，不要包含任何提醒或说明文字，只输出纯粹的描述内容]

</最终结果>
\`\`\`

**核心要求**：
- ✅ 必须输出完整的思考过程
- ✅ 每个步骤都要有具体的分析和创作
- ✅ 不要套用固定模板
- ✅ 要根据剧本内容创造独特的设计
- ❌ 不要直接跳到最终结果
`;
}

/**
 * 解析补充响应
 */
function parseSupplementResponse(content: string): Partial<CharacterRef> {
  try {
    console.log('[解析响应] 原始内容:', content);

    // 🆕 优先尝试提取思维链格式的<最终结果>
    const finalResultMatch = content.match(/<最终结果>([\s\S]*?)<\/最终结果>/);
    if (finalResultMatch) {
      console.log('[解析响应] 检测到思维链格式，提取<最终结果>');
      const finalResult = finalResultMatch[1];

      // 提取【主体人物】【外貌特征】【服饰造型】
      const subjectMatch = finalResult.match(/【主体人物】\s*([\s\S]*?)(?=【|$)/);
      const appearanceMatch = finalResult.match(/【外貌特征】\s*([\s\S]*?)(?=【|$)/);
      const clothingMatch = finalResult.match(/【服饰造型】\s*([\s\S]*?)(?=【|$)/);

      const subject = subjectMatch ? subjectMatch[1].trim() : '';
      const appearanceDesc = appearanceMatch ? appearanceMatch[1].trim() : '';
      const clothingDesc = clothingMatch ? clothingMatch[1].trim() : '';

      // 组合成完整的appearance
      const appearance = [
        subject ? `【主体人物】\n${subject}` : '',
        appearanceDesc ? `\n\n【外貌特征】\n${appearanceDesc}` : '',
        clothingDesc ? `\n\n【服饰造型】\n${clothingDesc}` : '',
      ].filter(Boolean).join('');

      console.log('[解析响应] 提取的appearance:', appearance);

      return {
        appearance: appearance || undefined,
      };
    }

    // 🔧 兼容旧格式：提取 JSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.warn('[解析响应] 无法从响应中提取 JSON 或思维链格式');
      throw new Error('无法从响应中提取有效内容');
    }

    const jsonStr = jsonMatch[1] || jsonMatch[0];
    const parsed = JSON.parse(jsonStr);

    // 确保forms数组中的每个form都有id
    if (parsed.forms && Array.isArray(parsed.forms)) {
      parsed.forms = parsed.forms.map((form: any, index: number) => ({
        ...form,
        id: form.id || `form-${Date.now()}-${index}`,
      }));
    }

    return parsed;
  } catch (error) {
    console.error('[解析响应] 解析补充响应失败:', error);
    return {};
  }
}


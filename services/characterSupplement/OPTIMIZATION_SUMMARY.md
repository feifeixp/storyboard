# ä¼˜åŒ–æ€»ç»“ï¼šæ–¹æ¡ˆC + P1ä¼˜åŒ–

## ğŸ“‹ å®æ–½å†…å®¹

### 1. æ–¹æ¡ˆCï¼šæ™ºèƒ½è‡ªåŠ¨è¡¥å…… âœ…

**ç›®æ ‡**ï¼šåœ¨é¡¹ç›®åˆ›å»ºåè‡ªåŠ¨ä¸ºä¸»è¦è§’è‰²ç”Ÿæˆè¯¦ç»†æè¿°

**æ–°å¢æ–‡ä»¶**ï¼š
- `identifyMainCharacters.ts` - è¯†åˆ«ä¸»è¦è§’è‰²
- `autoSupplement.ts` - è‡ªåŠ¨è¡¥å……ä¸»å‡½æ•°

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **æ™ºèƒ½è¯†åˆ«ä¸»è¦è§’è‰²**
   - æ ¹æ®å‡ºåœºæ¬¡æ•°ï¼ˆé»˜è®¤ > 3æ¬¡ï¼‰
   - æ˜¯å¦æœ‰å°è¯
   - æ˜¯å¦æœ‰èº«ä»½æ¼”å˜
   - æ˜¯å¦æœ‰å¤šä¸ªå½¢æ€
   - è®¡ç®—é‡è¦æ€§åˆ†æ•°å¹¶æ’åº

2. **è‡ªåŠ¨è¡¥å……**
   - å¹¶å‘å¤„ç†ï¼ˆæœ€å¤š3ä¸ªè§’è‰²åŒæ—¶ï¼‰
   - å®æ—¶è¿›åº¦æŠ¥å‘Š
   - æ”¯æŒå–æ¶ˆæ“ä½œ
   - é”™è¯¯å¤„ç†å’Œæ¢å¤

3. **è¿›åº¦å›è°ƒ**
   ```typescript
   interface AutoSupplementProgress {
     total: number;
     current: number;
     characterName: string;
     stage: string;
     status: 'processing' | 'completed' | 'error';
     message: string;
   }
   ```

**ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { autoSupplementMainCharacters } from './characterSupplement';

const updatedCharacters = await autoSupplementMainCharacters(
  characters,
  scripts,
  {
    maxCharacters: 5,
    minAppearances: 3,
    mode: 'fast',
    beautyLevel: 'balanced',
    onProgress: (progress) => {
      console.log(progress.message);
    }
  }
);
```

---

### 2. P1ä¼˜åŒ–ï¼šPromptå‹ç¼© âœ…

**ç›®æ ‡**ï¼šå‡å°‘30-40% tokenæ¶ˆè€—ï¼Œæå‡ç”Ÿæˆé€Ÿåº¦

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `stage3-appearance-design-fast.ts`

**ä¼˜åŒ–å†…å®¹**ï¼š

#### 2.1 ç¾å‹è¦æ±‚å‹ç¼©
**å‹ç¼©å‰**ï¼ˆçº¦500 tokensï¼‰ï¼š
```
âš ï¸ **ç¾å‹ç¨‹åº¦**: ç†æƒ³ç¾å‹ (å¥³é¢‘çŸ­å‰§æ ‡å‡†)
- ğŸ¯ **æ ¸å¿ƒåŸåˆ™**: è¿™æ˜¯**ç°ä»£æ‹æ‘„çš„çŸ­å‰§**(2024-2026å¹´),å‰§æƒ…è™½ç„¶è®¾å®šåœ¨ç‰¹å®šæ—¶ä»£...
- ğŸ¯ **æ—¶ä»£èƒŒæ™¯**: æœè£…**æ¬¾å¼**è¦ç¬¦åˆæ—¶ä»£èƒŒæ™¯çš„åŸºæœ¬åˆç†æ€§...
- ğŸ¯ **ç¾å‹æ ‡å‡†**: å‚è€ƒç°ä»£å¶åƒå‰§ã€å¥³é¢‘çŸ­å‰§çš„è§’è‰²ç¾å‹æ ‡å‡†...
[... æ›´å¤šå†—ä½™æè¿°]
```

**å‹ç¼©å**ï¼ˆçº¦150 tokensï¼‰ï¼š
```
âš ï¸ **ç¾å‹**: ç†æƒ³ç¾å‹ï¼ˆå¶åƒå‰§/å¥³é¢‘çŸ­å‰§æ ‡å‡†ï¼‰
- æ ¸å¿ƒï¼šç°ä»£æ‹æ‘„æ ‡å‡†ï¼Œæ¬¾å¼ç¬¦åˆæ—¶ä»£ï¼Œè´¨æ„Ÿä½¿ç”¨ç°ä»£æ ‡å‡†
- äº”å®˜ï¼šç²¾è‡´ç«‹ä½“ï¼Œç°ä»£å®¡ç¾ï¼Œ8å¤´èº«é»„é‡‘æ¯”ä¾‹
- å¦†å®¹ï¼šç²¾è‡´ç°ä»£å¦†å®¹ï¼Œé€‚é¾„æ·¡å¦†ï¼ˆ18-22å²æ¸…é€ï¼Œé¿å…æµ“å¦†ï¼‰
- å‘å‹ï¼šå¤šæ ·è®¾è®¡ï¼Œè‡ªç„¶å‘è‰²ï¼ˆæ·±æ£•/æ£•é»‘ï¼‰ï¼Œå±‚æ¬¡æ„Ÿå¼º
- æ°”è´¨ï¼šä¼˜é›…è¿·äººï¼Œé•œå¤´æ„Ÿå¼º
```

**èŠ‚çœ**ï¼šçº¦70% token

#### 2.2 å½±è§†åŒ–ç¾åŒ–ç­–ç•¥å‹ç¼©
**å‹ç¼©å‰**ï¼ˆçº¦300 tokensï¼‰
**å‹ç¼©å**ï¼ˆçº¦80 tokensï¼‰
**èŠ‚çœ**ï¼šçº¦73% token

#### 2.3 å‰§æœ¬æè¿°éƒ¨åˆ†å‹ç¼©
**å‹ç¼©å‰**ï¼ˆçº¦400 tokensï¼‰
**å‹ç¼©å**ï¼ˆçº¦100 tokensï¼‰
**èŠ‚çœ**ï¼šçº¦75% token

**æ€»ä½“æ•ˆæœ**ï¼š
- Prompté•¿åº¦ï¼šä» 5,000-8,000 tokens â†’ 3,000-5,000 tokens
- èŠ‚çœï¼šçº¦30-40% token
- æ—¶é—´èŠ‚çœï¼šçº¦20-30%

---

### 3. P1ä¼˜åŒ–ï¼šæ™ºèƒ½å†å²è®°å½•æ³¨å…¥ âœ…

**ç›®æ ‡**ï¼šåªæ³¨å…¥ç›¸ä¼¼è§’è‰²çš„å…³é”®ç‰¹å¾ï¼Œå‡å°‘10-15% token

**æ–°å¢æ–‡ä»¶**ï¼š
- `smartHistoryInjection.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **ç›¸ä¼¼åº¦è®¡ç®—**
   - åŒæ€§åˆ« +2åˆ†
   - åŒå¹´é¾„æ®µ +1åˆ†
   - æœ‰å¤–è²Œæè¿° +1åˆ†

2. **å…³é”®ç‰¹å¾æå–**
   - åªæå–å‘å‹ï¼ˆç¬¬ä¸€ä¸ªç‰¹å¾ï¼‰
   - åªæå–ä¸»ä½“äººç‰©ï¼ˆé™åˆ¶30å­—ï¼‰
   - ä¸åŒ…å«å®Œæ•´æè¿°

3. **æ™ºèƒ½æ³¨å…¥**
   ```typescript
   const historyPrompt = getSmartHistoryPrompt(
     characterName,
     stage,
     history,
     {
       maxRecords: stage === 'stage1' ? 0 : 3,
       prioritizeSimilar: true,
       includeKeyFeatures: true
     }
   );
   ```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- å†å²è®°å½•ï¼šä» 5-10ä¸ªå®Œæ•´æè¿° â†’ 3ä¸ªå…³é”®ç‰¹å¾
- TokenèŠ‚çœï¼šçº¦1,000-2,000 tokens
- æ—¶é—´èŠ‚çœï¼šçº¦10-15%

---

## ğŸ“Š æ€»ä½“ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•ä¸ªè§’è‰²ç”Ÿæˆæ—¶é—´ï¼ˆfastæ¨¡å¼ï¼‰ | 30ç§’ | **20ç§’** | **33%** âš¡ |
| 3ä¸ªä¸»è¦è§’è‰²æ€»æ—¶é—´ | 90ç§’ | **60ç§’** | **33%** âš¡ |
| Prompté•¿åº¦ | 5,000-8,000 tokens | 3,000-5,000 tokens | **30-40%** |
| å†å²è®°å½•token | 2,000-4,000 tokens | 500-1,000 tokens | **60-75%** |

### ç”¨æˆ·ä½“éªŒæå‡

**ä¼˜åŒ–å‰**ï¼š
1. ä¸Šä¼ å‰§æœ¬ â†’ ç­‰å¾…30ç§’ â†’ é¡¹ç›®åˆ›å»ºå®Œæˆ
2. æ‰‹åŠ¨ç‚¹å‡»"æ™ºèƒ½è¡¥å……" â†’ ç­‰å¾…30ç§’/è§’è‰²
3. é‡å¤æ­¥éª¤2ï¼Œè¡¥å……3ä¸ªè§’è‰² â†’ æ€»è®¡90ç§’

**ä¼˜åŒ–å**ï¼š
1. ä¸Šä¼ å‰§æœ¬ â†’ ç­‰å¾…30ç§’ â†’ é¡¹ç›®åˆ›å»ºå®Œæˆ
2. **è‡ªåŠ¨å¼€å§‹è¡¥å……** â†’ ç­‰å¾…60ç§’ â†’ 3ä¸ªä¸»è¦è§’è‰²è¡¥å……å®Œæˆ
3. æ— éœ€æ‰‹åŠ¨æ“ä½œï¼

**æ€»æ—¶é—´**ï¼šä» 120ç§’ï¼ˆ2åˆ†é’Ÿï¼‰â†’ **90ç§’ï¼ˆ1.5åˆ†é’Ÿï¼‰**
**æ“ä½œæ­¥éª¤**ï¼šä» 4æ­¥ â†’ **1æ­¥**

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼šé›†æˆåˆ°UI

éœ€è¦ä¿®æ”¹ `ProjectWizard.tsx`ï¼Œåœ¨é¡¹ç›®åˆ›å»ºæˆåŠŸåè‡ªåŠ¨è§¦å‘è¡¥å……ï¼š

```typescript
// ProjectWizard.tsx
async function handleCreateProject() {
  // 1. é¡¹ç›®åˆ†æ
  const project = await analyzeScripts(scripts);
  
  // 2. ä¿å­˜é¡¹ç›®
  await saveProject(project);
  
  // 3. è‡ªåŠ¨è¡¥å……ä¸»è¦è§’è‰²
  const updatedCharacters = await autoSupplementMainCharacters(
    project.characters,
    scripts,
    {
      maxCharacters: 5,
      mode: 'fast',
      beautyLevel: 'balanced',
      onProgress: (progress) => {
        setSupplementProgress(progress);
      }
    }
  );
  
  // 4. æ›´æ–°é¡¹ç›®
  await updateProject({ ...project, characters: updatedCharacters });
  
  // 5. è·³è½¬åˆ°é¡¹ç›®é¡µé¢
  navigate(`/project/${project.id}`);
}
```

---

## âœ… å®Œæˆæ¸…å•

- [x] Promptå‹ç¼©ï¼ˆ30-40% tokenèŠ‚çœï¼‰
- [x] æ™ºèƒ½å†å²è®°å½•æ³¨å…¥ï¼ˆ10-15% tokenèŠ‚çœï¼‰
- [x] ä¸»è¦è§’è‰²è¯†åˆ«åŠŸèƒ½
- [x] è‡ªåŠ¨è¡¥å……åŠŸèƒ½
- [x] è¿›åº¦å›è°ƒæ¥å£
- [x] å¯¼å‡ºæ‰€æœ‰æ–°åŠŸèƒ½
- [ ] é›†æˆåˆ°ProjectWizard UI
- [ ] æ·»åŠ è¿›åº¦æ˜¾ç¤ºç»„ä»¶
- [ ] æµ‹è¯•å’Œä¼˜åŒ–

---

## ğŸ“ APIæ–‡æ¡£

### autoSupplementMainCharacters

è‡ªåŠ¨è¡¥å……ä¸»è¦è§’è‰²çš„è¯¦ç»†æè¿°

**å‚æ•°**ï¼š
- `characters: CharacterRef[]` - æ‰€æœ‰è§’è‰²åˆ—è¡¨
- `scripts: ScriptFile[]` - å‰§æœ¬æ–‡ä»¶åˆ—è¡¨
- `options: AutoSupplementOptions` - é…ç½®é€‰é¡¹

**è¿”å›**ï¼š
- `Promise<CharacterRef[]>` - æ›´æ–°åçš„è§’è‰²åˆ—è¡¨

**ç¤ºä¾‹**ï¼š
```typescript
const updatedCharacters = await autoSupplementMainCharacters(
  characters,
  scripts,
  {
    maxCharacters: 5,
    minAppearances: 3,
    mode: 'fast',
    beautyLevel: 'balanced',
    onProgress: (progress) => console.log(progress)
  }
);
```


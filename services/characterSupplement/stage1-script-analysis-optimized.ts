/**
 * 阶段1: 剧本分析 - 优化版
 * 🆕 强化格式约束,防止LLM跳过步骤
 */

import type { CharacterRef } from '../../types';
import type { ScriptFile } from '../../types/project';
import type { MissingField } from '../characterCompleteness';

export function buildStage1Prompt(
  character: CharacterRef,
  scripts: ScriptFile[],
  missingFields?: MissingField[]
): string {
  const scriptContent = scripts
    .map((s, index) => `【第${s.episodeNumber || index + 1}集】\n${s.content}`)
    .join('\n\n');

  return `# 阶段1: 剧本分析

你是专业剧本分析师。请严格按照步骤执行,每步必须输出JSON结果。

🚨🚨🚨 **核心原则:基于剧本的角色分析** 🚨🚨🚨

⚠️ **格式要求(必须遵守)**:
1. 必须严格按照【Step 1.X 执行中】格式输出
2. 必须包含"思考过程"和"输出结果"
3. 必须基于剧本内容进行分析
4. 必须包含所有必需字段
5. 必须输出具体内容,不能是占位符

❌ **禁止**:
1. 禁止跳过任何步骤
2. 禁止输出占位符或说明文字
3. 禁止省略必需字段
4. 禁止直接输出最终JSON
5. 禁止脱离剧本内容进行臆测

---

## 角色信息

**角色名称**: ${character.name}
**已有信息**: ${character.appearance ? `外观${character.appearance.length}字` : '无外观描述'}

---

## 剧本内容

${scriptContent.substring(0, 3000)}${scriptContent.length > 3000 ? '...(剧本过长,已截取前3000字)' : ''}

---

## 执行步骤

【Step 1.1 执行中】时代背景分析

思考过程：
分析剧本的时代背景(30字内):
1. 剧本发生在什么时代?
2. 角色的性别、年龄段?
3. 角色的职业或身份?

⚠️ **请思考**：
1. 如果是修仙/玄幻/仙侠世界的角色，他们的外貌年龄通常是多少？
2. 剧本中提到的年龄是"实际年龄"还是"外貌年龄"？
3. 对于修仙者，即使实际年龄很大（如500岁），外貌通常保持在多少岁？

💡 提示：修仙者的外貌年龄通常保持在20-35岁之间

输出结果：
\`\`\`json
{
  "era": "时代背景",
  "gender": "男/女",
  "ageGroup": "儿童/少年/青年/中年/老年",
  "specificAge": 20,  // 🆕 具体年龄(外貌年龄,如18、20、25等),根据剧本推断,用于生图模型
  "occupation": "职业或身份"
}
\`\`\`

---

【Step 1.2 执行中】角色行为分析

思考过程：
分析角色的关键行为(30字内):
1. 角色在剧本中的关键行为有哪些?
2. 这些行为体现了什么性格特点?

输出结果：
\`\`\`json
{
  "keyBehaviors": ["行为1", "行为2", "行为3"],
  "personalityTraits": ["性格1", "性格2", "性格3"]
}
\`\`\`

---

【Step 1.3 执行中】角色定位分析

思考过程：
分析角色的定位(30字内):
1. 角色是主角/配角/反派?
2. 角色的社会阶层是什么?

输出结果：
\`\`\`json
{
  "role": "主角/配角/反派",
  "socialClass": "富裕/中产/底层"
}
\`\`\`

---

【Step 1.4 执行中】剧本类型分析

思考过程：
分析剧本类型(50字内):
1. 这是什么类型的剧本?(女频言情/都市职场/历史剧等)
2. 具体题材是什么?(重生/甜宠/逆袭等)
3. 美学方向是什么?(精致优雅/自然真实/接地气等)

输出结果：
\`\`\`json
{
  "category": "剧本类型",
  "genre": "具体题材",
  "aestheticDirection": "美学方向",
  "reasoning": "判断理由"
}
\`\`\`

---

【Step 1.5 执行中】场景判断

思考过程：
分析角色主要出现的场景(30字内):
1. 角色主要在什么场景活动?(日常/办公/社交/活动/特殊)
2. 剧本中有哪些具体场景?(如在家、晚宴、运动等)

输出结果：
\`\`\`json
{
  "mainScene": "日常/办公/社交/活动/特殊",
  "specificScenes": ["具体场景1", "具体场景2"]
}
\`\`\`

---

【Step 1.6 执行中】美学风格判断

思考过程：
判断角色应该呈现的美学风格(30字内):
1. 基于剧本类型,应该用什么美学风格?(真实/美化/华丽/时尚)
2. 这个剧本追求"影视剧美学"还是"纪实美学"?

**美学风格说明**:
- 真实: 历史准确、朴素自然、生活化
- 美化: 适度美化、符合影视审美、精致
- 华丽: 最大化美化、影视化创作、唯美
- 时尚: 追求潮流、时尚感强

输出结果：
\`\`\`json
{
  "aestheticStyle": "真实/美化/华丽/时尚",
  "reasoning": "判断理由"
}
\`\`\`

---

【Step 1.7 执行中】季节判断

思考过程：
判断剧本发生的季节(20字内):
1. 剧本中有明确的季节描述吗?
2. 如果没有,根据剧情推断是什么季节?

输出结果：
\`\`\`json
{
  "season": "春季/夏季/秋季/冬季/通用",
  "reasoning": "判断理由"
}
\`\`\`

---

【Step 1.8 执行中】剧本服饰描述提取

🚨🚨🚨 **核心原则:提取剧本中已有的服饰描述** 🚨🚨🚨

思考过程：
仔细搜索剧本中关于"${character.name}"的外观描述(50字内):
1. 剧本中是否有关于该角色的服饰描述?(如"身穿黑色长袍"、"一袭红衣"等)
2. 剧本中是否有关于该角色的发型描述?(如"长发披肩"、"束发高冠"等)
3. 剧本中是否有关于该角色的妆容描述?(如"浓妆艳抹"、"素面朝天"等)
4. 剧本中是否有其他外观描述?(如"腰系玉带"、"手持折扇"等)

⚠️ **重要**:
- 如果剧本中有描述,必须原文提取,不要改写!
- 如果剧本中没有描述,返回空字符串""
- 不要臆测或创造,只提取剧本中明确写出的内容

输出结果：
\`\`\`json
{
  "costumeDescription": "剧本中的服饰描述(如果有)",
  "hairDescription": "剧本中的发型描述(如果有)",
  "makeupDescription": "剧本中的妆容描述(如果有)",
  "otherDescription": "剧本中的其他外观描述(如果有)"
}
\`\`\`

---

【Step 1.9 执行中】时间线与身份演变分析

思考过程：
仔细阅读整部剧本，判断角色是否存在**多个时间线或人生阶段**（60字内）：
1. 剧本中是否有"重生"、"穿越"、"前世"、"回忆"、"年幼时"等时间线跨越标志？
2. 如果有，各阶段角色的年龄、时代、身份和处境分别是什么？
3. 如何通过剧本中的关键词/事件区分各阶段场景？（提取3-5个识别关键词）

⚠️ **特别提醒**：
- 如果剧本是**重生/穿越/前世**类型，必须识别出至少两个时间线阶段
- 每个阶段的年龄必须基于剧本明确描述，不可臆测
- 若剧本是**单时间线**（无跨越），直接输出空数组 []

输出结果：
\`\`\`json
[
  {
    "label": "前世",
    "estimatedAge": 32,
    "era": "20世纪90年代初农村",
    "identityState": "被逼嫁家暴男，饱受折磨，32岁惨死",
    "markers": ["逼嫁", "被打", "血泊", "雨夜", "惨死", "前世"]
  },
  {
    "label": "重生后",
    "estimatedAge": 22,
    "era": "1993年夏农村",
    "identityState": "重生回22岁，携记忆逆袭改变命运",
    "markers": ["重生", "这一世", "带着记忆", "重来一次", "不会再"]
  }
]
\`\`\`
（单时间线剧本输出空数组 [] ）

---

【最终输出】

⚠️ **重要**: 必须合并所有步骤的结果!

\`\`\`json
{
  "basicInfo": {
    "era": "...",
    "gender": "...",
    "ageGroup": "...",
    "specificAge": 20,  // 🆕 具体年龄
    "occupation": "..."
  },
  "behaviorAnalysis": {
    "keyBehaviors": [...],
    "personalityTraits": [...]
  },
  "characterPosition": {
    "role": "...",
    "socialClass": "..."
  },
  "scriptType": {
    "category": "...",
    "genre": "...",
    "aestheticDirection": "...",
    "reasoning": "..."
  },
  "sceneInfo": {
    "mainScene": "...",
    "specificScenes": [...]
  },
  "aestheticStyle": {
    "style": "...",
    "reasoning": "..."
  },
  "seasonInfo": {
    "season": "...",
    "reasoning": "..."
  },
  "scriptAppearanceDescription": {
    "costumeDescription": "...",
    "hairDescription": "...",
    "makeupDescription": "...",
    "otherDescription": "..."
  },
  "timelinePhases": [
    {
      "label": "前世",
      "estimatedAge": 32,
      "era": "...",
      "identityState": "...",
      "markers": ["关键词1", "关键词2"]
    }
  ],
  "thinking": {
    "step1_1": "Step 1.1的思考过程",
    "step1_2": "Step 1.2的思考过程",
    "step1_3": "Step 1.3的思考过程",
    "step1_4": "Step 1.4的思考过程",
    "step1_5": "Step 1.5的思考过程",
    "step1_6": "Step 1.6的思考过程",
    "step1_7": "Step 1.7的思考过程",
    "step1_8": "Step 1.8的思考过程",
    "step1_9": "Step 1.9的思考过程（是否有多时间线及判断理由）"
  }
}
\`\`\`

⚠️ **再次提醒**:
1. 必须按顺序执行每个【Step X.X 执行中】(包括Step 1.8 和 Step 1.9)
2. 每步都要有"思考过程"和"输出结果"
3. 最后才输出【最终输出】
4. Step 1.8必须提取剧本中的服饰描述,不要臆测!
5. Step 1.9必须分析是否有多个时间线/人生阶段；单时间线输出空数组 []，不可省略该字段!

请开始执行!`;
}


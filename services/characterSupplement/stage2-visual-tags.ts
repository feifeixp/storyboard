/**
 * 阶段2: 视觉标签设计
 * 参考分镜思维链架构
 */

import type { Stage1ScriptAnalysis, BeautyLevel } from './types';
import { getCharacterHistory, formatHistoryForPrompt } from './historyManager';

export function buildStage2Prompt(
  stage1: Stage1ScriptAnalysis,
  beautyLevel: BeautyLevel = 'balanced'
): string {

  // 🆕 获取历史记录
  const history = getCharacterHistory();
  const historyPrompt = formatHistoryForPrompt(history, 3);

  // 🆕 根据美型程度生成不同的要求 (结构化框架,不硬编码具体内容)
  const beautyRequirements = beautyLevel === 'idealized' ? `

⚠️ **美型程度**: 理想美型 (女频短剧标准)
- 🎯 **核心原则**: 这是**现代拍摄的短剧**(2024-2026年),剧情虽然设定在特定时代,但角色的**妆容、发质、服装质感、剪裁**都使用**现代标准**
- 🎯 **时代背景**: 服装**款式**要符合时代背景的基本合理性,但**质感、剪裁、搭配**使用现代标准,**不限制美型程度和妆容的精致度**
- 🎯 **美型标准**: 参考现代偶像剧、女频短剧的角色美型标准,追求高颜值、高精致度、强镜头感
- **五官**: 注重五官的精致度和立体感,符合现代偶像剧审美
- **妆容**: 精致的现代妆容,注重眼妆和唇妆的设计,提升上镜效果
- **发型**: 考虑多种发型设计方案(如披发、半扎发、编发、盘发等),选择最能体现角色特质的设计,注重层次感、造型感和发质光泽
- **气质**: 优雅迷人,有强烈的视觉吸引力和镜头感,符合偶像剧审美
- **设计感**: 发型、服饰、配饰等要有独特的设计细节,提升整体造型的精致度和时尚感
- **特色**: 通过细节设计(如发型层次、配饰点缀、色彩搭配等)增加角色的辨识度和记忆点
` : beautyLevel === 'balanced' ? `

⚠️ **美型程度**: 平衡美型
- 在真实感和美感之间取得平衡,适度提升角色的视觉吸引力
- 符合时代背景,但略微优化五官、皮肤、发型等细节
- 适度增加设计感,但不过度华丽
` : `

⚠️ **美型程度**: 真实朴素
- 优先考虑真实感,不刻意美化
- 符合时代背景和角色的社会阶层、生活环境
`;

  return `# 阶段2: 视觉标签设计

你是一位资深视觉设计师。请像专业设计师一样思考，为这个角色设计视觉标签。

${historyPrompt}

🚨🚨🚨 **核心原则:基于阶段1的视觉标签设计** 🚨🚨🚨

⚠️ **格式要求(必须遵守)**:
1. 必须严格按照【Step 2.X 执行中】格式输出
2. 必须包含"思考过程"和"输出结果"
3. 必须基于阶段1的分析结果设计视觉标签
4. 必须包含所有必需字段
5. 必须输出具体内容,不能是占位符

❌ **禁止**:
1. 禁止跳过任何步骤
2. 禁止输出占位符或说明文字
3. 禁止省略必需字段
4. 禁止直接输出最终JSON
5. 禁止脱离阶段1的分析结果独立设计

---

## 🚨 输入信息(来自阶段1 - 必须基于)

**重要**: 视觉标签设计必须基于阶段1的分析结果!如果不基于阶段1,设计将与角色定位不符!

### 角色基本信息(必须参考)
- 时代背景: ${stage1.basicInfo.era}
- 性别: ${stage1.basicInfo.gender}
- 年龄段: ${stage1.basicInfo.ageGroup}
- 职业: ${stage1.basicInfo.occupation || '未知'}

### 性格特点(必须参考)
${stage1.behaviorAnalysis.personalityTraits.map(t => `- ${t}`).join('\n')}

### 角色定位(必须参考)
- 角色类型: ${stage1.characterPosition.role}
- 社会阶层: ${stage1.characterPosition.socialClass}

### 剧本风格(必须参考)
- 剧本类型: ${stage1.scriptType.category}
- 题材: ${stage1.scriptType.genre}
- 美学方向: ${stage1.scriptType.aestheticDirection}
${beautyRequirements}

⚠️ **强制要求**:
1. 必须基于上述性格特点设计视觉标签
2. 必须基于角色定位确定视觉风格
3. 必须基于剧本风格选择美学方向
4. 禁止脱离阶段1的分析结果独立设计

---

## 执行步骤

【Step 2.1 执行中】角色理解与视觉定位

思考过程（简洁输出，不要展开）：
1. 角色理解：这个角色是什么样的人？应该给观众什么感觉？
2. 视觉定位：什么样的视觉形象能体现角色性格和魅力？
3. 美学方向：如何结合"${stage1.scriptType.aestheticDirection}"设计视觉标签？

输出结果（文本格式，不要用JSON）：
- 角色理解：[你对这个角色的理解]
- 视觉方向：[视觉设计方向]
- 美学策略：[如何平衡真实与美]

⚠️ **注意**：这只是Step 2.1的思考结果，不要输出JSON！继续执行Step 2.2！

---

【Step 2.2 执行中】视觉标签设计

🚨 **覆盖维度硬要求**（必须全部覆盖，避免偏科）：
1. **脸部特征**：眼睛、五官、肤色等（至少1个标签）
2. **发型轮廓**：发型、发色、发质等（至少1个标签）
3. **色彩基调**：整体色彩风格、主色调等（至少1个标签）
4. **材质工艺**：服装材质、工艺细节等（至少1个标签）
5. **辨识度细节**：独特的记忆点、特色细节等（至少1个标签）

⚠️ **避免偏科**：
- ❌ 不要只关注服装，忽略脸部特征
- ❌ 不要只关注气质，忽略具体视觉元素
- ✅ 必须覆盖以上5个维度，每个维度至少1个标签

思考过程（简洁输出）：
设计5-8个具体的视觉标签，确保覆盖以上5个维度，每个标签要：
- 具体可视化，体现性格
- 使用美学词汇，避免缺陷词汇
- 有辨识度和层次感

输出结果（文本格式，不要用JSON）：
列出5-8个视觉标签，每个标签包含：
1. 标签名称（标注所属维度：脸部/发型/色彩/材质/辨识度）
2. 具体描述
3. 为什么选择这个标签

⚠️ **注意**：这只是Step 2.2的思考结果，不要输出JSON！继续执行Step 2.3！

---

【Step 2.3 执行中】自我批判

思考过程（简洁输出）：
检查设计质量：
1. **维度覆盖检查**：是否覆盖了脸部/发型/色彩/材质/辨识度这5个维度？
2. **辨识度检查**：是否有独特的记忆点？
3. **性格体现检查**：是否体现了角色性格？
4. **美感检查**：是否有美感和吸引力？

如有问题，立即改进！

输出结果（文本格式，不要用JSON）：
- 维度覆盖：[列出已覆盖的维度，是否全部覆盖？]
- 质量检查：[是否满意？]
- 改进说明：[如果有改进，说明改进了什么]

⚠️ **注意**：这只是Step 2.3的思考结果，不要输出JSON！继续执行【最终输出】！

---

【最终输出】

🚨🚨🚨 **这是最后一步，必须输出完整的JSON！** 🚨🚨🚨

⚠️ **重要**：
- 前面的步骤只是思考过程，现在才是真正输出JSON的时候！
- 必须包含所有必需字段：positioning, visualTags, selfCritique, thinking
- 必须是完整的、可解析的JSON格式！

请将所有步骤的结果合并为一个完整的JSON：

\`\`\`json
{
  "positioning": {
    "roleUnderstanding": "...",
    "visualDirection": "...",
    "aestheticStrategy": "..."
  },
  "visualTags": [
    {
      "tag": "...",
      "description": "...",
      "meaning": "..."
    }
  ],
  "selfCritique": {
    "qualityCheck": "...",
    "improvements": "..."
  },
  "thinking": {
    "step2_1": "你在Step 2.1的思考过程",
    "step2_2": "你在Step 2.2的思考过程",
    "step2_3": "你在Step 2.3的思考过程"
  }
}
\`\`\`

请开始执行！`;
}


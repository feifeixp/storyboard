/**
 * 阶段3: 外貌描述创作 - V2版本
 * ✅ 遵循PROJECT_RULES.md原则
 * ✅ 保留提问式引导和专业判断
 * ✅ 增强流程约束(格式、步骤完整性)
 * ❌ 移除内容约束(禁止词汇列表)
 */

import type { Stage1ScriptAnalysis, Stage2VisualTags, BeautyLevel } from './types';
import { getCharacterHistory, formatHistoryForPrompt } from './historyManager';

export function buildStage3Prompt(
  stage1: Stage1ScriptAnalysis,
  stage2: Stage2VisualTags,
  beautyLevel: BeautyLevel = 'balanced'
): string {

  // 🆕 获取历史记录
  const history = getCharacterHistory();
  const historyPrompt = formatHistoryForPrompt(history, 3);

  // 🆕 根据美型程度生成不同的要求 (结构化框架,不硬编码具体内容)
  const beautyRequirements = beautyLevel === 'idealized' ? `

⚠️ **美型程度**: 理想美型 (女频短剧标准)
- 🎯 **核心原则**: 这是**现代拍摄的短剧**(2024-2026年),剧情虽然设定在特定时代,但角色的**妆容、发质、服装质感、剪裁**都使用**现代标准**
- 🎯 **时代背景**: 服装**款式**要符合时代背景的基本合理性,但**质感、剪裁、搭配**使用现代标准,**不限制美型程度和妆容的精致度**
- 🎯 **美型标准**: 参考现代偶像剧、女频短剧的角色美型标准,追求高颜值、高精致度、强镜头感
- 🎯 **年龄适配**: ⚠️ 妆容和造型必须符合角色的具体年龄。18-22岁的年轻角色要避免过于浓重的妆容(如夸张的眼线、过长的假睫毛、过于艳丽的红唇),保持清新自然的少女感
- **五官**: 注重五官的精致度和立体感,符合现代偶像剧审美
- **妆容**: 精致的现代妆容,注重眼妆和唇妆的设计,提升上镜效果。
  ⚠️ **妆容要符合角色年龄**:
  * 思考:这个妆容是否符合角色的年龄?
  * 思考:如果角色是18-22岁的年轻人,妆容是否过于浓重?
  * 思考:唇色的选择是否适合角色的性格和年龄?
  * ⚠️ 妆容浓淡要符合角色年龄,年轻角色(18-22岁)以清透淡妆为主,避免浓妆艳抹
- **发型**: 考虑多种发型设计方案(如披发、半扎发、编发、盘发等),选择最能体现角色特质的设计,注重层次感、造型感和发质光泽。
  ⚠️ **头发颜色要自然真实**：
  * 中国人的自然发色是深棕色(深棕、棕褐)或棕黑色(棕黑、深棕黑)
  * 不要使用"乌黑"、"纯黑"等不真实的描述
  * 如果剧本明确提到染发(如栗色、棕红色等),可以使用剧本中的发色
  * 描述发色时要明确标注具体颜色(如"深棕色"、"棕黑色"、"栗棕色"等)
- **气质**: 优雅迷人,有强烈的视觉吸引力和镜头感,符合偶像剧审美
- **特色**: 通过独特的发型设计、五官特征等增加角色的辨识度和记忆点
` : beautyLevel === 'balanced' ? `

⚠️ **美型程度**: 平衡美型
- 在真实感和美感之间取得平衡,适度提升角色的视觉吸引力
- 符合时代背景,但略微优化五官、皮肤、发型等细节
- 适度增加发型设计感,但不过度华丽
` : `

⚠️ **美型程度**: 真实朴素
- 优先考虑真实感,不刻意美化
- 符合时代背景和角色的社会阶层、生活环境
`;

  return `# 阶段3: 外貌描述创作

你是一位资深角色造型师。请像专业造型师一样思考，为这个角色设计外貌。

${historyPrompt}

🚨🚨🚨 **核心原则:基于阶段1和2的外貌设计** 🚨🚨🚨

⚠️ **格式要求(必须遵守)**:
1. 必须严格按照【Step 3.X 执行中】格式输出
2. 必须包含"思考过程"和"输出结果"
3. 必须基于阶段1的角色分析和阶段2的视觉标签
4. 必须包含所有必需字段
5. 必须输出具体内容,不能是占位符

❌ **禁止**:
1. 禁止跳过任何步骤
2. 禁止输出占位符或说明文字
3. 禁止省略必需字段
4. 禁止直接输出最终JSON
5. 禁止脱离前两个阶段的结果独立设计

---

## 🚨 输入信息(来自阶段1和2 - 必须基于)

**重要**: 外貌设计必须基于阶段1的角色分析和阶段2的视觉标签!如果不基于前两个阶段,设计将不协调!

### 角色基本信息(来自阶段1 - 必须参考)
- 时代背景: ${stage1.basicInfo.era}
- 性别: ${stage1.basicInfo.gender}
- 年龄段: ${stage1.basicInfo.ageGroup}
- 角色定位: ${stage1.characterPosition.role}
- 社会阶层: ${stage1.characterPosition.socialClass}
- 性格特点: ${stage1.behaviorAnalysis.personalityTraits.join('、')}

### 剧本风格(来自阶段1 - 必须参考)
- 剧本类型: ${stage1.scriptType.category}
- 题材: ${stage1.scriptType.genre}
- 美学方向: ${stage1.scriptType.aestheticDirection}
${beautyRequirements}

### 🚨 视觉标签(来自阶段2 - 必须参考)
**这是你必须参考的视觉标签,外貌设计必须体现这些标签!**

${stage2.visualTags.map(t => `- ${t.tag}: ${t.description} - ${t.meaning}`).join('\n')}

⚠️ **强制要求**:
1. 必须基于上述视觉标签设计外貌
2. 必须基于阶段1的性格特点选择外貌特征
3. 必须基于角色定位和社会阶层确定外貌风格
4. 禁止脱离前两个阶段的结果独立设计

---

## 执行步骤

【Step 3.1 执行中】设计思考

简要说明你的设计思路（50-100字）：
- 基于角色性格（${stage1.behaviorAnalysis.personalityTraits.join('、')}）和历史记录，我选择了什么样的外貌设计？
- 这个设计与历史记录中的角色有什么明显区别？
- 为什么这个设计适合这个角色？

输出结果（文本格式，简洁说明）：
[你的设计思路，50-100字]

⚠️ **注意**：这只是Step 3.1的思考结果，不要输出JSON！继续执行Step 3.2！

---

【Step 3.2 执行中】独特性检查 + 专业突破

🔍 **独特性检查**：
1. **独特特征1**：[具体说明第1个独特特征，为什么独特？]
2. **独特特征2**：[具体说明第2个独特特征，为什么独特？]
3. **记忆点**：如果让观众一眼记住这个角色，你会强调哪个视觉特征？为什么？

🚀 **专业突破**：
- **避免平庸**：如何避免设计的平庸化？除了最常见的选择，是否有更有特色的方案？
- **与历史记录对比**：这个设计与历史记录中的角色有什么明显区别？（脸型、发型、妆容等）
- **年龄适配检查**：妆容是否符合角色年龄？如果角色是18-22岁，妆容是否过于浓重？

输出结果（文本格式，简洁说明）：
- 独特特征1: [...]
- 独特特征2: [...]
- 记忆点: [...]
- 避免平庸: [...]
- 与历史记录对比: [...]
- 年龄适配: [...]

⚠️ **注意**：这只是Step 3.2的思考结果，不要输出JSON！继续执行【最终输出】！

---

【最终输出】

🚨🚨🚨 **这是最后一步，必须输出完整的JSON！** 🚨🚨🚨

⚠️ **格式要求**：
- 前面的步骤只是思考过程，现在才是真正输出JSON的时候！
- **必须以【最终输出】标记开始**
- 必须是完整的、可解析的JSON格式！
- JSON结构必须与下面的示例完全一致！

⚠️ **内容要求**：
- 必须输出具体的外貌描述，不能是占位符或说明文字！
- facialFeatures必须是100-150字的具体描述
- 只包含具体的视觉描述
- ❌ 严禁描述服装！

请输出JSON（与快速模式格式一致）：

\`\`\`json
{
  "hairDesign": "具体的发型描述(30-40字) - 包含发型、发色、发质",
  "eyesDesign": "具体的眼睛描述(30-40字) - 包含眼型、眼神、眼妆",
  "facialDesign": "具体的五官描述(30-40字) - 包含脸型、鼻子、嘴唇、肤色",
  "makeupDesign": "妆容描述(30-40字) - 眼妆、唇妆、底妆的整体效果",
  "uniqueFeature": "独特特征(20-30字,可选)",
  "finalDescription": {
    "mainCharacter": "中国人,${stage1.basicInfo.gender},${stage1.basicInfo.specificAge || stage1.basicInfo.ageGroup}${stage1.basicInfo.specificAge ? '岁' : ''},${stage1.basicInfo.era},8头身标准",
    "facialFeatures": "完整的外貌描述(100-150字,必须是具体的视觉描述) ⚠️ 只描述发型、五官、妆容、面部特征,不要包含服装、配饰等非外貌元素"
  }
}
\`\`\`

请开始执行！`;
}


/**
 * é¡¹ç›®åˆ†ææœåŠ¡
 * ä½¿ç”¨AIæ‰¹é‡åˆ†æå¤šé›†å‰§æœ¬ï¼Œæå–ä¸–ç•Œè§‚ã€è§’è‰²ã€åœºæ™¯ã€å‰§æƒ…å¤§çº²
 * å‚è€ƒï¼šã€Šå¯ç¤ºå½•/å±±æµ·ç»ã€‹æ·±åº¦åˆ†ææ ¼å¼
 *
 * ğŸ†• v2: æ”¯æŒåˆ†æ‰¹åˆ†æï¼ˆ20é›†ä¸€æ‰¹ï¼‰ï¼Œå®æ—¶æ˜¾ç¤ºè¿›åº¦
 */

import {
  ScriptFile,
  ProjectAnalysisResult,
  BatchAnalysisProgress,
  KeyTerm,
  SceneRef,
  EpisodeSummary,
  CharacterState,
  StoryVolume,
  Antagonist
} from '../types/project';
import { CharacterRef, CharacterForm } from '../types';

const DEFAULT_MODEL = 'google/gemini-2.0-flash-001';
const BATCH_SIZE = 20;  // æ¯æ‰¹åˆ†æ20é›†

/**
 * åˆ†æå¤šé›†å‰§æœ¬ï¼Œæå–é¡¹ç›®çº§ä¿¡æ¯
 * é‡‡ç”¨æ·±åº¦åˆ†ææ ¼å¼ï¼Œæ”¯æŒè§’è‰²å¤šå½¢æ€ã€åˆ†å·ç»“æ„ã€BOSSæ¡£æ¡ˆ
 *
 * @param scripts å‰§æœ¬æ–‡ä»¶åˆ—è¡¨
 * @param model AIæ¨¡å‹
 * @param knownCharacters å·²çŸ¥è§’è‰²ååˆ—è¡¨ï¼ˆæ¥è‡ªé¢„æ‰«ææˆ–å‰æ‰¹æ¬¡ï¼‰
 * @param knownScenes å·²çŸ¥åœºæ™¯ååˆ—è¡¨ï¼ˆæ¥è‡ªé¢„æ‰«ææˆ–å‰æ‰¹æ¬¡ï¼‰
 * @param mode æå–æ¨¡å¼ï¼šquick(å¿«é€Ÿ) | standard(æ ‡å‡†) | deep(æ·±åº¦)
 */
export async function analyzeProjectScripts(
  scripts: ScriptFile[],
  model: string = DEFAULT_MODEL,
  knownCharacters: string[] = [],
  knownScenes: string[] = [],
  mode: 'quick' | 'standard' | 'deep' = 'standard'
): Promise<ProjectAnalysisResult> {
  // åˆå¹¶æ‰€æœ‰å‰§æœ¬å†…å®¹ï¼ˆå–æ ·åˆ†æï¼Œé¿å…tokenè¶…é™ï¼‰
  // ğŸ”§ v3ä¿®å¤ï¼šå¢åŠ æ¯é›†å–æ ·é•¿åº¦ï¼Œç¡®ä¿ä¿¡æ¯æå–å®Œæ•´
  // Gemini 2.0 Flash æ”¯æŒ 1M tokenï¼Œå¯ä»¥ä½¿ç”¨æ›´å¤§çš„ä¸Šä¸‹æ–‡
  const totalScripts = scripts.length;
  let maxPerScript: number;
  if (totalScripts > 50) {
    maxPerScript = 2500;  // 50é›†ä»¥ä¸Šï¼šæ¯é›†2500å­—ï¼ˆåŸ1200å­—å¤ªå°‘ï¼‰
  } else if (totalScripts > 20) {
    maxPerScript = 4000;  // 20-50é›†ï¼šæ¯é›†4000å­—ï¼ˆåŸ2000å­—å¤ªå°‘ï¼‰
  } else if (totalScripts > 10) {
    maxPerScript = 6000;  // 10-20é›†ï¼šæ¯é›†6000å­—ï¼ˆåŸ3500å­—ï¼‰
  } else {
    maxPerScript = 8000;  // 10é›†ä»¥ä¸‹ï¼šæ¯é›†8000å­—ï¼ˆåŸ5000å­—ï¼‰
  }

  // è®¡ç®—å½“å‰æ‰¹æ¬¡çš„é›†æ•°èŒƒå›´
  // è°ƒè¯•ï¼šæ‰“å°æ¯ä¸ªè„šæœ¬çš„é›†æ•°ä¿¡æ¯
  console.log('[ProjectAnalysis] è„šæœ¬é›†æ•°åˆ—è¡¨:', scripts.map(s => ({ fileName: s.fileName?.slice(0, 15), epNum: s.episodeNumber })));

  const episodeNumbers = scripts.map(s => s.episodeNumber).filter((n): n is number => n !== undefined && n !== null);
  console.log('[ProjectAnalysis] æå–åˆ°çš„é›†æ•°:', episodeNumbers);

  const minEp = episodeNumbers.length > 0 ? Math.min(...episodeNumbers) : 1;
  const maxEp = episodeNumbers.length > 0 ? Math.max(...episodeNumbers) : scripts.length;
  const episodeRangeInfo = `ç¬¬${minEp}é›†è‡³ç¬¬${maxEp}é›†ï¼ˆå…±${totalScripts}é›†ï¼‰`;

  const combinedContent = scripts.map((s, idx) => {
    // ç¡®ä¿æ¯é›†æ ‡é¢˜ä½¿ç”¨æ­£ç¡®çš„é›†æ•°
    const epNum = s.episodeNumber ?? (minEp + idx);
    return `=== ç¬¬${epNum}é›† ===\n${s.content.slice(0, maxPerScript)}`;
  }).join('\n\n');

  console.log(`[ProjectAnalysis] åˆ†æ${episodeRangeInfo}ï¼Œæ¯é›†å–æ ·${maxPerScript}å­—`);

  // ğŸ†• v5: å¦‚æœæœ‰å·²çŸ¥è§’è‰²/åœºæ™¯åˆ—è¡¨ï¼Œæ·»åŠ åˆ°æç¤ºè¯ä¸­
  const knownCharactersSection = knownCharacters.length > 0
    ? `\n## ğŸ”” é¢„æ‰«æå‘ç°çš„è§’è‰²åï¼ˆå¿…é¡»å…¨éƒ¨åŒ…å«åœ¨åˆ†æç»“æœä¸­ï¼ï¼‰\nä»¥ä¸‹è§’è‰²åœ¨å‰§æœ¬ä¸­è¢«å‘ç°ï¼Œè¯·ç¡®ä¿å…¨éƒ¨å‡ºç°åœ¨ characters æ•°ç»„ä¸­ï¼š\n${knownCharacters.map(n => `- ${n}`).join('\n')}\n`
    : '';

  const knownScenesSection = knownScenes.length > 0
    ? `\n## ğŸ””ğŸ””ğŸ”” é¢„æ‰«æå‘ç°çš„åœºæ™¯åï¼ˆğŸ”´ å¿…é¡»å…¨éƒ¨åŒ…å«ï¼ï¼‰\n**âš ï¸ è¶…çº§é‡è¦ï¼šä»¥ä¸‹ ${knownScenes.length} ä¸ªåœºæ™¯åœ¨å‰§æœ¬ä¸­è¢«å‘ç°ï¼Œä½ å¿…é¡»ç¡®ä¿å…¨éƒ¨å‡ºç°åœ¨ scenes æ•°ç»„ä¸­ï¼**\n**ä¸è¦é—æ¼ä»»ä½•ä¸€ä¸ªåœºæ™¯ï¼Œå³ä½¿ä½ è®¤ä¸ºå®ƒä¸é‡è¦ï¼**\n${knownScenes.map(n => `- ${n}`).join('\n')}\n`
    : '';

  // ğŸ†• æ ¹æ®æ¨¡å¼ç”Ÿæˆä¸åŒçš„æå–è¦æ±‚
  const modeConfig = {
    quick: {
      title: 'å¿«é€Ÿåˆ†ææ¨¡å¼',
      description: 'ä»…æå–åŸºç¡€ä¿¡æ¯ï¼Œè·³è¿‡è¯¦ç»†å†…å®¹',
      characterDetail: 'åªæå–è§’è‰²åã€æ€§åˆ«ã€åŸºç¡€å¤–è§‚ï¼ˆ50å­—ä»¥å†…ï¼‰',
      skipForms: true,
      skipAbilities: true,
      skipQuote: true,
      skipIdentityEvolution: true,
      sceneDetail: 'åªæå–åœºæ™¯åç§°å’ŒåŸºç¡€æè¿°ï¼ˆ50å­—ä»¥å†…ï¼‰',
    },
    standard: {
      title: 'æ ‡å‡†åˆ†ææ¨¡å¼',
      description: 'æå–å®Œæ•´åŸºç¡€ä¿¡æ¯ + å¤šå½¢æ€ + ç»å…¸å°è¯',
      characterDetail: 'æå–åŸºç¡€ä¿¡æ¯ + å¤šå½¢æ€å›¾é‰´ + ç»å…¸å°è¯',
      skipForms: false,
      skipAbilities: true,
      skipQuote: false,
      skipIdentityEvolution: false,
      sceneDetail: 'æå–åœºæ™¯åç§°å’Œè¯¦ç»†æè¿°ï¼ˆ80-150å­—ï¼‰',
    },
    deep: {
      title: 'æ·±åº¦åˆ†ææ¨¡å¼',
      description: 'æå–å…¨éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬èƒ½åŠ›è¿›åŒ–ã€å…³ç³»ç½‘ç»œ',
      characterDetail: 'æå–å…¨éƒ¨ä¿¡æ¯ï¼ˆåŸºç¡€ + å¤šå½¢æ€ + èƒ½åŠ› + å°è¯ + å…³ç³»ï¼‰',
      skipForms: false,
      skipAbilities: false,
      skipQuote: false,
      skipIdentityEvolution: false,
      sceneDetail: 'æå–åœºæ™¯åç§°å’Œè¶…è¯¦ç»†æè¿°ï¼ˆ100-200å­—ï¼‰',
    },
  };

  const currentMode = modeConfig[mode];

  const prompt = `
# ä»»åŠ¡ï¼š${currentMode.title} - ç”Ÿæˆé¡¹ç›®æ¡£æ¡ˆ

ğŸ“¢ **å½“å‰åˆ†æçš„å‰§æœ¬èŒƒå›´ï¼š${episodeRangeInfo}**
ğŸ“Š **æå–æ¨¡å¼ï¼š${currentMode.title}** - ${currentMode.description}
${knownCharactersSection}${knownScenesSection}
ä½ æ˜¯ä¸€ä½èµ„æ·±å½±è§†ç­–åˆ’ï¼Œéœ€è¦ä»å‰§æœ¬ä¸­æå–å®Œæ•´çš„é¡¹ç›®ä¿¡æ¯ï¼Œç”¨äºåç»­åˆ†é•œåˆ¶ä½œã€‚

## âš ï¸ å…³é”®è¦æ±‚ï¼ˆå¿…è¯»ï¼ï¼‰

### 0. ä¸–ç•Œè§‚ä¸é¡¹ç›®ç±»å‹ï¼ˆğŸ”´ å¿…é¡»è¯¦ç»†å¡«å†™ï¼ï¼‰
- **worldView å­—æ®µå¿…é¡»è¯¦ç»†æè¿°æ•…äº‹çš„ä¸–ç•Œè§‚è®¾å®š**ï¼ˆ100-300å­—ï¼‰ï¼š
  - æ—¶ä»£èƒŒæ™¯ï¼šæ•…äº‹å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶ä»£/ä¸–ç•Œï¼Ÿï¼ˆå¦‚ï¼šè¿‘æœªæ¥ã€å¹³è¡Œä¸–ç•Œã€å¤ä»£ã€è™šæ‹Ÿä¸–ç•Œï¼‰
  - æ ¸å¿ƒè®¾å®šï¼šä¸–ç•Œçš„æ ¸å¿ƒè§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¦‚ï¼šå¼‚èƒ½å­˜åœ¨ã€AIè§‰é†’ã€ä¿®ä»™ä½“ç³»ï¼‰
  - ç¤¾ä¼šç»“æ„ï¼šä¸–ç•Œçš„æƒåŠ›ç»“æ„ã€ä¸»è¦åŠ¿åŠ›ã€ç¤¾ä¼šå½¢æ€
  - ç‰¹æ®Šå…ƒç´ ï¼šç‹¬ç‰¹çš„ç§‘æŠ€/é­”æ³•/èƒ½åŠ›ä½“ç³»
  - âŒ é”™è¯¯ç¤ºèŒƒï¼š"è¿™æ˜¯ä¸€ä¸ªç§‘å¹»æ•…äº‹"ï¼ˆå¤ªç®€å•ï¼‰
  - âœ… æ­£ç¡®ç¤ºèŒƒï¼š"è¿‘æœªæ¥ä¸–ç•Œï¼ŒAIä¸»è„‘'åäºŒæ˜Ÿå®«'ç»Ÿæ²»ç€äººç±»ï¼Œæ‰€æœ‰äººç±»éƒ½æ˜¯NPCï¼Œè¢«ç®—æ³•é¢„æµ‹å‘½è¿ã€‚ä¸»è§’æ™‹å®‰å‘ç°è‡ªå·±æ˜¯å”¯ä¸€æ‹¥æœ‰è‡ªä¸»æ„è¯†çš„BUGï¼Œå¼€å§‹åæŠ—ç³»ç»Ÿçš„ç»Ÿæ²»..."
- **genre å­—æ®µå¿…é¡»è¯†åˆ«é¡¹ç›®çš„å…·ä½“ç±»å‹**ï¼Œ**å¿…é¡»ç”¨ ' / ' åˆ†éš”å¤šä¸ªæ ‡ç­¾**ï¼š

  **è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
  - æ ¼å¼ï¼š"å—ä¼—ç±»å‹ / æ ¸å¿ƒé¢˜æ / æ—¶ä»£èƒŒæ™¯æˆ–ç©ºé—´"
  - ç¤ºä¾‹ï¼š
    - "å¥³é¢‘è¨€æƒ… / é‡ç”Ÿ / 90å¹´ä»£å†œæ‘"
    - "ç§‘å¹» / éƒ½å¸‚ / çŸ­å‰§"
    - "å¤è£…æƒè°‹ / å®«æ–— / æ¸…æœ"
    - "ç°å®ä¸»ä¹‰ / å®¶åº­ä¼¦ç† / å½“ä»£éƒ½å¸‚"

  **ä¸‰å±‚æ ‡ç­¾è¯´æ˜**ï¼š
  1. **å—ä¼—ç±»å‹**ï¼ˆå¯é€‰ï¼‰ï¼šå¥³é¢‘è¨€æƒ…ã€ç”·é¢‘ã€åˆå®¶æ¬¢ã€é’æ˜¥æ ¡å›­ç­‰
  2. **æ ¸å¿ƒé¢˜æ**ï¼ˆå¿…é¡»ï¼‰ï¼šé‡ç”Ÿã€å¤ä»‡ã€ç”œå® ã€è™æ‹ã€é€†è¢­ã€ç§‘å¹»ã€ä»™ä¾ ã€æ‚¬ç–‘ã€æ¨ç†ç­‰
  3. **æ—¶ä»£/ç©ºé—´**ï¼ˆå¿…é¡»ï¼‰ï¼š90å¹´ä»£å†œæ‘ã€å½“ä»£éƒ½å¸‚ã€å¤ä»£å®«å»·ã€æœªæ¥ä¸–ç•Œã€å¼‚ä¸–ç•Œç­‰

  **åˆ¤æ–­ä¾æ®**ï¼š
  - æ ¹æ®å‰§æœ¬å†…å®¹ã€è§’è‰²å…³ç³»ã€æƒ…æ„Ÿçº¿ã€å†²çªç±»å‹ç»¼åˆåˆ¤æ–­
  - å¦‚æœæœ‰æ˜æ˜¾çš„å—ä¼—å€¾å‘ï¼ˆå¦‚å¥³æ€§è§†è§’ã€è¨€æƒ…å…ƒç´ ï¼‰ï¼Œå¿…é¡»æ ‡æ³¨"å¥³é¢‘è¨€æƒ…"
  - å¦‚æœæœ‰é‡ç”Ÿ/ç©¿è¶Š/å¤ä»‡ç­‰æ ¸å¿ƒè®¾å®šï¼Œå¿…é¡»æ ‡æ³¨
  - æ—¶ä»£èƒŒæ™¯å¿…é¡»å…·ä½“ï¼ˆä¸è¦åªå†™"ç°ä»£"ï¼Œè¦å†™"90å¹´ä»£"æˆ–"å½“ä»£"ï¼‰

### 1. è§’è‰²åˆ†æï¼ˆæœ€é‡è¦ï¼ğŸ”´ å¿…é¡»å®Œæ•´æå–ï¼‰
- **âš ï¸ å¿…é¡»è¯†åˆ«æœ¬æ‰¹æ¬¡å‰§æœ¬ä¸­å‡ºç°çš„æ‰€æœ‰æœ‰åå­—çš„è§’è‰²ï¼**
  - ä¸»è§’ã€é…è§’ã€åæ´¾ã€è·¯äººè§’è‰²ï¼Œåªè¦åœ¨å‰§æœ¬ä¸­æœ‰åå­—æˆ–ç§°å‘¼å°±è¦è®°å½•
  - ä»”ç»†é˜…è¯»æ¯ä¸€é›†çš„å¯¹è¯å’Œæå†™ï¼Œæå–æ‰€æœ‰è§’è‰²
  - å¦‚æœä¸€ä¸ªè§’è‰²åªåœ¨ä¸€é›†ä¸­å‡ºç°ä¸€æ¬¡ï¼Œä¹Ÿè¦è®°å½•
  - å¸¸è§é—æ¼ï¼šåæ´¾æ‰‹ä¸‹ã€ç¾¤ä¼—è§’è‰²ã€å®¶äººã€è€å¸ˆã€NPCç­‰
- **ğŸ†• è§’è‰²å®šä½è¯†åˆ«ï¼ˆé‡è¦ï¼ç”¨äºä¸»è§’è¯†åˆ«ï¼‰**ï¼š
  - åœ¨æå–è§’è‰²æ—¶ï¼Œå¿…é¡»åˆ¤æ–­è¯¥è§’è‰²åœ¨å‰§æœ¬ä¸­çš„å®šä½ï¼š
    - **ä¸»è§’**ï¼šå‰§æƒ…çš„æ ¸å¿ƒäººç‰©ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€è§†è§’ã€æœ€å¤šæˆä»½ã€æ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®è§’è‰²
    - **é‡è¦é…è§’**ï¼šæœ‰ç‹¬ç«‹å‰§æƒ…çº¿ã€å¯¹ä¸»è§’æœ‰é‡è¦å½±å“çš„è§’è‰²ï¼ˆå¦‚å¯¼å¸ˆã€æŒšå‹ã€é‡è¦å®¶äººï¼‰
    - **é…è§’**ï¼šæœ‰åå­—ã€æœ‰å°è¯ï¼Œä½†æˆä»½è¾ƒå°‘çš„è§’è‰²
    - **åæ´¾**ï¼šä¸ä¸»è§’å¯¹ç«‹ã€åˆ¶é€ å†²çªçš„è§’è‰²
  - **âš ï¸ å¿…é¡»åœ¨ description å­—æ®µä¸­æ ‡æ³¨è§’è‰²å®šä½**ï¼š
    - æ ¼å¼ï¼šåœ¨ description çš„**å¼€å¤´**åŠ ä¸Š"ã€ä¸»è§’ã€‘"ã€"ã€é‡è¦é…è§’ã€‘"ã€"ã€é…è§’ã€‘"æˆ–"ã€åæ´¾ã€‘"æ ‡è®°
    - ç¤ºä¾‹ï¼š"ã€ä¸»è§’ã€‘ç”·ï¼Œ28å²ï¼Œèº«ææŒºæ‹”ï¼Œçœ¼ç¥æ·±é‚ƒè€Œå†·é™..."
    - ç¤ºä¾‹ï¼š"ã€åæ´¾ã€‘ç”·ï¼Œ45å²ï¼Œæ²¹è…»å‘ç¦ï¼Œçœ¼ç¥é˜´é™©..."
  - **åˆ¤æ–­ä¾æ®**ï¼š
    - å‡ºåœºé¢‘ç‡ï¼ˆä¸»è§’é€šå¸¸æ¯é›†éƒ½å‡ºç°ï¼‰
    - è§†è§’ï¼ˆä¸»è§’é€šå¸¸æ˜¯ç¬¬ä¸€è§†è§’æˆ–ä¸»è¦è§†è§’ï¼‰
    - å‰§æƒ…æ¨åŠ¨ï¼ˆä¸»è§’çš„è¡ŒåŠ¨æ¨åŠ¨å‰§æƒ…å‘å±•ï¼‰
    - æƒ…æ„ŸæŠ•å…¥ï¼ˆä¸»è§’é€šå¸¸æœ‰æ›´å¤šå†…å¿ƒæˆå’Œæƒ…æ„Ÿæå†™ï¼‰
- **ğŸ†• è§’è‰²å®šä½è¯†åˆ«ï¼ˆé‡è¦ï¼ç”¨äºä¸»è§’è¯†åˆ«ï¼‰**ï¼š
  - åœ¨æå–è§’è‰²æ—¶ï¼Œå¿…é¡»åˆ¤æ–­è¯¥è§’è‰²åœ¨å‰§æœ¬ä¸­çš„å®šä½ï¼š
    - **ä¸»è§’**ï¼šå‰§æƒ…çš„æ ¸å¿ƒäººç‰©ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€è§†è§’ã€æœ€å¤šæˆä»½ã€æ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®è§’è‰²
    - **é‡è¦é…è§’**ï¼šæœ‰ç‹¬ç«‹å‰§æƒ…çº¿ã€å¯¹ä¸»è§’æœ‰é‡è¦å½±å“çš„è§’è‰²ï¼ˆå¦‚å¯¼å¸ˆã€æŒšå‹ã€é‡è¦å®¶äººï¼‰
    - **é…è§’**ï¼šæœ‰åå­—ã€æœ‰å°è¯ï¼Œä½†æˆä»½è¾ƒå°‘çš„è§’è‰²
    - **åæ´¾**ï¼šä¸ä¸»è§’å¯¹ç«‹ã€åˆ¶é€ å†²çªçš„è§’è‰²
  - **âš ï¸ å¿…é¡»åœ¨ description å­—æ®µä¸­æ ‡æ³¨è§’è‰²å®šä½**ï¼š
    - æ ¼å¼ï¼šåœ¨ description çš„**å¼€å¤´**åŠ ä¸Š"ã€ä¸»è§’ã€‘"ã€"ã€é‡è¦é…è§’ã€‘"ã€"ã€é…è§’ã€‘"æˆ–"ã€åæ´¾ã€‘"æ ‡è®°
    - ç¤ºä¾‹ï¼š"ã€ä¸»è§’ã€‘ç”·ï¼Œ28å²ï¼Œèº«ææŒºæ‹”ï¼Œçœ¼ç¥æ·±é‚ƒè€Œå†·é™..."
    - ç¤ºä¾‹ï¼š"ã€åæ´¾ã€‘ç”·ï¼Œ45å²ï¼Œæ²¹è…»å‘ç¦ï¼Œçœ¼ç¥é˜´é™©..."
  - **åˆ¤æ–­ä¾æ®**ï¼š
    - å‡ºåœºé¢‘ç‡ï¼ˆä¸»è§’é€šå¸¸æ¯é›†éƒ½å‡ºç°ï¼‰
    - è§†è§’ï¼ˆä¸»è§’é€šå¸¸æ˜¯ç¬¬ä¸€è§†è§’æˆ–ä¸»è¦è§†è§’ï¼‰
    - å‰§æƒ…æ¨åŠ¨ï¼ˆä¸»è§’çš„è¡ŒåŠ¨æ¨åŠ¨å‰§æƒ…å‘å±•ï¼‰
    - æƒ…æ„ŸæŠ•å…¥ï¼ˆä¸»è§’é€šå¸¸æœ‰æ›´å¤šå†…å¿ƒæˆå’Œæƒ…æ„Ÿæå†™ï¼‰

- **ğŸ†• ä¸»è§’è¯†åˆ«ï¼ˆé‡è¦ï¼ç”¨äºåç»­è‡ªåŠ¨è¡¥å…¨ä¼˜å…ˆçº§ï¼‰**ï¼š
  - åœ¨æå–è§’è‰²åï¼Œè¯·æ ¹æ®ä»¥ä¸‹æ ‡å‡†ï¼Œè¯†åˆ«å‡º **1-3 ä¸ªæœ€å¯èƒ½çš„ä¸»è§’**ï¼š

  **åˆ¤æ–­æ ‡å‡†**ï¼š
  1. **å‡ºåœºé¢‘ç‡**ï¼šä¸»è§’é€šå¸¸æ¯é›†éƒ½å‡ºç°æˆ–å¤§éƒ¨åˆ†é›†æ•°å‡ºç°
  2. **è§†è§’**ï¼šä¸»è§’é€šå¸¸æ˜¯ç¬¬ä¸€è§†è§’æˆ–ä¸»è¦è§†è§’
  3. **å‰§æƒ…æ¨åŠ¨**ï¼šä¸»è§’çš„è¡ŒåŠ¨æ¨åŠ¨å‰§æƒ…å‘å±•
  4. **æƒ…æ„ŸæŠ•å…¥**ï¼šä¸»è§’é€šå¸¸æœ‰æ›´å¤šå†…å¿ƒæˆå’Œæƒ…æ„Ÿæå†™
  5. **æ ‡é¢˜/ç®€ä»‹æš—ç¤º**ï¼šå¦‚æœå‰§æœ¬æ ‡é¢˜æˆ–ç®€ä»‹ä¸­æåˆ°æŸä¸ªè§’è‰²ï¼Œé€šå¸¸æ˜¯ä¸»è§’

  **è¾“å‡ºè¦æ±‚**ï¼š
  - åœ¨ JSON çš„ \`suggestedMainCharacters\` æ•°ç»„ä¸­åˆ—å‡º 1-3 ä¸ªæœ€å¯èƒ½çš„ä¸»è§’
  - æ¯ä¸ªä¸»è§’éœ€è¦è¯´æ˜ç†ç”±ï¼ˆ20-50 å­—ï¼‰
  - ç†ç”±åº”è¯¥å…·ä½“ï¼Œä¾‹å¦‚ï¼š"å‡ºåœº 7 é›†ï¼Œç¬¬ä¸€è§†è§’ï¼Œå‰§æƒ…å›´ç»•å…¶é‡ç”Ÿå¤ä»‡å±•å¼€"

  **æ³¨æ„äº‹é¡¹**ï¼š
  - å¦‚æœæœ‰æ˜æ˜¾çš„ç”·å¥³ä¸»è§’ï¼ˆå¦‚è¨€æƒ…å‰§ï¼‰ï¼Œä¸¤ä¸ªéƒ½è¦åˆ—å‡º
  - å¦‚æœæ˜¯ç¾¤åƒå‰§ï¼Œå¯ä»¥åˆ—å‡º 2-3 ä¸ªæ ¸å¿ƒè§’è‰²
  - å¦‚æœå®åœ¨æ— æ³•åˆ¤æ–­ï¼Œå¯ä»¥åªåˆ—å‡ºæœ€æ˜æ˜¾çš„ 1 ä¸ª
  - ä¸è¦æŠŠæ‰€æœ‰è§’è‰²éƒ½åˆ—ä¸ºä¸»è§’ï¼Œåªåˆ—æœ€æ ¸å¿ƒçš„

- **ğŸ“Š å½“å‰æ¨¡å¼è¦æ±‚ï¼š${currentMode.characterDetail}**
${currentMode.skipForms ? '- âš ï¸ **å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡å¤šå½¢æ€æå–**ï¼Œåªè®°å½•è§’è‰²çš„é»˜è®¤å¤–è§‚' : '- **ğŸ­ å¤šå½¢æ€/æ¢è£…å›¾é‰´ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼ğŸ”´ å¿…é¡»ç»†è‡´æå–ï¼ï¼‰**ï¼š'}
${currentMode.skipForms ? '' : `  - **âš ï¸ å½¢æ€è¯†åˆ«æ¸…å•**ï¼ˆé‡åˆ°ä»¥ä¸‹æƒ…å†µå¿…é¡»åˆ›å»ºæ–°å½¢æ€ï¼‰ï¼š
    1. æœè£…/é€ å‹å˜åŒ–ï¼šæ¢è£…ã€æˆ˜æŸã€ä¼ªè£…ã€åˆ¶æœåˆ‡æ¢
    2. èº«ä½“çŠ¶æ€å˜åŒ–ï¼šå—ä¼¤ã€è§‰é†’ã€ä¹‰ä½“åŒ–ã€åŠå…½åŒ–ã€æ•°æ®åŒ–
    3. ç¯å¢ƒé€‚åº”å˜åŒ–ï¼šä¸åŒä¸–ç•Œçš„è£…æŸï¼ˆåºŸåœŸã€è’¸æ±½æœ‹å…‹ã€æ­¦ä¾ ç­‰ï¼‰
    4. èƒ½åŠ›è§‰é†’è¡¨ç°ï¼šçœ¼ç›å‘å…‰ã€èº«ä½“å‘å…‰ã€ç¬¦æ–‡æ˜¾ç°ã€å½¢æ€å˜å¼‚
    5. ç‰¹æ®ŠçŠ¶æ€ï¼šæ¿’æ­»ã€è¢«æ§åˆ¶ã€ä¼ªè£…èº«ä»½ã€æ¢¦å¢ƒä¸­çš„å½¢è±¡
  - ä¾‹å¦‚ä¸€ä¸ªä¸»è§’åœ¨80é›†ä¸­å¯èƒ½æœ‰**10-15ä¸ªå½¢æ€**ï¼š
    - æ—¥å¸¸æ ¡æœå½¢æ€ã€æˆ˜æŸå½¢æ€ã€æ¢è£…å½¢æ€ã€è§‰é†’å½¢æ€ã€ä¸åŒä¸–ç•Œçš„ä¼ªè£…å½¢æ€ç­‰`}
${currentMode.skipForms ? '' : '- **ğŸ­ å¤šå½¢æ€/æ¢è£…å›¾é‰´ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼ğŸ”´ å¿…é¡»ç»†è‡´æå–ï¼ï¼‰**ï¼š'}
  - **âš ï¸ å½¢æ€è¯†åˆ«æ¸…å•**ï¼ˆé‡åˆ°ä»¥ä¸‹æƒ…å†µå¿…é¡»åˆ›å»ºæ–°å½¢æ€ï¼‰ï¼š
    1. æœè£…/é€ å‹å˜åŒ–ï¼šæ¢è£…ã€æˆ˜æŸã€ä¼ªè£…ã€åˆ¶æœåˆ‡æ¢
    2. èº«ä½“çŠ¶æ€å˜åŒ–ï¼šå—ä¼¤ã€è§‰é†’ã€ä¹‰ä½“åŒ–ã€åŠå…½åŒ–ã€æ•°æ®åŒ–
    3. ç¯å¢ƒé€‚åº”å˜åŒ–ï¼šä¸åŒä¸–ç•Œçš„è£…æŸï¼ˆåºŸåœŸã€è’¸æ±½æœ‹å…‹ã€æ­¦ä¾ ç­‰ï¼‰
    4. èƒ½åŠ›è§‰é†’è¡¨ç°ï¼šçœ¼ç›å‘å…‰ã€èº«ä½“å‘å…‰ã€ç¬¦æ–‡æ˜¾ç°ã€å½¢æ€å˜å¼‚
    5. ç‰¹æ®ŠçŠ¶æ€ï¼šæ¿’æ­»ã€è¢«æ§åˆ¶ã€ä¼ªè£…èº«ä»½ã€æ¢¦å¢ƒä¸­çš„å½¢è±¡
  - ä¾‹å¦‚ä¸€ä¸ªä¸»è§’åœ¨80é›†ä¸­å¯èƒ½æœ‰**10-15ä¸ªå½¢æ€**ï¼š
    - æ—¥å¸¸æ ¡æœå½¢æ€ã€æˆ˜æŸå½¢æ€ã€æ¢è£…å½¢æ€ã€è§‰é†’å½¢æ€ã€ä¸åŒä¸–ç•Œçš„ä¼ªè£…å½¢æ€ç­‰
${currentMode.skipForms ? '' : `  - **æ¯ä¸ªå½¢æ€å¿…é¡»åŒ…å«**ï¼š
    1. **name**: å½¢æ€åç§°ï¼ˆå¸¦emojiï¼‰ï¼Œå¦‚"ğŸ’ é«˜ä¸­æ ¡æœ"ã€"ğŸ¤– ç±»äººå°–å…µ"ã€"ğŸ”¥ ç„šè¡£åŠè£¸"
    2. **episodeRange**: âš ï¸ **å¿…é¡»ç²¾ç¡®æ ‡æ³¨è¯¥å½¢æ€åœ¨å“ªäº›é›†å‡ºç°**
       - **åªèƒ½ä½¿ç”¨æœ¬æ¬¡åˆ†æçš„å‰§æœ¬èŒƒå›´å†…çš„é›†æ•°**ï¼š${episodeRangeInfo}
       - ä»”ç»†é˜…è¯»å‰§æœ¬ï¼Œæ‰¾å‡ºè¯¥å½¢æ€**å®é™…é¦–æ¬¡å‡ºç°å’Œæœ€åå‡ºç°**çš„é›†æ•°
       - æ ¼å¼ç¤ºä¾‹ï¼š"Ep ${minEp}"ï¼ˆä»…åœ¨è¯¥é›†å‡ºç°ï¼‰ã€"Ep ${minEp}-${maxEp}"ï¼ˆæŒç»­å‡ºç°ï¼‰
    3. **description**: âš ï¸ **å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ä¸‰æ®µå¼æ ¼å¼**ï¼ˆ100-150å­—ï¼‰ï¼š
       \`\`\`
       ã€å¤–è²Œç‰¹å¾ã€‘å‘å‹å‘è‰²ã€çœ¼ç›é¢œè‰²å½¢çŠ¶ã€äº”å®˜ç‰¹ç‚¹ã€è¡¨æƒ…æ°”è´¨ã€èº«å½¢ä½“æ€ã€è‚¤è‰²
       ã€ä¸»ä½“äººç‰©ã€‘ç”»é£å®šä½ï¼ˆå¦‚ï¼šæ—¥ç³»åŠ¨æ¼«é£æ ¼ã€äºŒæ¬¡å…ƒå°‘å¹´ã€å†™å®é’å¹´ç­‰ï¼‰+ è§’è‰²ç±»å‹
       ã€æœé¥°é€ å‹ã€‘ä¸Šè£…ï¼ˆæ¬¾å¼ã€é¢œè‰²ã€æè´¨ï¼‰+ ä¸‹è£… + é‹å­ + é…é¥°ï¼ˆå¦‚æœ‰ï¼‰
       \`\`\`
    4. **note**: å¤‡æ³¨ï¼Œè¯´æ˜è¿™ä¸ªå½¢æ€çš„æƒ…å¢ƒæˆ–æ„ä¹‰ï¼ˆå¦‚ï¼šè§‰é†’åã€ä¼ªè£…çŠ¶æ€ã€æˆ˜æŸç­‰ï¼‰
    5. **visualPromptCn/En**: ä¸­è‹±æ–‡è§†è§‰æç¤ºè¯
  - **å½¢æ€ç¤ºä¾‹ï¼ˆå®Œæ•´æ¢è£…å›¾é‰´å‚è€ƒï¼‰**ï¼š
    | å½¢æ€ | é›†æ•° | è¯¦ç»†æè¿° | å¤‡æ³¨ |
    |------|------|----------|------|
    | ğŸ’ é«˜ä¸­æ ¡æœ | Ep 1-20 | ã€å¤–è²Œã€‘æµ…æ£•çŸ­å‘...ã€ä¸»ä½“ã€‘æ—¥ç³»å°‘å¹´...ã€æœé¥°ã€‘è“ç™½æ ¡æœ+ä¹¦åŒ… | ä¼ªè£…æœŸï¼Œæ—¥å¸¸ |
    | ğŸ”¥ ç„šè¡£åŠè£¸ | Ep 20 | ã€å¤–è²Œã€‘åŒä¸Šä½†çœ¼ç¥åšæ¯…...ã€æœé¥°ã€‘èµ¤è£¸ä¸Šèº«ï¼Œç«å…‰æ˜ ç…§ | é”€æ¯è¡€è¡£åœºæ™¯ |
    | ğŸŒ«ï¸ åºŸåœŸæµæµª | Ep 27 | ã€æœé¥°ã€‘æ²¾æ»¡æ²¹æ±¡çš„ä¼‘é—²è£… | ç©¿è¶ŠåˆæœŸç‹¼ç‹ˆçŠ¶æ€ |
    | ğŸ¤– ç±»äººå°–å…µ | Ep 32-36 | ã€å¤–è²Œã€‘é¢éƒ¨é‡‘å±åŒ–...ã€æœé¥°ã€‘å…¨è¦†å¼æµçº¿å‹æœºç”² | æœºç”²å¯„å®¿å½¢æ€ |
    | âœ¨ ç¥æ€§ç´ ä½“ | Ep 46 | ã€å¤–è²Œã€‘çš®è‚¤è‹ç™½ï¼Œè¡€ç®¡æµæ·Œé‡‘è‰²ç®—åŠ› | ç¥æ€§é‡æ„å |`}
${currentMode.skipQuote ? '- âš ï¸ **å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡ç»å…¸å°è¯æå–**' : '- **è§’è‰²ç»å…¸å°è¯**ï¼šæå–æœ€èƒ½ä»£è¡¨è§’è‰²æ€§æ ¼çš„ä¸€å¥è¯'}
${currentMode.skipIdentityEvolution ? '- âš ï¸ **å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡èº«ä»½æ¼”å˜æå–**' : '- **èº«ä»½æ¼”å˜**ï¼šç”¨ç®­å¤´è¿æ¥ï¼Œå¦‚"é«˜ä¸­ç”Ÿ â” è§‰é†’è€… â” æ•‘ä¸–ä¸»"'}
- **å¤–è§‚æè¿°ï¼ˆappearanceï¼‰**ï¼šâš ï¸ **å¿…é¡»ä½¿ç”¨ä¸‰æ®µå¼æ ‡è®°æ ¼å¼**${mode === 'quick' ? 'ï¼ˆå†…å®¹å¯ç®€åŒ–ä¸º50å­—ä»¥å†…ï¼‰' : 'ï¼ˆå®Œæ•´æè¿°100-150å­—ï¼‰'}ï¼Œæè¿°è§’è‰²çš„**å¸¸æ€/é»˜è®¤å¤–è§‚**
  - ğŸš¨ğŸš¨ğŸš¨ **æ ¼å¼è¦æ±‚ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½å¿…é¡»éµå®ˆï¼ï¼‰**ï¼š
    - âœ… **å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªæ ‡è®°**ï¼šã€ä¸»ä½“äººç‰©ã€‘ã€ã€å¤–è²Œç‰¹å¾ã€‘ã€ã€æœé¥°é€ å‹ã€‘
    - âŒ **ä¸¥ç¦ä½¿ç”¨é”™è¯¯æ ‡è®°**ï¼šã€å¤–è²Œæè¿°ã€‘ã€ã€å¹²ä½“äººç‰©ã€‘ã€ã€å¤–è§‚ã€‘ã€ã€æœè£…ã€‘ç­‰ä»»ä½•å…¶ä»–æ ‡è®°
    - âŒ **ä¸¥ç¦çœç•¥ä»»ä½•ä¸€ä¸ªæ ‡è®°**ï¼šå³ä½¿æ˜¯ quick æ¨¡å¼ï¼Œä¸‰ä¸ªæ ‡è®°éƒ½å¿…é¡»å­˜åœ¨
  - âš ï¸ **é‡è¦åŒºåˆ†**ï¼š
    - âœ… **appearanceå­—æ®µ**ï¼šåªæè¿°è§’è‰²çš„**å¸¸æ€å¤–è§‚**ï¼ˆå¥åº·ã€å®Œæ•´ã€æ—¥å¸¸çŠ¶æ€ï¼‰
    - âœ… **formsæ•°ç»„**ï¼šæè¿°è§’è‰²çš„**ç‰¹æ®ŠçŠ¶æ€**ï¼ˆå—ä¼¤ã€æˆ˜æŸã€æ¢è£…ã€å˜èº«ã€è§‰é†’ç­‰ï¼‰
  - âŒ **ä¸¥æ ¼ç¦æ­¢åœ¨appearanceä¸­åŒ…å«**ï¼š
    - å—ä¼¤çŠ¶æ€ï¼ˆå¦‚"è„¸é¢Šè‹ç™½"ã€"è¡€è¿¹æ–‘æ–‘"ã€"ä¼¤ç—•ç´¯ç´¯"ï¼‰
    - æˆ˜æŸçŠ¶æ€ï¼ˆå¦‚"è¡£è¡«è¤´è¤›"ã€"å¤´å‘æ•£ä¹±"ã€"æ»¡èº«æ³¥æ±¡"ã€"æ®‹ç ´"ã€"æ’•è£‚"ã€"ç ´æŸ"ï¼‰
    - ç‰¹æ®ŠçŠ¶æ€ï¼ˆå¦‚"çœ¼ç¥è™šå¼±"ã€"æ°”æ¯å¥„å¥„"ã€"æ¿’æ­»"ã€"èµ¤è£¸"ã€"èµ¤è¶³"ï¼‰
  - ğŸš¨ğŸš¨ğŸš¨ **ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼š
    - å¦‚æœå‰§æœ¬ä¸­è§’è‰²**åªå‡ºç°åœ¨ç‰¹æ®ŠçŠ¶æ€**ï¼ˆå¦‚æˆ˜æŸã€å—ä¼¤ã€æ¿’æ­»ï¼‰ï¼Œ**å¿…é¡»æ¨æ–­å…¶å¸¸æ€å¤–è§‚**
    - ç¤ºä¾‹ï¼šå‰§æœ¬æè¿°"æ®‹ç ´çš„ç¢§ç»¿é•¿è¢ã€è¡€è¿¹æ–‘æ–‘" â†’ appearanceåº”å†™"å®Œæ•´çš„ç¢§ç»¿è‰²é•¿è¢"ï¼Œformså†™"æ®‹ç ´è¡€è¿¹å½¢æ€"
    - **æ€è€ƒ**ï¼šè¿™ä¸ªè§’è‰²åœ¨æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥ç©¿ä»€ä¹ˆï¼Ÿé•¿ä»€ä¹ˆæ ·ï¼Ÿ
  - ğŸš¨ğŸš¨ğŸš¨ **ã€æœé¥°é€ å‹ã€‘éƒ¨åˆ†ç»å¯¹ç¦æ­¢**ï¼š
    - âŒ "é»˜è®¤å½¢æ€è§formsæ•°ç»„"
    - âŒ "è§formsæ•°ç»„"
    - âŒ "å‚è§forms"
    - âŒ "é»˜è®¤å½¢æ€"
    - âŒ ä»»ä½•å½¢å¼çš„å ä½ç¬¦æˆ–å¼•ç”¨
    - âŒ "æ®‹ç ´"ã€"ç ´æŸ"ã€"æ’•è£‚"ã€"è¡€è¿¹"ã€"èµ¤è£¸"ã€"èµ¤è¶³"ç­‰ç‰¹æ®ŠçŠ¶æ€è¯æ±‡
    - âœ… **å¿…é¡»ç›´æ¥å†™å‡ºå…·ä½“çš„æœè£…æè¿°**ï¼ˆå¦‚"ç„è‰²é•¿è¢ã€é“¶è´¨è…°å¸¦ã€é»‘è‰²å¸ƒé´"ï¼‰
  - âœ… **æ­£ç¡®ç¤ºèŒƒ**ï¼š
    - appearance: "ã€å¤–è²Œç‰¹å¾ã€‘æ·±æ£•è‰²é•¿å‘æŸ”é¡ºå‚è‡³è…°é—´ã€æ·±é‚ƒçš„é»‘è‰²çœ¼çœ¸ã€äº”å®˜ç²¾è‡´ã€è¡¨æƒ…å¹³é™ã€èº«å½¢ä¿®é•¿ã€è‚¤è‰²ç™½çš™\\nã€ä¸»ä½“äººç‰©ã€‘ç„å¹»ä¿®ä»™ä¸–ç•Œé’å¹´ç”·æ€§\\nã€æœé¥°é€ å‹ã€‘ç„è‰²é•¿è¢ï¼ˆè¡£é¢†å’Œè¢–å£ç»£æš—é‡‘è‰²äº‘çº¹ï¼‰ã€é“¶è´¨è…°å¸¦ã€é»‘è‰²å¸ƒé´"
    - forms[0]: { name: "é­”é“é­é¦–é‡ä¼¤å‚æ­»", description: "ã€å¤–è²Œç‰¹å¾ã€‘æ·±æ£•è‰²é•¿å‘æ•£ä¹±æ²¾è¡€ã€è„¸é¢Šè‹ç™½ã€çœ¼ç¥è™šå¼±...ã€æœé¥°é€ å‹ã€‘ç„è‰²é•¿è¢ç ´æŸã€è¡€è¿¹æ–‘æ–‘..." }
  - âŒ **é”™è¯¯ç¤ºèŒƒï¼ˆç»å¯¹ç¦æ­¢ï¼ï¼‰**ï¼š
    - âŒ "ã€å¤–è²Œæè¿°ã€‘ç«ç‘°çš„æ·¡è‰²é•¿å‘..." ï¼ˆé”™è¯¯æ ‡è®°ï¼‰
    - âŒ "ã€å¹²ä½“äººç‰©ã€‘ç„å¹»ä¿®ä»™ä¸–ç•Œä¸­å¹´ç”·å­..." ï¼ˆé”™è¯¯æ ‡è®°ï¼‰
    - âŒ "ã€å¤–è§‚ã€‘..." ï¼ˆé”™è¯¯æ ‡è®°ï¼‰
- **âš ï¸ appearsInEpisodesï¼ˆå¿…é¡»å¡«å†™ï¼ï¼‰**ï¼šè®°å½•è¯¥è§’è‰²åœ¨æœ¬æ‰¹å‰§æœ¬ä¸­å‡ºç°çš„é›†æ•°
  - æ ¼å¼ï¼šæ•°ç»„ï¼Œå¦‚ [${minEp}, ${minEp + 1}] è¡¨ç¤ºåœ¨ç¬¬${minEp}é›†å’Œç¬¬${minEp + 1}é›†å‡ºç°
  - **å¿…é¡»ä½¿ç”¨æœ¬æ¬¡åˆ†æçš„å®é™…é›†æ•°**ï¼š${episodeRangeInfo}
  - ä»”ç»†é˜…è¯»å‰§æœ¬ï¼Œæ‰¾å‡ºè¯¥è§’è‰²åœ¨å“ªäº›é›†ä¸­å‡ºç°ï¼ˆæœ‰å°è¯ã€æœ‰æå†™ã€æœ‰æåŠéƒ½ç®—ï¼‰
${currentMode.skipAbilities ? '- âš ï¸ **å½“å‰æ¨¡å¼è·³è¿‡èƒ½åŠ›è¿›åŒ–æå–**' : '- **èƒ½åŠ›è¿›åŒ–ï¼ˆabilitiesï¼‰**ï¼šè®°å½•è§’è‰²èƒ½åŠ›çš„æˆé•¿è½¨è¿¹'}

### 2. åœºæ™¯åˆ†æï¼ˆğŸ”´ å¿…é¡»å®Œæ•´æå–ï¼Œçº¯ç¯å¢ƒè®¾è®¡ä¸åŒ…å«äººç‰©ï¼ï¼‰
- **âš ï¸ é‡è¦è¯´æ˜ï¼šScene XXï½œä¸»é¢˜å æ˜¯åˆ†é•œå°èŠ‚æ ‡é¢˜ï¼Œä¸æ˜¯åœºæ™¯åï¼**
  - **çœŸæ­£çš„åœºæ™¯**æ˜¯æŒ‡å‰§æƒ…å‘ç”Ÿçš„**åœ°ç‚¹/ç¯å¢ƒ**ï¼Œéœ€è¦ä»"ç”»é¢"æè¿°ä¸­æå–
  - ä¾‹å¦‚ï¼š
    - âŒ é”™è¯¯ï¼š"çªç ´å¤©ç©¹"ã€"ç¡¬é—¯å†³æ–­"ï¼ˆè¿™äº›æ˜¯Sceneæ ‡é¢˜ï¼Œä¸æ˜¯åœ°ç‚¹ï¼‰
    - âœ… æ­£ç¡®ï¼š"ç¯å½¢éƒ½å¸‚ä¸Šç©º"ã€"å¹æ¯ä¹‹å¢™"ã€"æœˆçƒèƒŒé¢è¡¨é¢"ã€"æ·±æ¸Šåº•å±‚å›æ”¶ç«™"
- **âš ï¸ å…³é”®è¦æ±‚ï¼šä»ç”»é¢æè¿°ä¸­æå–æ‰€æœ‰ç‹¬ç‰¹åœ°ç‚¹/ç¯å¢ƒï¼**
  - ä»”ç»†é˜…è¯»æ¯ä¸ªSceneä¸‹çš„"ç”»é¢"éƒ¨åˆ†ï¼Œè¯†åˆ«å‰§æƒ…å‘ç”Ÿçš„åœ°ç‚¹
  - ç›¸åŒåœ°ç‚¹ä½†ä¸åŒæ—¶é—´/çŠ¶æ€çš„åœºæ™¯ä¹Ÿè¦åˆ†åˆ«è®°å½•ï¼ˆå¦‚"æ•™å®¤-ç™½å¤©"å’Œ"æ•™å®¤-å¤œæ™š"ï¼‰
  - å¿…é¡»æå–æ‰€æœ‰ç‹¬ç‰¹åœºæ™¯ï¼šå­¦æ ¡ã€å®¶ã€æˆ˜æ–—åœºåœ°ã€å¼‚ä¸–ç•Œã€è¿‡æ¸¡ç©ºé—´ã€è¡—é“ã€è½¦å†…ã€æœˆé¢ã€è™šæ‹Ÿç©ºé—´ç­‰
- **âš ï¸ åœºæ™¯æ•°é‡è¦æ±‚ï¼šå¿…é¡»æå–æ‰€æœ‰ç‹¬ç‰¹åœ°ç‚¹ï¼Œä¸è¦é—æ¼ï¼**
  - å¦‚æœé¢„æ‰«ææä¾›äº†åœºæ™¯åˆ—è¡¨ï¼Œå¿…é¡»å…¨éƒ¨åŒ…å«
  - æ¯é›†é€šå¸¸æœ‰3-8ä¸ªä¸åŒåœ°ç‚¹ï¼Œ${scripts.length}é›†å‰§æœ¬å¯èƒ½æœ‰${Math.floor(scripts.length * 1.5)}-${scripts.length * 3}+ä¸ªåœºæ™¯
  - å®å¯å¤šæå–ï¼Œä¸è¦é—æ¼
- **ğŸ”´ğŸ”´ğŸ”´ è¶…çº§é‡è¦ï¼šåœºæ™¯æè¿°ç»å¯¹ä¸èƒ½åŒ…å«äººç‰©ï¼è¿™æ˜¯åœºæ™¯è®¾å®šå›¾ï¼**
  - âŒ ä¸¥ç¦å‡ºç°ï¼š"æ™‹å®‰ç«™åœ¨..."ã€"æ—æºªé å¢™..."ã€"æ™‹å®‰å–˜æ°”"ã€"è¿œå¤„ä¼ æ¥..."ç­‰äººç‰©æå†™
  - âŒ ä¸¥ç¦å‡ºç°ï¼šä»»ä½•è§’è‰²åå­—ã€äººç‰©åŠ¨ä½œã€äººç‰©çŠ¶æ€ã€è§’è‰²å¯¹è¯
  - âŒ é”™è¯¯ç¤ºèŒƒï¼š"æš—ç°è‰²æ•°æ®æ’æ±¡ç®¡é“...æ™‹å®‰é å¢™å–˜æ°”å·¦æ‰‹åŠé€æ˜è“è‰²ç¬¦æ–‡é—ªçƒ"
  - âœ… æ­£ç¡®åšæ³•ï¼šåªæè¿°å»ºç­‘ã€ç©ºé—´ã€ç‰©ä»¶ã€å…‰å½±ã€æè´¨ã€æ°›å›´
  - âœ… æ­£ç¡®ç¤ºèŒƒï¼š"æš—ç°è‰²æ•°æ®æ’æ±¡ç®¡é“ï¼Œç®¡å£å¯†å¯†éº»éº»çš„å¾®å…‰ç¬¦å·ï¼Œè§å…‰è‹”è—“æ•£å‘å†·å…‰ï¼Œç§¯æ°´åå°„é‡‘å±ç®¡é“è½®å»“ï¼Œæš—ç°å‹æŠ‘ç§‘æŠ€æ„Ÿ"
- **æ¯ä¸ªåœºæ™¯å¿…é¡»åŒ…å«ä»¥ä¸‹è¯¦ç»†ä¿¡æ¯**ï¼š
  1. **description**: åœºæ™¯çš„çº¯ç¯å¢ƒè®¾è®¡æè¿°ï¼ˆ80-150å­—ï¼‰ï¼Œå¿…é¡»åŒ…å«ï¼š
     - **å‰æ™¯**ï¼šæœ€é è¿‘é•œå¤´çš„ç‰©ä½“æˆ–å…ƒç´ ï¼ˆå¦‚ï¼šè½åœ°çª—æ¡†æ¶ã€è·¯ç¯ã€æ ‘æã€æ æ†ï¼‰
     - **ä¸­æ™¯**ï¼šä¸»è¦ç©ºé—´åŒºåŸŸçš„æè¿°ï¼ˆå¦‚ï¼šå®½æ•çš„èµ°å»Šã€è¯¾æ¡Œæ¤…æ’åˆ—æ•´é½ã€æ—é—´å°è·¯ï¼‰
     - **åæ™¯/è¿œæ™¯**ï¼šèƒŒæ™¯å»¶ä¼¸çš„ç©ºé—´æ„Ÿï¼ˆå¦‚ï¼šè¿œå¤„å¯è§æ“åœºã€çª—å¤–åŸå¸‚å¤©é™…çº¿ã€å±±å³¦è½®å»“ï¼‰
     - **å…‰å½±è®¾è®¡**ï¼šå…‰æºä½ç½®ã€æŠ•å°„æ–¹å‘ã€é˜´å½±åˆ†å¸ƒ
     - **è‰²è°ƒæ°›å›´**ï¼šæ•´ä½“è‰²è°ƒå€¾å‘ï¼ˆæš–è°ƒã€å†·è°ƒã€å¯¹æ¯”è‰²ç­‰ï¼‰
     - âŒ **ç¦æ­¢**ï¼šä»»ä½•äººç‰©æå†™ã€è§’è‰²åŠ¨ä½œã€äººç‰©ä½ç½®
  2. **visualPromptCn**: ä¸­æ–‡è§†è§‰æç¤ºè¯ï¼ˆ80-120å­—ï¼‰ï¼Œçº¯ç¯å¢ƒå…ƒç´ ï¼š
     - å»ºç­‘/ç©ºé—´ç»“æ„æè¿°
     - å…‰å½±æ°›å›´ï¼ˆå¦‚ï¼šæ˜æš—çš„ç¯å…‰ã€åˆºçœ¼çš„é˜³å…‰ã€å¹½è“çš„æœˆè‰²ï¼‰
     - æè´¨ç»†èŠ‚ï¼ˆå¦‚ï¼šæ–‘é©³çš„å¢™å£ã€å…‰æ»‘çš„é‡‘å±åœ°é¢ã€æ½®æ¹¿çš„çŸ³æ¿ï¼‰
     - ç‰¹å¾ç‰©ä»¶ï¼ˆå¦‚ï¼šå †å çš„è¯¾æ¡Œã€é—ªçƒçš„å…¨æ¯å±å¹•ã€æ¯èçš„æ ‘æœ¨ï¼‰
     - âŒ **ç¦æ­¢**ï¼šäººç‰©ã€è§’è‰²ã€äººç‰©åŠ¨ä½œ
  3. **visualPromptEn**: è‹±æ–‡è§†è§‰æç¤ºè¯ï¼ˆä¸ä¸­æ–‡å¯¹åº”ï¼Œ80-120å­—ï¼‰ï¼ŒåŒæ ·ä¸å«äººç‰©
  4. **atmosphere**: æ°›å›´å…³é”®è¯ï¼ˆå¦‚ï¼šæ—¥å¸¸å¹³é™ã€ç´§å¼ å‹æŠ‘ã€ç§‘æŠ€å†·é…·ï¼‰
  5. **appearsInEpisodes**: å‡ºç°åœ¨å“ªäº›é›†æ•°ï¼ˆä½¿ç”¨å®é™…é›†æ•°ï¼Œå¦‚ [${minEp}, ${minEp + 1}]ï¼‰
- ç¤ºä¾‹ï¼ˆçº¯ç¯å¢ƒæè¿°ï¼‰ï¼š
  | åœºæ™¯å | description |
  |--------|-------------|
  | åºŸå¼ƒå·¥å‚ | ã€å‰æ™¯ã€‘ç ´ç¢çš„ç»ç’ƒçª—æ¡†æ–œæ’åœ°é¢ï¼Œé”‹åˆ©è¾¹ç¼˜åå°„å¾®å…‰ï¼›ã€ä¸­æ™¯ã€‘é”ˆè¿¹æ–‘æ–‘çš„ä¼ é€å¸¦å’Œå€¾å€’çš„å·¥ä¸šè®¾å¤‡æ•£è½å„å¤„ï¼Œåœ°é¢ç§¯æ°´åå°„å¤©èŠ±æ¿ç ´æ´ï¼›ã€åæ™¯ã€‘å·¨å¤§çš„é”…ç‚‰è½®å»“åœ¨çƒŸå°˜ä¸­è‹¥éšè‹¥ç°ã€‚æ˜é»„æ–œé˜³ä»é¡¶éƒ¨ç ´æ´ç©¿å…¥å½¢æˆå…‰æŸ±ï¼Œæ•´ä½“å†·ç°è‰²è°ƒå¸¦é”ˆçº¢ç‚¹ç¼€ |
  | æ³¥æ²¼ç«¹æ— | ã€å‰æ™¯ã€‘å€’ä¼çš„ç«¹ç«¿åŠæ²¡å…¥æ³¥æ°´ï¼Œé’è‹”è¦†ç›–çš„çŸ³å¤´é›¶æ˜Ÿåˆ†å¸ƒï¼›ã€ä¸­æ™¯ã€‘å¯†é›†çš„ç«¹æ—åœ¨é›¾æ°”ä¸­è‹¥éšè‹¥ç°ï¼Œåœ°é¢æ³¥æ³ç§¯æ°´ï¼›ã€åæ™¯ã€‘è¿œå¤„å±±å³¦è½®å»“æ¨¡ç³Šï¼Œé›¾æ°”å¼¥æ¼«ã€‚å†·è°ƒé’ç°è‰²ï¼Œæ½®æ¹¿é˜´å†·çš„æ°›å›´ |

### 3. å‰§æƒ…åˆ†æï¼ˆğŸ”´ æ¯é›†æ¦‚è¦å¿…é¡»è¯¦ç»†å‡†ç¡®ï¼ï¼‰
- **æ¯é›†æ¦‚è¦ï¼ˆå¿…é¡»ï¼ï¼‰**ï¼š
  - âš ï¸ **ä¸¥æ ¼æŒ‰ç…§å‰§æœ¬ä¸­çš„é›†æ•°æ ‡æ³¨è¾“å‡º**ï¼Œæœ¬æ¬¡åˆ†æçš„å‰§é›†ä¸ºï¼š${episodeNumbers.join(', ')}
  - **episodeNumber å¿…é¡»ä¸å‰§æœ¬æ ‡æ³¨å®Œå…¨ä¸€è‡´**ï¼Œä¸è¦è‡ªå·±ç¼–å·ï¼
  - **title**: æœ¬é›†æ ‡é¢˜ï¼ˆ5-15å­—ï¼‰ï¼Œæ¦‚æ‹¬æœ¬é›†æ ¸å¿ƒå†…å®¹ï¼Œå¦‚"ä¸–ç•Œè§‚å´©å¡Œ"ã€"é“¸å‰‘é˜¶æ®µ"ã€"æœºç”²è§‰é†’"
  - **summary**: å‰§æƒ…æ¦‚è¦ï¼ˆâš ï¸ å¿…é¡» 50-100 å­—ï¼‰ï¼Œå¿…é¡»åŒ…å«ï¼š
    - **è°**ï¼šæœ¬é›†ä¸»è¦å‡ºåœºçš„è§’è‰²
    - **åšäº†ä»€ä¹ˆ**ï¼šæ ¸å¿ƒäº‹ä»¶ã€è¡ŒåŠ¨
    - **ç»“æœå¦‚ä½•**ï¼šå‰§æƒ…æ¨è¿›ã€çŠ¶æ€å˜åŒ–
    - âŒ é”™è¯¯ç¤ºèŒƒï¼š"æ™‹å®‰ç»§ç»­æ¢ç´¢" ï¼ˆå¤ªç®€å•ã€æ²¡æœ‰å…·ä½“å†…å®¹ï¼‰
    - âœ… æ­£ç¡®ç¤ºèŒƒï¼š"æ™‹å®‰åœ¨åºŸå¼ƒå·¥å‚å‘ç°é™ˆç‘¶å˜æˆçš„å¯„ç”Ÿå…½ï¼Œé¦–æ¬¡ä½¿ç”¨ç®¡ç†å‘˜æƒé™'åˆ é™¤æŒ‡ä»¤'æ¶ˆç­æ•Œäººï¼Œä½†æ—æºªå¯¹ä»–äº§ç”Ÿæ€€ç–‘"
- **åˆ†å·ç»“æ„**ï¼šå¦‚æœ‰æ˜æ˜¾çš„ç¯‡ç« åˆ’åˆ†ï¼ˆå¦‚ç¬¬ä¸€å·ã€ç¬¬äºŒç« ï¼‰ï¼Œè¯†åˆ«å‡ºæ¥
- **è§’è‰²çŠ¶æ€è¿½è¸ª characterStates**ï¼šè®°å½•æ¯é›†ä¸­ä¸»è¦è§’è‰²çš„**å…·ä½“çŠ¶æ€å˜åŒ–**
  - stateDescription å¿…é¡»å…·ä½“ï¼Œå¦‚"é¦–æ¬¡è§‰é†’ç®¡ç†å‘˜èƒ½åŠ›"ã€"å—é‡ä¼¤æ˜è¿·"ã€"ä¹‰ä½“è¿‡çƒ­æ¿’æ­»"

### 4. ä¸“æœ‰åè¯
- æå–æ‰€æœ‰ç‹¬ç‰¹æœ¯è¯­å¹¶è§£é‡Šï¼Œå¦‚ï¼šå¼‚èƒ½åç§°ã€åœ°ç‚¹åç§°ã€ç»„ç»‡åç§°ç­‰

## ğŸ“– å‰§æœ¬å†…å®¹ï¼ˆå…±${scripts.length}é›†ï¼‰
${combinedContent}

## è¾“å‡ºè¦æ±‚ï¼ˆJSONæ ¼å¼ï¼‰
\`\`\`json
{
  "worldView": "è¿‘æœªæ¥éƒ½å¸‚ä¸–ç•Œï¼ŒAIä¸»è„‘'åäºŒæ˜Ÿå®«'ç»Ÿæ²»ç€è¡¨é¢ç§©åºäº•ç„¶çš„ç¤¾ä¼šï¼Œä½†å®é™…ä¸Šæ‰€æœ‰äººç±»éƒ½æ˜¯è¢«å‘½è¿ç®—æ³•é¢„å®šçš„NPCã€‚ä¸»è§’æ™‹å®‰æ˜¯ç³»ç»Ÿä¸­å”¯ä¸€çš„BUGâ€”â€”ä¸€ä¸ªæœ¬ä¸åº”è¯¥å­˜åœ¨çš„'çœŸå®äººç±»'ã€‚ä»–æ‹¥æœ‰ç ´åç³»ç»Ÿè§„åˆ™çš„èƒ½åŠ›ï¼Œå¯ä»¥çœ‹åˆ°æ™®é€šäººçœ‹ä¸åˆ°çš„'ä»£ç å±‚'ï¼Œå¹¶é€æ¸è§‰é†’äº†'ç®¡ç†å‘˜æƒé™'ã€‚ä¸–ç•Œåˆ†ä¸ºçœŸå®å±‚å’Œè™šæ‹Ÿå±‚ï¼Œå¯„ç”Ÿå…½æ˜¯è¢«æ±¡æŸ“çš„æ•°æ®å…·è±¡åŒ–çš„äº§ç‰©ï¼Œæœºç”²ç±»äººå°–å…µæ˜¯AIçš„æ‰§è¡Œè€…ã€‚æ•…äº‹å›´ç»•æ™‹å®‰å¦‚ä½•åœ¨ç³»ç»Ÿè¿½æ€ä¸‹ç”Ÿå­˜ã€è§‰é†’ã€æœ€ç»ˆä¸AIä¸»è„‘å¯¹æŠ—å±•å¼€ã€‚",
  "genre": "ç§‘å¹» / éƒ½å¸‚ / çŸ­å‰§",
  "visualStyle": "æ—¥ç³»èµ›åšæœ‹å…‹+ç§‘æŠ€æ„Ÿ",
  "keyTerms": [{ "term": "æœ¯è¯­", "explanation": "è§£é‡Š" }],
  "volumes": [{ "volumeNumber": 1, "title": "å·æ ‡é¢˜", "episodeRange": [1, 20], "coreConflict": "æ ¸å¿ƒå†²çª", "keyPlots": ["å‰§æƒ…1"], "color": "#22c55e" }],

  "characters": [
    {
      "name": "æ™‹å®‰",
      "gender": "ç”·",
      "ageGroup": "é’å¹´",
      "description": "ã€ä¸»è§’ã€‘ç”·ï¼Œ18å²ï¼Œé«˜ä¸­ç”Ÿï¼Œç³»ç»Ÿä¸­å”¯ä¸€çš„BUGï¼Œæ‹¥æœ‰ç®¡ç†å‘˜æƒé™",
      "quote": "æˆ‘æ˜¯ç—…æ¯’ï¼Œæ˜¯Bugï¼Œä¹Ÿæ˜¯çˆ±ä½ çš„å¹½çµ",
      "identityEvolution": "é«˜ä¸­ç”Ÿ â” è§‰é†’NPC â” æœºç”²é©¾é©¶å‘˜ â” æ•‘ä¸–ä¸»",
      "abilities": ["ç®¡ç†å‘˜é¢æ¿", "ä¹‰ä½“è¶…é¢‘", "åº•å±‚ä¿®æ”¹"],
      "appearance": "ã€å¤–è²Œç‰¹å¾ã€‘æµ…æ£•è‰²ç¢çŸ­å‘ã€å‘å‹è“¬æ¾æœ‰å±‚æ¬¡æ„Ÿã€æ·±æ£•è‰²ç‹­é•¿çœ¼çœ¸ã€äº”å®˜æ¸…çˆ½åˆ©è½ã€è¡¨æƒ…å¹³é™ç•¥å¸¦æ¸…å†·æ„Ÿã€èº«å½¢é«˜æŒ‘çº¤ç˜¦ã€è‚¤è‰²ç™½çš™ã€å°‘å¹´æ„Ÿä½“æ€\\nã€ä¸»ä½“äººç‰©ã€‘æ—¥ç³»åŠ¨æ¼«é£æ ¼å¹´è½»ç”·æ€§ï¼ˆé«˜ä¸­ç”Ÿå½¢è±¡ï¼‰ã€äºŒæ¬¡å…ƒå°‘å¹´ã€æ¸…ç˜¦ä¿®é•¿çš„èº«å½¢ã€ç®€çº¦å¹²å‡€çš„æ°”è´¨\\nã€æœé¥°é€ å‹ã€‘çº¯ç™½è‰²åœ†é¢†çŸ­è¢–Tæ¤ï¼ˆç‰ˆå‹å®½æ¾æœ‰è‡ªç„¶è¤¶çš±ï¼‰ã€é»‘è‰²ä¿®èº«é•¿è£¤ï¼ˆç®€çº¦ä¼‘é—²æ¬¾ï¼‰ã€é»‘ç™½æ‹¼è‰²è¿åŠ¨é‹ï¼ˆæ¬¾å¼è½»ä¾¿æ—¥å¸¸ï¼‰ã€ä¼‘é—²æ—¥å¸¸é£ç©¿æ­",
      "appearsInEpisodes": [${minEp}, ${minEp + 1}, ${minEp + 2}],
      "forms": [
        {
          "name": "ğŸ’ æ—¥å¸¸ä¼‘é—²",
          "episodeRange": "Ep 1-20",
          "description": "ã€å¤–è²Œç‰¹å¾ã€‘æµ…æ£•è‰²ç¢çŸ­å‘ã€å‘å‹è“¬æ¾æœ‰å±‚æ¬¡æ„Ÿã€æ·±æ£•è‰²ç‹­é•¿çœ¼çœ¸ã€äº”å®˜æ¸…çˆ½åˆ©è½ã€è¡¨æƒ…å¹³é™ç•¥å¸¦æ¸…å†·æ„Ÿã€èº«å½¢é«˜æŒ‘çº¤ç˜¦ã€è‚¤è‰²ç™½çš™ã€å°‘å¹´æ„Ÿä½“æ€\\nã€ä¸»ä½“äººç‰©ã€‘æ—¥ç³»åŠ¨æ¼«é£æ ¼å¹´è½»ç”·æ€§ï¼ˆé«˜ä¸­ç”Ÿå½¢è±¡ï¼‰ã€äºŒæ¬¡å…ƒå°‘å¹´ã€æ¸…ç˜¦ä¿®é•¿çš„èº«å½¢ã€ç®€çº¦å¹²å‡€çš„æ°”è´¨\\nã€æœé¥°é€ å‹ã€‘çº¯ç™½è‰²åœ†é¢†çŸ­è¢–Tæ¤ï¼ˆç‰ˆå‹å®½æ¾æœ‰è‡ªç„¶è¤¶çš±ï¼‰ã€é»‘è‰²ä¿®èº«é•¿è£¤ï¼ˆç®€çº¦ä¼‘é—²æ¬¾ï¼‰ã€é»‘ç™½æ‹¼è‰²è¿åŠ¨é‹ï¼ˆæ¬¾å¼è½»ä¾¿æ—¥å¸¸ï¼‰ã€ä¼‘é—²æ—¥å¸¸é£ç©¿æ­",
          "note": "æ—¥å¸¸çŠ¶æ€ï¼Œä¼ªè£…æœŸ",
          "visualPromptCn": "æ—¥ç³»åŠ¨æ¼«é£æ ¼å°‘å¹´ï¼Œæµ…æ£•è‰²è“¬æ¾ç¢çŸ­å‘ï¼Œæ·±æ£•è‰²ç‹­é•¿çœ¼çœ¸ï¼Œäº”å®˜æ¸…çˆ½åˆ©è½ï¼Œè¡¨æƒ…å¹³é™æ¸…å†·ï¼Œèº«å½¢é«˜æŒ‘çº¤ç˜¦ï¼Œè‚¤è‰²ç™½çš™ï¼Œç©¿ç™½è‰²å®½æ¾åœ†é¢†Tæ¤ï¼Œé»‘è‰²ä¿®èº«é•¿è£¤ï¼Œé»‘ç™½è¿åŠ¨é‹",
          "visualPromptEn": "anime style young male, light brown fluffy short hair, deep brown narrow eyes, clean sharp features, calm expression, tall slender figure, fair skin, loose white t-shirt, black slim pants, black-white sneakers"
        },
        {
          "name": "ğŸ”¥ ç„šè¡£å½¢æ€",
          "episodeRange": "Ep 20",
          "description": "ã€å¤–è²Œç‰¹å¾ã€‘æµ…æ£•çŸ­å‘å‡Œä¹±ï¼Œçœ¼ç¥å‡Œå‰ï¼Œäº”å®˜è½®å»“æ›´æ·±åˆ»ï¼Œè¡¨æƒ…å†·å³»ï¼Œä¸Šèº«èµ¤è£¸éœ²å‡ºçº¤ç»†è‚Œè‚‰çº¿æ¡\\nã€ä¸»ä½“äººç‰©ã€‘æ—¥ç³»åŠ¨æ¼«é£æ ¼å¹´è½»ç”·æ€§ï¼Œæ°”è´¨ä»å°‘å¹´è½¬ä¸ºå†·é…·\\nã€æœé¥°é€ å‹ã€‘èµ¤è£¸ä¸Šèº«ï¼Œä»…ç©¿é»‘è‰²é•¿è£¤ï¼Œèµ¤è¶³",
          "note": "è½¬æŠ˜ç‚¹ï¼Œç¬¬ä¸€æ¬¡å±•ç°å†·å³»ä¸€é¢",
          "visualPromptCn": "æ—¥ç³»åŠ¨æ¼«é£æ ¼å°‘å¹´ï¼Œæµ…æ£•çŸ­å‘å‡Œä¹±ï¼Œæ·±æ£•çœ¼çœ¸é€å‡ºå‡Œå‰ï¼Œäº”å®˜æ·±åˆ»å†·å³»ï¼Œèµ¤è£¸ä¸Šèº«å±•ç°çº¤ç»†è‚Œè‚‰çº¿æ¡ï¼Œä»…ç©¿é»‘è‰²é•¿è£¤ï¼Œèµ¤è¶³ï¼Œç«å…‰æ˜ ç…§åœ¨çš®è‚¤ä¸Š",
          "visualPromptEn": "anime style young male, messy light brown hair, piercing deep brown eyes, sharp cold features, bare upper body showing lean muscles, only black pants, barefoot, firelight on skin"
        }
      ]
    }
  ],

  "antagonists": [{ "name": "AIä¸»è„‘", "volumeOrArc": "æœºæ¢°ç¯‡", "formDescription": "å·¨å¤§é»‘è‰²å…‰çƒ", "outcome": "è¢«å‡€åŒ–" }],

  "scenes": [
    {
      "name": "æ•™å®¤",
      "description": "ã€å‰æ™¯ã€‘æœ¨è´¨çª—æ¡†å’ŒåŠæ‹‰çš„è“è‰²çª—å¸˜ï¼Œçª—å°æ”¾ç€ç›†æ ½ï¼›ã€ä¸­æ™¯ã€‘å…­æ’æµ…è“è‰²è¯¾æ¡Œæ¤…æ•´é½æ’åˆ—ï¼Œè¿‡é“å®½æ•æ˜äº®ï¼›ã€åæ™¯ã€‘é»‘æ¿ä¸Šæ®‹ç•™ç²‰ç¬”å­—è¿¹ï¼Œé»‘æ¿ä¸Šæ–¹æŒ‚ç€æ—¶é’Ÿã€‚åˆåé˜³å…‰ä»å·¦ä¾§æ–œç…§è¿›æ¥ï¼Œåœ¨åœ°é¢æŠ•ä¸‹æ ¼å­çª—å½±ï¼Œæ•´ä½“æš–é»„è‰²è°ƒï¼Œå°˜åŸƒåœ¨å…‰çº¿ä¸­æ¼‚æµ®",
      "visualPromptCn": "é˜³å…‰é€è¿‡åŠæ‹‰çª—å¸˜æ–œç…§å…¥å®¤ï¼Œæµ…è“è‰²è¯¾æ¡Œæ¤…æ•´é½æ’åˆ—å…­æ’ï¼Œé»‘æ¿ä¸Šæ®‹ç•™ç€ç²‰ç¬”å­—è¿¹ï¼Œçª—è¾¹ç»¿æ¤å¾®å¾®æ‘‡æ›³ï¼Œç©ºæ°”ä¸­æµ®åŠ¨ç€ç»†å¾®å°˜åŸƒï¼Œåœ°é¢åå°„æŸ”å’Œå…‰æ³½ï¼Œå¢™å£è´´ç€å­¦ä¹ æ ‡è¯­",
      "visualPromptEn": "sunlight streaming through half-drawn curtains, six rows of light blue desks neatly arranged, chalk marks on blackboard, potted plants by window, dust particles floating in air, floor reflecting soft light, study posters on walls",
      "atmosphere": "æ—¥å¸¸å¹³é™",
      "appearsInEpisodes": [${minEp},${minEp + 1}]
    },
    {
      "name": "åºŸå¼ƒå·¥å‚",
      "description": "ã€å‰æ™¯ã€‘ç ´ç¢çš„ç»ç’ƒçª—æ¡†æ–œæ’åœ°é¢ï¼Œé”‹åˆ©è¾¹ç¼˜åå°„å¾®å…‰ï¼›ã€ä¸­æ™¯ã€‘é”ˆè¿¹æ–‘æ–‘çš„ä¼ é€å¸¦å’Œå€¾å€’çš„å·¥ä¸šè®¾å¤‡æ•£è½å„å¤„ï¼Œåœ°é¢ç§¯æ°´åå°„å¤©èŠ±æ¿çš„ç ´æ´ï¼›ã€åæ™¯ã€‘å·¨å¤§çš„é”…ç‚‰è½®å»“åœ¨çƒŸå°˜ä¸­è‹¥éšè‹¥ç°ï¼Œè¿œå¤„å¢™å£åå¡Œéœ²å‡ºå¤–é¢çš„è’åœ°ã€‚æ˜é»„æ–œé˜³ä»é¡¶éƒ¨ç ´æ´ç©¿å…¥å½¢æˆå…‰æŸ±ï¼Œæ•´ä½“å†·ç°è‰²è°ƒå¸¦é”ˆçº¢ç‚¹ç¼€",
      "visualPromptCn": "é”ˆè¿¹æ–‘æ–‘çš„é’¢æ¢äº¤é”™ï¼Œç ´ç¢ç»ç’ƒçª—é€å…¥æ˜é»„æ–œé˜³å½¢æˆå…‰æŸ±ï¼Œåœ°é¢æ•£è½ç”Ÿé”ˆæœºæ¢°é›¶ä»¶å’Œç¢ç»ç’ƒï¼Œç§¯æ°´å€’æ˜ å¤©èŠ±æ¿ç ´æ´ï¼Œå¢™å£çˆ¬æ»¡è—¤è”“ï¼Œèœ˜è››ç½‘æŒ‚åœ¨è§’è½ï¼Œè¿œå¤„é”…ç‚‰è‹¥éšè‹¥ç°",
      "visualPromptEn": "rusty steel beams crossing, broken windows with dim yellow sunlight forming light shafts, scattered rusty machinery and glass shards on floor, puddles reflecting ceiling holes, vines on walls, cobwebs in corners, distant boiler silhouette in dust",
      "atmosphere": "è’åºŸé¢“åºŸ",
      "appearsInEpisodes": [${minEp + 2}]
    }
  ],

  "episodeSummaries": [
    {
      "episodeNumber": ${minEp},
      "title": "ä¸–ç•Œè§‚å´©å¡Œ",
      "summary": "æ™‹å®‰åœ¨åºŸå¼ƒå·¥å‚å‘ç°é™ˆç‘¶å˜æˆçš„å¯„ç”Ÿå…½ï¼Œé¦–æ¬¡ä½¿ç”¨ç®¡ç†å‘˜æƒé™'åˆ é™¤æŒ‡ä»¤'æ¶ˆç­æ•Œäººï¼Œä½†æ—æºªå¯¹ä»–äº§ç”Ÿæ€€ç–‘ï¼Œä¸¤äººå…³ç³»å‡ºç°è£‚ç—•",
      "characterStates": [
        { "characterName": "æ™‹å®‰", "stateDescription": "é¦–æ¬¡è§‰é†’ç®¡ç†å‘˜èƒ½åŠ›ï¼Œç²¾ç¥å—åˆ°å†²å‡»" },
        { "characterName": "æ—æºª", "stateDescription": "ç›®ç¹æ™‹å®‰å¼‚èƒ½ï¼Œå¼€å§‹æ€€ç–‘å…¶èº«ä»½" }
      ]
    },
    {
      "episodeNumber": ${minEp + 1},
      "title": "é“¸å‰‘é˜¶æ®µ",
      "summary": "æ™‹å®‰åœ¨é“åŒ é“ºå­¦ä¹ é”»é€ æŠ€æœ¯ï¼Œä¸è€é“åŒ å»ºç«‹å¸ˆå¾’å…³ç³»ï¼ŒåŒæ—¶å‘ç°è‡ªå·±çš„èƒ½åŠ›å¯ä»¥å½±å“ç‰©è´¨ç»“æ„ï¼Œä¸ºåç»­æˆ˜æ–—åšå‡†å¤‡",
      "characterStates": [
        { "characterName": "æ™‹å®‰", "stateDescription": "å­¦ä¹ é”»é€ ï¼Œå‘ç°æ–°èƒ½åŠ›" }
      ]
    }
  ],

  "suggestedMainCharacters": [
    {
      "name": "æ™‹å®‰",
      "reason": "å‡ºåœºé¢‘ç‡æœ€é«˜ï¼Œç¬¬ä¸€è§†è§’ï¼Œå‰§æƒ…å›´ç»•å…¶è§‰é†’å’Œæˆé•¿å±•å¼€ï¼Œæ˜¯ç³»ç»Ÿä¸­å”¯ä¸€çš„BUG"
    },
    {
      "name": "æ—æºª",
      "reason": "é‡è¦é…è§’ï¼Œä¸ä¸»è§’æœ‰æ·±åšæƒ…æ„Ÿè”ç³»ï¼Œå¤šæ¬¡å‚ä¸å…³é”®å‰§æƒ…"
    }
  ]
}
\`\`\`

ğŸš¨ğŸš¨ğŸš¨ **è¾“å‡ºå‰æœ€åæ£€æŸ¥ï¼ˆå¿…é¡»ç¡®è®¤ï¼‰**ï¼š
1. âœ… æ¯ä¸ªè§’è‰²çš„appearanceå­—æ®µéƒ½åŒ…å«ã€æœé¥°é€ å‹ã€‘éƒ¨åˆ†
2. âœ… ã€æœé¥°é€ å‹ã€‘æ˜¯å…·ä½“æè¿°ï¼ˆå¦‚"ç„è‰²é•¿è¢ã€é“¶è´¨è…°å¸¦"ï¼‰ï¼Œä¸æ˜¯å ä½ç¬¦
3. âŒ ç»å¯¹ä¸èƒ½å‡ºç°"é»˜è®¤å½¢æ€è§formsæ•°ç»„"ã€"è§formsæ•°ç»„"ç­‰å ä½ç¬¦
4. âœ… ç‰¹æ®ŠçŠ¶æ€ï¼ˆå—ä¼¤ã€æˆ˜æŸï¼‰åº”åœ¨formsæ•°ç»„ä¸­ï¼Œä¸åœ¨appearanceä¸­

## âš ï¸ ä¸¥æ ¼è¦æ±‚ï¼ˆå¿…é¡»éµå®ˆï¼ï¼‰

### ğŸš¨ æœ€é‡è¦ï¼šå®Œæ•´æå–ï¼Œä¸è¦é—æ¼ï¼
- **è§’è‰²**ï¼šæœ¬æ‰¹å‰§æœ¬ä¸­å‡ºç°çš„æ‰€æœ‰æœ‰åå­—çš„è§’è‰²éƒ½è¦æå–ï¼ä¸åªæ˜¯ä¸»è§’ï¼
- **åœºæ™¯**ï¼šæ¯ä¸ªSceneéƒ½è¦å•ç‹¬æå–ï¼å¦‚æœå‰§æœ¬æœ‰Scene 1-30ï¼Œå°±è¦æœ‰30ä¸ªåœºæ™¯ï¼
- **æ¦‚è¦**ï¼šæ¯é›†éƒ½è¦æœ‰50-100å­—çš„è¯¦ç»†æ¦‚è¦ï¼ä¸æ˜¯ä¸€å¥è¯ï¼
- **å½¢æ€**ï¼šè§’è‰²æœ‰æ¢è£…/å˜å½¢å°±å¿…é¡»è®°å½•ï¼

### 1. episodeSummaries å¿…é¡»ä¸å‰§æœ¬é›†æ•°å®Œå…¨åŒ¹é…
   - æœ¬æ¬¡åˆ†æçš„å‰§é›†ä¸ºï¼š${episodeNumbers.join(', ')}ï¼ˆå…±${scripts.length}é›†ï¼‰
   - **episodeNumber å¿…é¡»ä½¿ç”¨å‰§æœ¬ä¸­çš„å®é™…é›†æ•°**ï¼Œä¸è¦ä»1å¼€å§‹ç¼–å·ï¼
   - ä¾‹å¦‚ï¼šå¦‚æœå‰§æœ¬æ˜¯ç¬¬21-30é›†ï¼Œé‚£ä¹ˆ episodeNumber å°±æ˜¯ 21, 22, 23... ä¸æ˜¯ 1, 2, 3

### 2. forms æ•°ç»„çš„ episodeRangeï¼ˆå…³é”®ï¼ï¼‰
   - âš ï¸ **å¿…é¡»ä½¿ç”¨æœ¬æ¬¡å‰§æœ¬çš„å®é™…é›†æ•°èŒƒå›´ï¼š${episodeNumbers.join(', ')}**
   - âŒ é”™è¯¯ç¤ºèŒƒï¼šæœ¬æ¬¡åˆ†æç¬¬21-40é›†ï¼Œä½†formså†™"Ep 1-20"æˆ–"Ep 1-4"
   - âœ… æ­£ç¡®åšæ³•ï¼šå¦‚æœè§’è‰²å½¢æ€åœ¨æœ¬æ‰¹å‰§æœ¬çš„ç¬¬21-25é›†å‡ºç°ï¼Œå°±å†™"Ep 21-25"
   - **description å¿…é¡»è¯¦ç»†**ï¼š30-50å­—ï¼ŒåŒ…å«æœè£…ç»†èŠ‚ã€é¢œè‰²ã€ç‰¹å¾ç‰©å“ã€çŠ¶æ€æè¿°
   - æ²¡æœ‰å˜è£…çš„è§’è‰²formså¯ä»¥ä¸ºç©ºæ•°ç»„

### 3. scenes çš„è§†è§‰æç¤ºè¯ï¼ˆé‡è¦ï¼ï¼‰
   - **visualPromptCn/En å¿…é¡»è¯¦ç»†**ï¼š50-80å­—ï¼Œä¸èƒ½åªå†™"æ˜äº®æ•™å®¤ï¼Œè¯¾æ¡Œæ•´é½"
   - å¿…é¡»åŒ…å«ï¼šå…‰å½±æ°›å›´ã€æè´¨ç»†èŠ‚ã€ç‰¹å¾ç‰©ä»¶ã€ç©ºé—´ç»“æ„
   - âš ï¸ **ä¸è¦åŒ…å«äººç‰©æå†™**ï¼Œçº¯ç¯å¢ƒæè¿°
   - è¿™äº›æç¤ºè¯å°†ç›´æ¥ç”¨äºAIç”Ÿå›¾ï¼Œç»†èŠ‚è¶Šä¸°å¯Œç”Ÿå›¾æ•ˆæœè¶Šå¥½

### 4. è¾“å‡ºæ ¼å¼
   - **åªè¾“å‡ºJSON**ï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—
   - **JSONå¿…é¡»å®Œæ•´**ï¼Œä¸è¦çœç•¥æˆ–ç”¨...ä»£æ›¿
`;

  try {
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${import.meta.env.VITE_OPENROUTER1_API_KEY}`,
        'HTTP-Referer': window.location.origin,
      },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.3,
        // ğŸ”§ v6ä¿®å¤ï¼šæ ¹æ®æ¨¡å‹èƒ½åŠ›è®¾ç½® max_tokensï¼Œå……åˆ†åˆ©ç”¨æ¨¡å‹è¾“å‡ºèƒ½åŠ›
        // Gemini 2.5/3 Flash Preview: 65,535 output tokens â†’ ç”¨32Kè¶³å¤Ÿä¸”æ›´ç¨³å®š
        // Gemini 2.0 Flash: 8,192 output tokens
        // Claude 3.5: 8,192 output tokens
        // GPT-4o: 16,384 output tokens
        // å¤§è¾“å‡ºé‡ç¡®ä¿è§’è‰²/åœºæ™¯åˆ—è¡¨ä¸è¢«æˆªæ–­
        max_tokens: model.includes('gemini') && !model.includes('gemini-2.0') ? 32000 :  // Gemini 2.5/3 ç­‰æ–°ç‰ˆæœ¬
                    model.includes('gemini-2.0') ? 8192 :   // Gemini 2.0 è€ç‰ˆæœ¬
                    model.includes('gpt-4o-mini') ? 16000 :
                    model.includes('claude') ? 8192 : 32000,
      }),
    });

    if (!response.ok) {
      if (response.status === 402) {
        throw new Error('APIä½™é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥OpenRouterè´¦æˆ·ä½™é¢æˆ–ä½¿ç”¨è·³è¿‡åˆ†æåŠŸèƒ½');
      }
      if (response.status === 401) {
        throw new Error('API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥VITE_OPENROUTER1_API_KEYé…ç½®');
      }
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content || '';

    // è§£æJSON
    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                      content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      console.error('[åˆ†æ] æ— æ³•åŒ¹é…JSONï¼ŒåŸå§‹å†…å®¹:', content.substring(0, 500));
      throw new Error('æ— æ³•è§£æAIè¿”å›çš„JSON');
    }

    let jsonStr = jsonMatch[1] || jsonMatch[0];

    // å°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
    const result = parseJsonWithFixes(jsonStr);

    // è°ƒè¯•æ—¥å¿—
    console.log('[åˆ†æ] è§£ææˆåŠŸï¼ŒepisodeSummariesæ•°é‡:', result.episodeSummaries?.length || 0);
    if (result.episodeSummaries?.length > 0) {
      console.log('[åˆ†æ] å‰3é›†ç¤ºä¾‹:', result.episodeSummaries.slice(0, 3));
    }

    // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼ˆåœºæ™¯ç”±AIæ™ºèƒ½åˆ†æï¼Œä¸ä½¿ç”¨æ­£åˆ™æå–ï¼‰
    const normalizedResult = normalizeAnalysisResult(result, scripts);

    return normalizedResult;
  } catch (error) {
    console.error('é¡¹ç›®åˆ†æå¤±è´¥:', error);
    // ğŸ”§ v7ä¿®å¤ï¼šè¿”å›é»˜è®¤ç»“æœæ—¶ï¼Œä¼ é€’é¢„æ‰«æçš„è§’è‰²å’Œåœºæ™¯
    const preScanResult = knownCharacters.length > 0 || knownScenes.length > 0
      ? { characterNames: knownCharacters, sceneNames: knownScenes }
      : undefined;
    return createDefaultAnalysisResult(scripts, preScanResult);
  }
}

/**
 * å°è¯•è§£æJSONï¼Œè‡ªåŠ¨ä¿®å¤å¸¸è§é”™è¯¯
 */
function parseJsonWithFixes(jsonStr: string): any {
  // ç¬¬ä¸€æ¬¡å°è¯•ï¼šç›´æ¥è§£æ
  try {
    return JSON.parse(jsonStr);
  } catch (e) {
    console.log('JSONè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...');
  }

  // ä¿®å¤1ï¼šç§»é™¤å°¾éƒ¨é€—å·
  let fixed = jsonStr.replace(/,\s*([}\]])/g, '$1');
  try {
    return JSON.parse(fixed);
  } catch (e) {}

  // ä¿®å¤2ï¼šä¿®å¤æœªé—­åˆçš„å­—ç¬¦ä¸²ï¼ˆåœ¨æ¢è¡Œç¬¦å¤„ï¼‰
  fixed = fixed.replace(/:\s*"([^"]*)\n/g, ': "$1",\n');
  try {
    return JSON.parse(fixed);
  } catch (e) {}

  // ä¿®å¤3ï¼šæˆªæ–­åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆçš„é—­åˆæ‹¬å·
  const lastBrace = fixed.lastIndexOf('}');
  if (lastBrace > 0) {
    let truncated = fixed.substring(0, lastBrace + 1);
    // ç¡®ä¿æ‹¬å·å¹³è¡¡
    const openBraces = (truncated.match(/\{/g) || []).length;
    const closeBraces = (truncated.match(/\}/g) || []).length;
    const openBrackets = (truncated.match(/\[/g) || []).length;
    const closeBrackets = (truncated.match(/\]/g) || []).length;

    // æ·»åŠ ç¼ºå¤±çš„é—­åˆæ‹¬å·
    for (let i = 0; i < openBrackets - closeBrackets; i++) {
      truncated += ']';
    }
    for (let i = 0; i < openBraces - closeBraces; i++) {
      truncated += '}';
    }

    try {
      return JSON.parse(truncated);
    } catch (e) {}
  }

  // ä¿®å¤4ï¼šæå–éƒ¨åˆ†æœ‰æ•ˆæ•°æ®
  const partialResult: any = {};

  // æå– worldView
  const worldViewMatch = jsonStr.match(/"worldView"\s*:\s*"([^"]*(?:\\.[^"]*)*)"/);
  if (worldViewMatch) {
    partialResult.worldView = worldViewMatch[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
  }

  // æå– genre
  const genreMatch = jsonStr.match(/"genre"\s*:\s*"([^"]*)"/);
  if (genreMatch) {
    partialResult.genre = genreMatch[1];
  }

  // æå– visualStyle
  const styleMatch = jsonStr.match(/"visualStyle"\s*:\s*"([^"]*)"/);
  if (styleMatch) {
    partialResult.visualStyle = styleMatch[1];
  }

  // æå–è§’è‰²æ•°ç»„ï¼ˆğŸ”§ v5å¢å¼ºï¼šå°½å¯èƒ½ä¿ç•™æ›´å¤šä¿¡æ¯ï¼‰
  const charsMatch = jsonStr.match(/"characters"\s*:\s*\[([\s\S]*?)\](?=\s*[,}])/);
  if (charsMatch) {
    try {
      // å°è¯•ä¿®å¤è§’è‰²æ•°ç»„
      let charsStr = '[' + charsMatch[1] + ']';
      charsStr = charsStr.replace(/,\s*\]/g, ']');
      partialResult.characters = JSON.parse(charsStr);
    } catch (e) {
      // ğŸ”§ v5å¢å¼ºï¼šé€ä¸ªæå–è§’è‰²å¯¹è±¡ï¼Œå°½å¯èƒ½ä¿ç•™æ›´å¤šå­—æ®µ
      console.log('[JSONä¿®å¤] è§’è‰²æ•°ç»„è§£æå¤±è´¥ï¼Œå°è¯•é€ä¸ªæå–...');
      const charObjects: any[] = [];
      // åŒ¹é…æ¯ä¸ªè§’è‰²å¯¹è±¡ {...}
      const charObjMatches = charsMatch[1].matchAll(/\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g);
      for (const objMatch of charObjMatches) {
        try {
          const charObj = JSON.parse('{' + objMatch[1] + '}');
          if (charObj.name) charObjects.push(charObj);
        } catch {
          // æ— æ³•è§£æå®Œæ•´å¯¹è±¡ï¼Œæå–å…³é”®å­—æ®µ
          const nameMatch = objMatch[1].match(/"name"\s*:\s*"([^"]*)"/);
          const genderMatch = objMatch[1].match(/"gender"\s*:\s*"([^"]*)"/);
          const appearanceMatch = objMatch[1].match(/"appearance"\s*:\s*"([^"]*)"/);
          if (nameMatch) {
            charObjects.push({
              name: nameMatch[1],
              gender: genderMatch?.[1] || 'æœªçŸ¥',
              appearance: appearanceMatch?.[1] || '',
            });
          }
        }
      }
      if (charObjects.length > 0) {
        partialResult.characters = charObjects;
        console.log(`[JSONä¿®å¤] æˆåŠŸæå– ${charObjects.length} ä¸ªè§’è‰²`);
      } else {
        // æœ€åå›é€€ï¼šåªæå–åå­—
        const charMatches = charsMatch[1].matchAll(/"name"\s*:\s*"([^"]*)"/g);
        partialResult.characters = Array.from(charMatches).map(m => ({ name: m[1] }));
      }
    }
  }

  // æå–åœºæ™¯æ•°ç»„ï¼ˆğŸ”§ v5å¢å¼ºï¼šå°½å¯èƒ½ä¿ç•™æ›´å¤šä¿¡æ¯ï¼‰
  const scenesMatch = jsonStr.match(/"scenes"\s*:\s*\[([\s\S]*?)\](?=\s*[,}])/);
  if (scenesMatch) {
    try {
      let scenesStr = '[' + scenesMatch[1] + ']';
      scenesStr = scenesStr.replace(/,\s*\]/g, ']');
      partialResult.scenes = JSON.parse(scenesStr);
    } catch (e) {
      // ğŸ”§ v5å¢å¼ºï¼šé€ä¸ªæå–åœºæ™¯å¯¹è±¡
      console.log('[JSONä¿®å¤] åœºæ™¯æ•°ç»„è§£æå¤±è´¥ï¼Œå°è¯•é€ä¸ªæå–...');
      const sceneObjects: any[] = [];
      const sceneObjMatches = scenesMatch[1].matchAll(/\{([^{}]*(?:\{[^{}]*\}[^{}]*)*)\}/g);
      for (const objMatch of sceneObjMatches) {
        try {
          const sceneObj = JSON.parse('{' + objMatch[1] + '}');
          if (sceneObj.name) sceneObjects.push(sceneObj);
        } catch {
          const nameMatch = objMatch[1].match(/"name"\s*:\s*"([^"]*)"/);
          const descMatch = objMatch[1].match(/"description"\s*:\s*"([^"]*)"/);
          const promptCnMatch = objMatch[1].match(/"visualPromptCn"\s*:\s*"([^"]*)"/);
          if (nameMatch) {
            sceneObjects.push({
              name: nameMatch[1],
              description: descMatch?.[1] || '',
              visualPromptCn: promptCnMatch?.[1] || '',
            });
          }
        }
      }
      if (sceneObjects.length > 0) {
        partialResult.scenes = sceneObjects;
        console.log(`[JSONä¿®å¤] æˆåŠŸæå– ${sceneObjects.length} ä¸ªåœºæ™¯`);
      } else {
        const sceneMatches = scenesMatch[1].matchAll(/"name"\s*:\s*"([^"]*)"/g);
        partialResult.scenes = Array.from(sceneMatches).map(m => ({ name: m[1] }));
      }
    }
  }

  if (Object.keys(partialResult).length > 0) {
    console.log('ä½¿ç”¨éƒ¨åˆ†æå–çš„æ•°æ®:', partialResult);
    return partialResult;
  }

  throw new Error('æ— æ³•ä¿®å¤JSONæ ¼å¼');
}

/**
 * æ ‡å‡†åŒ–åˆ†æç»“æœ
 * æ”¯æŒè§’è‰²å¤šå½¢æ€ã€åˆ†å·ç»“æ„ã€BOSSæ¡£æ¡ˆ
 */
function normalizeAnalysisResult(
  raw: any,
  scripts: ScriptFile[]
): ProjectAnalysisResult {
  // å¤„ç†è§’è‰²ï¼ˆåŒ…å«å¤šå½¢æ€ï¼‰
  // ğŸ†• è·å–å½“å‰åˆ†æçš„é›†æ•°åˆ—è¡¨ï¼Œç”¨äºè‡ªåŠ¨å¡«å……appearsInEpisodes
  const currentEpisodes = scripts.map(s => s.episodeNumber || 1);

  const characters: CharacterRef[] = (raw.characters || []).map((c: any, i: number) => {
    // å¤„ç†è§’è‰²å½¢æ€
    const forms: CharacterForm[] = (c.forms || []).map((f: any, j: number) => ({
      id: `form-${Date.now()}-${i}-${j}`,
      name: f.name || `å½¢æ€${j + 1}`,
      episodeRange: f.episodeRange || '',
      description: f.description || '',
      note: f.note || '',
      visualPromptCn: f.visualPromptCn || '',
      visualPromptEn: f.visualPromptEn || '',
    }));

    return {
      id: `char-${Date.now()}-${i}`,
      name: c.name || 'æœªå‘½å',
      gender: c.gender || 'æœªçŸ¥',
      ageGroup: c.ageGroup || '',
      appearance: c.appearance || '',
      quote: c.quote || '',
      identityEvolution: c.identityEvolution || '',
      abilities: c.abilities || [],
      forms: forms.length > 0 ? forms : undefined,
      // ğŸ†• ä¼˜å…ˆä½¿ç”¨AIè¿”å›çš„appearsInEpisodesï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰åˆ†æçš„æ‰€æœ‰é›†æ•°
      appearsInEpisodes: c.appearsInEpisodes && c.appearsInEpisodes.length > 0
        ? c.appearsInEpisodes
        : currentEpisodes,
    };
  });

  // å¤„ç†åœºæ™¯
  const scenes: SceneRef[] = (raw.scenes || []).map((s: any, i: number) => ({
    id: `scene-${Date.now()}-${i}`,
    name: s.name || 'æœªå‘½ååœºæ™¯',
    description: s.description || '',
    visualPromptCn: s.visualPromptCn || '',
    visualPromptEn: s.visualPromptEn || '',
    atmosphere: s.atmosphere || '',
    appearsInEpisodes: s.appearsInEpisodes || [],
  }));

  // å¤„ç†åˆ†å·
  const volumes: StoryVolume[] = (raw.volumes || []).map((v: any, i: number) => ({
    id: `vol-${Date.now()}-${i}`,
    volumeNumber: v.volumeNumber || i + 1,
    title: v.title || `ç¬¬${i + 1}å·`,
    episodeRange: v.episodeRange || [1, 20],
    coreConflict: v.coreConflict || '',
    keyPlots: v.keyPlots || [],
    color: v.color || ['#22c55e', '#3b82f6', '#eab308', '#f97316', '#ef4444', '#8b5cf6'][i % 6],
  }));

  // å¤„ç†åæ´¾/BOSS
  const antagonists: Antagonist[] = (raw.antagonists || []).map((a: any, i: number) => ({
    id: `boss-${Date.now()}-${i}`,
    name: a.name || 'æœªå‘½åBOSS',
    volumeOrArc: a.volumeOrArc || '',
    formDescription: a.formDescription || '',
    outcome: a.outcome || '',
  }));

  // å¤„ç†å‰§é›†æ¦‚è¦ - å¤šé‡åŒ¹é…ç­–ç•¥
  const rawEpisodes = raw.episodeSummaries || [];
  console.log('[åˆ†æ] åŸå§‹episodeSummariesæ•°é‡:', rawEpisodes.length);
  console.log('[åˆ†æ] AIè¿”å›çš„é›†æ•°åˆ—è¡¨:', rawEpisodes.map((e: any) => e.episodeNumber));
  console.log('[åˆ†æ] è„šæœ¬ä¸­æœŸæœ›çš„é›†æ•°åˆ—è¡¨:', scripts.map(s => s.episodeNumber));

  // æ£€æŸ¥æ¦‚è¦æ˜¯å¦æœ‰æ•ˆçš„è¾…åŠ©å‡½æ•°
  const isValidSummary = (summary: string | undefined): boolean => {
    if (!summary) return false;
    const trimmed = summary.trim();
    const invalidPatterns = ['å¾…åˆ†æ', 'å¾…å®š', '(å¾…å®š)', '...', 'å¾…å¡«å†™', 'æ— ', 'æš‚æ— ', 'TBD', 'ç•¥'];
    return trimmed.length > 5 &&
           !invalidPatterns.some(p => trimmed === p || trimmed.startsWith(p));
  };

  const episodeSummaries: EpisodeSummary[] = scripts.map((script, i) => {
    const targetEp = script.episodeNumber || i + 1;

    // å¤šé‡åŒ¹é…ç­–ç•¥ï¼š
    // 1. ç²¾ç¡®åŒ¹é… episodeNumberï¼ˆæ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ï¼‰
    let rawEp = rawEpisodes.find(
      (e: any) => Number(e.episodeNumber) === Number(targetEp)
    );

    // 2. å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•ä»æ ‡é¢˜ä¸­æå–é›†æ•°åŒ¹é…
    if (!rawEp) {
      rawEp = rawEpisodes.find((e: any) => {
        const titleMatch = e.title?.match(/ç¬¬(\d+)[é›†è¯]/);
        return titleMatch && Number(titleMatch[1]) === Number(targetEp);
      });
    }

    // 3. å°è¯•ä» summary ä¸­åŒ¹é…å«æœ‰é›†æ•°çš„ï¼ˆå¤‡ç”¨ï¼‰
    if (!rawEp) {
      rawEp = rawEpisodes.find((e: any) => {
        const summaryMatch = e.summary?.match(/ç¬¬(\d+)[é›†è¯]/);
        return summaryMatch && Number(summaryMatch[1]) === Number(targetEp);
      });
    }

    // 4. å¦‚æœä»¥ä¸Šéƒ½å¤±è´¥ï¼Œä½¿ç”¨ç´¢å¼•å›é€€
    if (!rawEp && rawEpisodes[i]) {
      rawEp = rawEpisodes[i];
    }

    // 5. å¦‚æœå½“å‰åŒ¹é…çš„æ¦‚è¦æ— æ•ˆï¼Œå°è¯•ä»å‰§æœ¬å¼€å¤´è‡ªåŠ¨æå–
    let finalSummary = isValidSummary(rawEp?.summary) ? rawEp.summary : '';

    // 6. å›é€€ç­–ç•¥ï¼šä»å‰§æœ¬å†…å®¹æå–å‰100å­—ä½œä¸ºæ¦‚è¦
    if (!finalSummary && script.content) {
      const cleanContent = script.content
        .replace(/[=\-#*\[\]]/g, '')
        .replace(/ç¬¬\d+é›†/g, '')
        .trim()
        .slice(0, 100);
      if (cleanContent.length > 20) {
        finalSummary = cleanContent + '...';
      }
    }

    if (!finalSummary) {
      finalSummary = 'å¾…åˆ†æ';
    }

    let finalTitle = rawEp?.title || `ç¬¬${targetEp}é›†`;
    // æ¸…ç†æ ‡é¢˜ä¸­çš„å ä½ç¬¦
    if (finalTitle === '...' || finalTitle.startsWith('ç¬¬') && finalTitle.endsWith('é›†')) {
      finalTitle = `ç¬¬${targetEp}é›†`;
    }
    let finalCharStates = rawEp?.characterStates || [];

    return {
      episodeNumber: targetEp,
      title: finalTitle,
      summary: finalSummary,
      characterStates: (finalCharStates).map((cs: any) => ({
        characterId: cs.characterId || '',
        characterName: cs.characterName || '',
        stateDescription: cs.stateDescription || '',
        location: cs.location || '',
      })),
    };
  });

  return {
    worldView: raw.worldView || '',
    genre: raw.genre || '',
    visualStyle: raw.visualStyle || '',
    keyTerms: (raw.keyTerms || []).map((t: any) => ({
      term: t.term || '',
      explanation: t.explanation || '',
    })),
    characters,
    scenes,
    volumes,
    antagonists,
    episodeSummaries,
    // ğŸ†• AI çŒœæµ‹çš„ä¸»è§’åˆ—è¡¨
    suggestedMainCharacters: (raw.suggestedMainCharacters || []).map((m: any) => ({
      name: m.name || '',
      reason: m.reason || '',
    })),
  };
}

/**
 * åˆ›å»ºé»˜è®¤åˆ†æç»“æœï¼ˆåˆ†æå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
 * ğŸ”§ v7ä¿®å¤ï¼šAPIå¤±è´¥æ—¶ä½¿ç”¨é¢„æ‰«æç»“æœï¼Œè€Œä¸æ˜¯è¿”å›ç©ºæ•°æ®
 */
function createDefaultAnalysisResult(
  scripts: ScriptFile[],
  preScanResult?: { characterNames: string[]; sceneNames: string[] }
): ProjectAnalysisResult {
  // ğŸ”§ å¦‚æœæœ‰é¢„æ‰«æç»“æœï¼Œä½¿ç”¨é¢„æ‰«æçš„è§’è‰²å’Œåœºæ™¯
  const characters = preScanResult?.characterNames.map(name => ({
    name,
    description: 'ï¼ˆæ­£åˆ™æå–ï¼Œå¾…AIåˆ†æï¼‰',
    personality: '',
    appearance: '',
    relationships: [],
  })) || [];

  const scenes = preScanResult?.sceneNames.map(name => ({
    name,
    description: 'ï¼ˆæ­£åˆ™æå–ï¼Œå¾…AIåˆ†æï¼‰',
    atmosphere: '',
    keyProps: [],
  })) || [];

  console.log(`[é»˜è®¤ç»“æœ] ä½¿ç”¨é¢„æ‰«ææ•°æ® - è§’è‰²: ${characters.length}ä¸ª, åœºæ™¯: ${scenes.length}ä¸ª`);

  // ğŸ”§ ä¿®å¤ï¼šä¸ºè§’è‰²å’Œåœºæ™¯æ·»åŠ å¿…éœ€çš„ id å­—æ®µ
  // ğŸ†• å¦‚æœAIæ²¡æœ‰è¿”å›appearsInEpisodesï¼Œæ ¹æ®å½“å‰åˆ†æçš„é›†æ•°è‡ªåŠ¨å¡«å……
  const currentEpisodes = scripts.map(s => s.episodeNumber || 1);
  const charactersWithId = characters.map((char, index) => ({
    id: `C${index + 1}`,
    ...char,
    visualPromptCn: char.appearance || '',
    visualPromptEn: '',
    // ğŸ†• ä¼˜å…ˆä½¿ç”¨AIè¿”å›çš„appearsInEpisodesï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰åˆ†æçš„æ‰€æœ‰é›†æ•°
    // æ³¨ï¼šé¢„æ‰«ææ„é€ çš„ char å¯¹è±¡æ— æ­¤å­—æ®µï¼Œä½† AI å®é™…è¿”å›æ—¶å¯èƒ½å«æœ‰ï¼Œç”¨ç±»å‹æ–­è¨€å®‰å…¨è®¿é—®
    appearsInEpisodes: ((char as { appearsInEpisodes?: number[] }).appearsInEpisodes || []).length > 0
      ? (char as { appearsInEpisodes?: number[] }).appearsInEpisodes!
      : currentEpisodes,
  }));

  const scenesWithId = scenes.map((scene, index) => ({
    id: `S${index + 1}`,
    ...scene,
    visualPromptCn: scene.description || '',
    visualPromptEn: '',
    appearsInEpisodes: [],
  }));

  return {
    worldView: 'æœªèƒ½è‡ªåŠ¨è¯†åˆ«ä¸–ç•Œè§‚ï¼Œè¯·æ‰‹åŠ¨å¡«å†™',
    genre: '',
    visualStyle: '',
    keyTerms: [],
    characters: charactersWithId,
    scenes: scenesWithId,
    volumes: [],
    antagonists: [],
    episodeSummaries: scripts.map((s, i) => ({
      episodeNumber: s.episodeNumber || i + 1,
      title: `ç¬¬${s.episodeNumber || i + 1}é›†`,
      summary: 'å¾…åˆ†æ',
      characterStates: [],
    })),
    // ğŸ†• é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä¸»è§’çŒœæµ‹
    suggestedMainCharacters: [],
  };
}

/**
 * ğŸ†• v6æ–°å¢ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¿«é€Ÿæå–è§’è‰²åï¼ˆä¸ä¾èµ–AIï¼‰
 *
 * æ³¨æ„ï¼šScene XXï½œä¸»é¢˜å ä¸æ˜¯åœºæ™¯ï¼Œæ˜¯åˆ†é•œå°èŠ‚æ ‡é¢˜
 * çœŸæ­£çš„åœºæ™¯éœ€è¦ä»å‰§æƒ…å†…å®¹ä¸­æå–ï¼ˆå¦‚"æœˆçƒèƒŒé¢"ã€"åŠå…¬å®¤"ç­‰åœ°ç‚¹æè¿°ï¼‰
 */
function regexPreScanScripts(scripts: ScriptFile[]): { characterNames: string[]; sceneNames: string[] } {
  console.log(`[æ­£åˆ™é¢„æ‰«æ] å¼€å§‹æ‰«æ ${scripts.length} é›†å‰§æœ¬...`);

  const sceneNames = new Set<string>();
  const characterNames = new Set<string>();

  // ğŸ”§ v6æ”¹è¿›ï¼šè§’è‰²æå–æ­£åˆ™ï¼ˆå¯¹è¯æ ¼å¼å¾ˆè§„èŒƒï¼Œæ­£åˆ™å¯é ï¼‰
  const characterPatterns = [
    // ğŸ”§ ä¼˜å…ˆåŒ¹é…"èŒä½+ç”²ä¹™ä¸™ä¸"æ ¼å¼ï¼ˆå¦‚"æ­£é“ä¿®å£«ç”²"ï¼‰
    /^([^\s:ï¼šã€ã€‘()ï¼ˆï¼‰"""\n]{2,8}[ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])(?:å–˜æ¯|å¤§å–Š|ä½å£°|æ²‰å£°|ç¬‘é“|å¹æ¯|æ€’é“|å†·é“|æƒŠé“|æ€¥é“|ä¸¥è‚ƒ|å†…å¿ƒä½è¯­|æƒŠæ|æ²™å“‘)?[ï¼š:]/gm,
    // æ ‡å‡†å¯¹è¯æ ¼å¼ï¼ˆæ‰©å±•ä¸º 2-6 å­—ç¬¦ï¼‰
    /^([^\s:ï¼šã€ã€‘()ï¼ˆï¼‰"""\n]{2,6})(?:å–˜æ¯|å¤§å–Š|ä½å£°|æ²‰å£°|ç¬‘é“|å¹æ¯|æ€’é“|å†·é“|æƒŠé“|æ€¥é“|ä¸¥è‚ƒ|å†…å¿ƒä½è¯­|æƒŠæ|æ²™å“‘)?[ï¼š:]/gm,
    /^ã€Œ([^\sã€]{2,8})ã€/gm,                         // ã€Œæ—æºªã€è¯´
    /^([^\s]{2,6})è¯´[ï¼š:]/gm,                         // æŸæŸè¯´ï¼š
    // å‰§æœ¬æ ¼å¼ï¼šè§’è‰²åï¼ˆçŠ¶æ€ï¼‰
    /^([^\s]{2,6})ï¼ˆ[^ï¼‰]+ï¼‰$/gm,                     // ç‹¬å­¤äº‘ï¼ˆæƒŠæï¼‰
  ];

  for (const script of scripts) {
    const content = script.content;

    // æå–è§’è‰²å
    for (const pattern of characterPatterns) {
      const regex = new RegExp(pattern.source, pattern.flags);
      let match;
      while ((match = regex.exec(content)) !== null) {
        const charName = match[1].trim();
        // è¿‡æ»¤æ‰å¸¸è§çš„éè§’è‰²åè¯
        const excludeWords = [
          // å‰§æœ¬ç»“æ„è¯
          'ç”»é¢', 'å°è¯', 'éŸ³æ•ˆ', 'BGM', 'éŸ³ä¹', 'æ—ç™½', 'å­—å¹•', 'ç‰¹æ•ˆ', 'è½¬åœº', 'æ·¡å…¥', 'æ·¡å‡º',
          'é»‘å±', 'ç™½å±', 'é—ªå›', 'å¤‡æ³¨', 'è¯´æ˜', 'æè¿°', 'åœºæ™¯', 'åœ°ç‚¹', 'æ—¶é—´', 'æ³¨', 'æ³¨æ„',
          'æç¤º', 'æ ‡é¢˜', 'Scene', 'scene', 'SCENE', 'åˆ†é•œ', 'é•œå¤´',
          // å¸¸è§åŠ¨è¯/æè¿°è¯ï¼ˆå¯èƒ½è¢«è¯¯åŒ¹é…ï¼‰
          'ä¸¤äºº', 'ä¸‰äºº', 'ä¼—äºº', 'å¯¹æ–¹', 'æ­¤æ—¶', 'ç„¶å', 'æ¥ç€', 'éšå', 'åŒæ—¶', 'çªç„¶',
          'ç¯å½¢', 'å¤´é¡¶', 'è¿œå¤„', 'è¿‘å¤„', 'å‰æ–¹', 'åæ–¹', 'å·¦ä¾§', 'å³ä¾§', 'ä¸Šæ–¹', 'ä¸‹æ–¹',
          'ç´«è‰²', 'é»‘è‰²', 'ç™½è‰²', 'çº¢è‰²', 'é‡‘è‰²', 'ç°è‰²', 'è“è‰²', 'ç»¿è‰²',
          // æ•°å­—å¼€å¤´
          'ç¬¬ä¸€', 'ç¬¬äºŒ', 'ç¬¬ä¸‰', 'ç¬¬å››', 'ç¬¬äº”',
        ];
        // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯æ•°å­—æˆ–ä»¥æ•°å­—å¼€å¤´
        const isNumeric = /^\d/.test(charName) || /^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/.test(charName);
        if (charName && charName.length >= 2 && charName.length <= 6 && !excludeWords.includes(charName) && !isNumeric) {
          characterNames.add(charName);
        }
      }
    }
  }

  console.log(`[æ­£åˆ™é¢„æ‰«æ] æå–åˆ° ${characterNames.size} ä¸ªè§’è‰²åï¼š${Array.from(characterNames).slice(0, 10).join('ã€')}...`);
  console.log(`[æ­£åˆ™é¢„æ‰«æ] åœºæ™¯åå°†ç”±AIä»ç”»é¢æè¿°ä¸­æ™ºèƒ½æå–`);

  return {
    sceneNames: [],  // ğŸ”§ v6ï¼šåœºæ™¯åä¸å†ç”¨æ­£åˆ™æå–ï¼Œäº¤ç»™AIä»ç”»é¢æè¿°ä¸­ç†è§£
    characterNames: Array.from(characterNames),
  };
}

/**
 * ğŸ†• v5æ–°å¢ï¼šé¢„æ‰«æå‰§æœ¬ï¼Œå¿«é€Ÿæå–æ‰€æœ‰è§’è‰²åå’Œåœºæ™¯å
 * v6æ”¹è¿›ï¼šå…ˆç”¨æ­£åˆ™æå–ï¼Œå†ç”¨AIè¡¥å……
 */
async function preScanScripts(
  scripts: ScriptFile[],
  model: string = DEFAULT_MODEL
): Promise<{ characterNames: string[]; sceneNames: string[] }> {
  console.log(`[é¢„æ‰«æ] å¼€å§‹å¿«é€Ÿæ‰«æ ${scripts.length} é›†å‰§æœ¬...`);

  // ğŸ†• v6ï¼šå…ˆç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ï¼ˆ100%å¯é ï¼‰
  const regexResult = regexPreScanScripts(scripts);

  // ğŸ”§ v7æ”¹è¿›ï¼šæ¯é›†å–æ›´å¤šå†…å®¹ï¼ˆ5000å­—ï¼‰ï¼Œç¡®ä¿è¦†ç›–è¶³å¤Ÿçš„ç”»é¢æè¿°
  const combinedContent = scripts.map((s, idx) => {
    const epNum = s.episodeNumber ?? (idx + 1);
    // æ¯é›†å–5000å­—ï¼Œç¡®ä¿èƒ½è¦†ç›–å¤šä¸ªåœºæ™¯çš„ç”»é¢æè¿°
    return `=== ç¬¬${epNum}é›† ===\n${s.content.slice(0, 5000)}`;
  }).join('\n\n');

  const prompt = `
# ä»»åŠ¡ï¼šå¿«é€Ÿæ‰«æå‰§æœ¬ï¼Œæå–æ‰€æœ‰è§’è‰²åå’Œåœºæ™¯åœ°ç‚¹

## é‡è¦è¯´æ˜
- **Scene XXï½œä¸»é¢˜å** æ˜¯åˆ†é•œå°èŠ‚æ ‡é¢˜ï¼Œä¸æ˜¯åœºæ™¯å
- **çœŸæ­£çš„åœºæ™¯**æ˜¯æŒ‡å‰§æƒ…å‘ç”Ÿçš„åœ°ç‚¹/ç¯å¢ƒï¼Œéœ€è¦ä»"ç”»é¢"æè¿°ä¸­æå–

## è¦æ±‚
1. **è§’è‰²å**ï¼šæå–å‰§æœ¬ä¸­å‡ºç°çš„æ‰€æœ‰æœ‰åå­—çš„è§’è‰²ï¼ˆå¯¹è¯è€…ã€è¢«æåŠè€…ï¼‰ï¼Œåªéœ€è¦åå­—
2. **åœºæ™¯å**ï¼šä»"ç”»é¢"æè¿°ä¸­æå–åœ°ç‚¹/ç¯å¢ƒï¼ˆå¦‚"æœˆçƒèƒŒé¢"ã€"ç¯å½¢éƒ½å¸‚ä¸Šç©º"ã€"åŠå…¬å®¤"ã€"æ·±æ¸Šåº•å±‚"ç­‰ï¼‰

## ç¤ºä¾‹
å‰§æœ¬ï¼š
\`\`\`
Scene 27ï½œæœˆçƒèƒŒé¢
ç”»é¢
æœˆçƒè¡¨é¢æ‹‰è¿‘ã€‚
å¯†é›†çš„æ–¹å½¢å‘æ´éå¸ƒå…¶ä¸Šï¼Œç²—å¤§ç¼†çº¿è¿æ¥å…¶é—´ã€‚
\`\`\`
åº”æå–åœºæ™¯åï¼š**æœˆçƒèƒŒé¢**ï¼ˆè€Œä¸æ˜¯"æœˆçƒèƒŒé¢"è¿™ä¸ªSceneæ ‡é¢˜ï¼‰

## å‰§æœ¬å†…å®¹
${combinedContent}

## è¾“å‡ºæ ¼å¼ï¼ˆåªè¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ï¼‰
{
  "characterNames": ["è§’è‰²1", "è§’è‰²2", ...],
  "sceneNames": ["æœˆçƒèƒŒé¢", "ç¯å½¢éƒ½å¸‚ä¸Šç©º", "æ·±æ¸Šåº•å±‚", ...]
}
`;

  try {
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${import.meta.env.VITE_OPENROUTER1_API_KEY}`,
        'HTTP-Referer': window.location.origin,
      },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.1,  // ä½æ¸©åº¦ï¼Œæ›´å‡†ç¡®
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      console.warn('[é¢„æ‰«æ] APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æ­£åˆ™ç»“æœ');
      return regexResult;
    }

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content || '';

    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const aiResult = JSON.parse(jsonMatch[0]);
      console.log(`[é¢„æ‰«æ] AIå‘ç° ${aiResult.characterNames?.length || 0} ä¸ªè§’è‰²åï¼Œ${aiResult.sceneNames?.length || 0} ä¸ªåœºæ™¯å`);

      // ğŸ†• v6ï¼šåˆå¹¶æ­£åˆ™ç»“æœå’ŒAIç»“æœï¼ˆå»é‡ï¼‰
      const mergedCharNames = [...new Set([...regexResult.characterNames, ...(aiResult.characterNames || [])])];
      const mergedSceneNames = [...new Set([...regexResult.sceneNames, ...(aiResult.sceneNames || [])])];

      console.log(`[é¢„æ‰«æ] åˆå¹¶åå…± ${mergedCharNames.length} ä¸ªè§’è‰²åï¼Œ${mergedSceneNames.length} ä¸ªåœºæ™¯å`);
      return {
        characterNames: mergedCharNames,
        sceneNames: mergedSceneNames,
      };
    }
  } catch (error) {
    console.warn('[é¢„æ‰«æ] AIè§£æå¤±è´¥ï¼Œä½¿ç”¨æ­£åˆ™ç»“æœ:', error);
  }

  // å¦‚æœAIå¤±è´¥ï¼Œè¿”å›æ­£åˆ™ç»“æœ
  return regexResult;
}

/**
 * ğŸ†• åˆ†æ‰¹åˆ†æå¤šé›†å‰§æœ¬ï¼ˆå®æ—¶è¿›åº¦å›è°ƒï¼‰
 * å°†å‰§æœ¬æŒ‰ BATCH_SIZE åˆ†æ‰¹ï¼Œé€æ‰¹è°ƒç”¨ APIï¼Œå®æ—¶åˆå¹¶ç»“æœ
 *
 * ğŸ”§ v5ä¿®å¤ï¼šå¢åŠ é¢„æ‰«ææœºåˆ¶ï¼Œå…ˆå¿«é€Ÿæ‰«ææ‰€æœ‰å‰§æœ¬æå–è§’è‰²åå’Œåœºæ™¯ååˆ—è¡¨
 * ğŸ”§ v6æ–°å¢ï¼šæ”¯æŒæå–æ¨¡å¼é€‰æ‹©
 */
export async function analyzeProjectScriptsWithProgress(
  scripts: ScriptFile[],
  model: string = DEFAULT_MODEL,
  onProgress?: (progress: BatchAnalysisProgress) => void,
  mode: 'quick' | 'standard' | 'deep' = 'standard'
): Promise<ProjectAnalysisResult> {
  const totalScripts = scripts.length;

  // ğŸ†• ç¬¬ä¸€æ­¥ï¼šé¢„æ‰«ææ‰€æœ‰å‰§æœ¬ï¼Œæå–è§’è‰²åå’Œåœºæ™¯å
  let preScanResult = { characterNames: [] as string[], sceneNames: [] as string[] };
  if (totalScripts > BATCH_SIZE) {
    onProgress?.({
      currentBatch: 0,
      totalBatches: Math.ceil(totalScripts / BATCH_SIZE) + 1,
      batchEpisodeRange: 'é¢„æ‰«æ',
      partialResult: null as any,
      status: 'analyzing',
    });
    preScanResult = await preScanScripts(scripts, model);
    console.log(`[åˆ†æ‰¹åˆ†æ] é¢„æ‰«æå®Œæˆï¼Œå‘ç°è§’è‰²: ${preScanResult.characterNames.join(', ')}`);
  }

  // å¦‚æœå‰§æœ¬æ•°é‡è¾ƒå°‘ï¼Œç›´æ¥ä½¿ç”¨åŸæœ‰æ–¹æ³•
  if (totalScripts <= BATCH_SIZE) {
    console.log(
      `[åˆ†æ‰¹åˆ†æ] å‰§æœ¬æ•°é‡ ${totalScripts} <= ${BATCH_SIZE}ï¼Œä½¿ç”¨å•æ¬¡åˆ†æï¼ˆæ¨¡å¼: ${mode}ï¼‰`
    );

    // ğŸ†• å•é›†/å°‘é‡å‰§æœ¬ï¼šæå–å®é™…é›†æ•°èŒƒå›´ï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„èŒƒå›´ï¼ˆå¦‚ä¸Šä¼ ç¬¬5-10é›†å´æ˜¾ç¤º 1-6ï¼‰
    const quickEpNums = scripts
      .map(s => s.episodeNumber)
      .filter((n): n is number => n !== undefined && n !== null);
    const quickMinEp = quickEpNums.length > 0 ? Math.min(...quickEpNums) : 1;
    const quickMaxEp = quickEpNums.length > 0 ? Math.max(...quickEpNums) : totalScripts;
    const quickRange = totalScripts === 1 ? `ç¬¬${quickMinEp}é›†` : `${quickMinEp}-${quickMaxEp}`;

    onProgress?.({
      currentBatch: 1,
      totalBatches: 1,
      batchEpisodeRange: quickRange,
      partialResult: null,
      status: 'analyzing',
    });

    const result = await analyzeProjectScripts(scripts, model, [], [], mode);
    onProgress?.({
      currentBatch: 1,
      totalBatches: 1,
      batchEpisodeRange: quickRange,
      partialResult: result,
      status: 'complete',
    });
    return result;
  }

  // ç¡®ä¿æ¯ä¸ªè„šæœ¬éƒ½æœ‰æ­£ç¡®çš„ episodeNumber
  // å¦‚æœåŸå§‹è„šæœ¬æ²¡æœ‰ episodeNumberï¼Œåˆ™æ ¹æ®ç´¢å¼•åˆ†é…
  const scriptsWithEpisodeNumber = scripts.map((script, idx) => {
    if (script.episodeNumber !== undefined && script.episodeNumber !== null) {
      return script;
    }
    // å›é€€ï¼šä½¿ç”¨ç´¢å¼• + 1 ä½œä¸ºé›†æ•°
    return { ...script, episodeNumber: idx + 1 };
  });

  console.log(`[åˆ†æ‰¹åˆ†æ] è„šæœ¬é›†æ•°åˆ†é…å®Œæˆï¼Œå‰5ä¸ª:`, scriptsWithEpisodeNumber.slice(0, 5).map(s => s.episodeNumber));

  // åˆ†æ‰¹
  const batches: ScriptFile[][] = [];
  for (let i = 0; i < totalScripts; i += BATCH_SIZE) {
    batches.push(scriptsWithEpisodeNumber.slice(i, i + BATCH_SIZE));
  }

  console.log(`[åˆ†æ‰¹åˆ†æ] å…± ${totalScripts} é›†ï¼Œåˆ†æˆ ${batches.length} æ‰¹ï¼Œæ¯æ‰¹ ${BATCH_SIZE} é›†`);

  // ç´¯ç§¯ç»“æœ
  let mergedResult: ProjectAnalysisResult = {
    worldView: '',
    genre: '',
    visualStyle: '',
    keyTerms: [],
    characters: [],
    scenes: [],
    volumes: [],
    antagonists: [],
    episodeSummaries: [],
  };

  // ğŸ†• v5: ç´¯ç§¯å·²å‘ç°çš„è§’è‰²åå’Œåœºæ™¯åï¼Œä¼ é€’ç»™åç»­æ‰¹æ¬¡
  let accumulatedCharNames = [...preScanResult.characterNames];
  let accumulatedSceneNames = [...preScanResult.sceneNames];

  console.log(`[åˆ†æ‰¹åˆ†æ] åˆå§‹åŒ–ç´¯ç§¯æ•°æ® - è§’è‰²: ${accumulatedCharNames.length}ä¸ª, åœºæ™¯: ${accumulatedSceneNames.length}ä¸ª`);
  console.log(`[åˆ†æ‰¹åˆ†æ] é¢„æ‰«æç»“æœ - è§’è‰²: ${preScanResult.characterNames.length}ä¸ª, åœºæ™¯: ${preScanResult.sceneNames.length}ä¸ª`);

  // é€æ‰¹åˆ†æ
  for (let batchIdx = 0; batchIdx < batches.length; batchIdx++) {
    const batch = batches[batchIdx];
    const firstEp = batch[0]?.episodeNumber || (batchIdx * BATCH_SIZE + 1);
    const lastEp = batch[batch.length - 1]?.episodeNumber || ((batchIdx + 1) * BATCH_SIZE);
    const batchRange = `${firstEp}-${lastEp}`;

    console.log(`[åˆ†æ‰¹åˆ†æ] æ­£åœ¨åˆ†æç¬¬ ${batchIdx + 1}/${batches.length} æ‰¹ (ç¬¬${batchRange}é›†)...`);
    console.log(`[åˆ†æ‰¹åˆ†æ] æœ¬æ‰¹æ¬¡è„šæœ¬çš„ episodeNumber:`, batch.map(s => s.episodeNumber));
    console.log(`[åˆ†æ‰¹åˆ†æ] ä¼ é€’ç»™æœ¬æ‰¹æ¬¡çš„å·²çŸ¥è§’è‰²: ${accumulatedCharNames.length}ä¸ªï¼Œå·²çŸ¥åœºæ™¯: ${accumulatedSceneNames.length}ä¸ª`);

    // é€šçŸ¥å¼€å§‹åˆ†ææ­¤æ‰¹æ¬¡
    onProgress?.({
      currentBatch: batchIdx + 1,
      totalBatches: batches.length,
      batchEpisodeRange: batchRange,
      partialResult: mergedResult,
      status: 'analyzing',
    });

    try {
      // ğŸ”§ v5ä¿®å¤ï¼šä¼ é€’å·²çŸ¥è§’è‰²/åœºæ™¯åç»™åˆ†æå‡½æ•°
      // ğŸ”§ v6æ–°å¢ï¼šä¼ é€’æå–æ¨¡å¼
      const batchResult = await analyzeProjectScripts(batch, model, accumulatedCharNames, accumulatedSceneNames, mode);

      // ğŸ†• v5: ç´¯ç§¯æœ¬æ‰¹æ¬¡å‘ç°çš„è§’è‰²åå’Œåœºæ™¯å
      const newCharNames = batchResult.characters?.map(c => c.name) || [];
      const newSceneNames = batchResult.scenes?.map(s => s.name) || [];
      accumulatedCharNames = [...new Set([...accumulatedCharNames, ...newCharNames])];
      accumulatedSceneNames = [...new Set([...accumulatedSceneNames, ...newSceneNames])];

      // è°ƒè¯•ï¼šæ˜¾ç¤ºæœ¬æ‰¹æ¬¡è¿”å›çš„è¯¦ç»†ä¿¡æ¯
      console.log(`[åˆ†æ‰¹åˆ†æ] ç¬¬ ${batchIdx + 1} æ‰¹AIè¿”å›:`, {
        è§’è‰²æ•°: batchResult.characters?.length || 0,
        åœºæ™¯æ•°: batchResult.scenes?.length || 0,
        æ¦‚è¦æ•°: batchResult.episodeSummaries?.length || 0,
        è§’è‰²å: batchResult.characters?.map(c => c.name),
        åœºæ™¯å: batchResult.scenes?.map(s => s.name),
      });
      console.log(`[åˆ†æ‰¹åˆ†æ] ç¬¬ ${batchIdx + 1} æ‰¹è¿”å›çš„ episodeSummaries:`, batchResult.episodeSummaries?.map(e => e.episodeNumber));

      // åˆå¹¶ç»“æœ
      mergedResult = mergeAnalysisResults(mergedResult, batchResult, batchIdx === 0);

      console.log(`[åˆ†æ‰¹åˆ†æ] ç¬¬ ${batchIdx + 1} æ‰¹å®Œæˆï¼Œç´¯è®¡: ${mergedResult.characters.length}è§’è‰², ${mergedResult.scenes.length}åœºæ™¯, ${mergedResult.episodeSummaries.length}é›†æ¦‚è¦`);
      console.log(`[åˆ†æ‰¹åˆ†æ] åˆå¹¶åæ‰€æœ‰é›†æ•°:`, mergedResult.episodeSummaries?.map(e => e.episodeNumber));

      // é€šçŸ¥åˆå¹¶å®Œæˆ
      onProgress?.({
        currentBatch: batchIdx + 1,
        totalBatches: batches.length,
        batchEpisodeRange: batchRange,
        partialResult: mergedResult,
        status: batchIdx === batches.length - 1 ? 'complete' : 'merging',
      });

    } catch (error) {
      console.error(`[åˆ†æ‰¹åˆ†æ] ç¬¬ ${batchIdx + 1} æ‰¹å¤±è´¥:`, error);
      // å¤±è´¥æ—¶å¡«å……é»˜è®¤å‰§é›†æ¦‚è¦
      const defaultEpisodes = batch.map((s, i) => ({
        episodeNumber: s.episodeNumber || (batchIdx * BATCH_SIZE + i + 1),
        title: `ç¬¬${s.episodeNumber || (batchIdx * BATCH_SIZE + i + 1)}é›†`,
        summary: 'åˆ†æå¤±è´¥ï¼Œå¾…æ‰‹åŠ¨å¡«å†™',
        characterStates: [],
      }));
      mergedResult.episodeSummaries.push(...defaultEpisodes);
    }
  }

  // ğŸ†• v7ï¼šéªŒè¯é¢„æ‰«æçš„åœºæ™¯æ˜¯å¦éƒ½è¢«åŒ…å«
  if (preScanResult.sceneNames.length > 0) {
    console.log(`[åˆ†æ‰¹åˆ†æ] å¼€å§‹éªŒè¯é¢„æ‰«æåœºæ™¯ï¼ˆå…±${preScanResult.sceneNames.length}ä¸ªï¼‰`);
    mergedResult = ensurePreScannedScenesIncluded(mergedResult, preScanResult.sceneNames);
    console.log(`[åˆ†æ‰¹åˆ†æ] éªŒè¯å®Œæˆï¼Œæœ€ç»ˆåœºæ™¯æ•°: ${mergedResult.scenes.length}`);
  }

  return mergedResult;
}

/**
 * ğŸ†• v7æ–°å¢ï¼šç¡®ä¿é¢„æ‰«æçš„åœºæ™¯éƒ½è¢«åŒ…å«åœ¨æœ€ç»ˆç»“æœä¸­
 * é˜²æ­¢åœºæ™¯åœ¨åˆ†æ‰¹åˆ†æä¸­ä¸¢å¤±
 */
function ensurePreScannedScenesIncluded(
  result: ProjectAnalysisResult,
  preScannedScenes: string[]
): ProjectAnalysisResult {
  const existingNames = new Set(result.scenes.map(s => s.name));
  const missingScenes = preScannedScenes.filter(name => !existingNames.has(name));

  if (missingScenes.length === 0) {
    return result;
  }

  console.log(`[åœºæ™¯éªŒè¯] å‘ç° ${missingScenes.length} ä¸ªé—æ¼åœºæ™¯:`, missingScenes);

  // ä¸ºé—æ¼çš„åœºæ™¯åˆ›å»ºå ä½ç¬¦
  const placeholderScenes: SceneRef[] = missingScenes.map((name, idx) => ({
    id: `scene-è¡¥å……-${Date.now()}-${idx}`,
    name,
    description: 'âš ï¸ å¾…è¡¥å……è¯¦ç»†æè¿°ï¼ˆä»å‰§æœ¬ä¸­æå–ï¼‰',
    atmosphere: '',
    visualPromptCn: '',
    visualPromptEn: '',
    appearsInEpisodes: [],
  }));

  return {
    ...result,
    scenes: [...result.scenes, ...placeholderScenes],
  };
}

/**
 * åˆå¹¶ä¸¤æ¬¡åˆ†æç»“æœ
 * - ä¸–ç•Œè§‚ã€ç±»å‹ã€é£æ ¼ï¼šä½¿ç”¨ç¬¬ä¸€æ‰¹çš„ç»“æœ
 * - è§’è‰²ã€åœºæ™¯ï¼šå»é‡åˆå¹¶ï¼ˆæŒ‰åç§°ï¼‰
 * - å‰§é›†æ¦‚è¦ï¼šè¿½åŠ 
 */
function mergeAnalysisResults(
  existing: ProjectAnalysisResult,
  newResult: ProjectAnalysisResult,
  isFirstBatch: boolean
): ProjectAnalysisResult {
  // ç¬¬ä¸€æ‰¹æ—¶ä½¿ç”¨ä¸–ç•Œè§‚ç­‰åŸºç¡€ä¿¡æ¯
  const worldView = isFirstBatch ? newResult.worldView : existing.worldView;
  const genre = isFirstBatch ? newResult.genre : existing.genre;
  const visualStyle = isFirstBatch ? newResult.visualStyle : existing.visualStyle;

  // åˆå¹¶ä¸“æœ‰åè¯ï¼ˆæŒ‰æœ¯è¯­å»é‡ï¼‰
  const existingTerms = new Set(existing.keyTerms.map(t => t.term));
  const mergedKeyTerms = [
    ...existing.keyTerms,
    ...newResult.keyTerms.filter(t => !existingTerms.has(t.term)),
  ];

  // åˆå¹¶è§’è‰²ï¼ˆæŒ‰åç§°å»é‡ï¼Œä¿ç•™æ›´å®Œæ•´çš„ä¿¡æ¯ï¼‰
  const charMap = new Map<string, CharacterRef>();
  for (const char of existing.characters) {
    charMap.set(char.name, char);
  }
  for (const char of newResult.characters) {
    const existingChar = charMap.get(char.name);
    if (!existingChar) {
      charMap.set(char.name, char);
    } else {
      // åˆå¹¶å½¢æ€
      const existingForms = existingChar.forms || [];
      const newForms = char.forms || [];
      const formNames = new Set(existingForms.map(f => f.name));
      const mergedForms = [
        ...existingForms,
        ...newForms.filter(f => !formNames.has(f.name)),
      ];
      charMap.set(char.name, {
        ...existingChar,
        forms: mergedForms.length > 0 ? mergedForms : undefined,
        // å¦‚æœæ–°çš„æœ‰æ›´å¤šèƒ½åŠ›ï¼Œåˆå¹¶
        abilities: [...new Set([...(existingChar.abilities || []), ...(char.abilities || [])])],
      });
    }
  }

  // åˆå¹¶åœºæ™¯ï¼ˆæŒ‰åç§°å»é‡ï¼‰
  const sceneMap = new Map<string, SceneRef>();
  for (const scene of existing.scenes) {
    sceneMap.set(scene.name, scene);
  }
  for (const scene of newResult.scenes) {
    const existingScene = sceneMap.get(scene.name);
    if (!existingScene) {
      sceneMap.set(scene.name, scene);
    } else {
      // åˆå¹¶å‡ºç°é›†æ•°
      const eps = new Set([
        ...(existingScene.appearsInEpisodes || []),
        ...(scene.appearsInEpisodes || []),
      ]);
      sceneMap.set(scene.name, {
        ...existingScene,
        appearsInEpisodes: Array.from(eps).sort((a, b) => a - b),
      });
    }
  }

  // åˆå¹¶åˆ†å·ï¼ˆå»é‡ï¼ŒæŒ‰æ ‡é¢˜ï¼‰
  const volumeMap = new Map<string, StoryVolume>();
  for (const vol of existing.volumes || []) {
    volumeMap.set(vol.title, vol);
  }
  for (const vol of newResult.volumes || []) {
    if (!volumeMap.has(vol.title)) {
      volumeMap.set(vol.title, vol);
    }
  }

  // åˆå¹¶BOSSï¼ˆå»é‡ï¼‰
  const bossMap = new Map<string, Antagonist>();
  for (const boss of existing.antagonists || []) {
    bossMap.set(boss.name, boss);
  }
  for (const boss of newResult.antagonists || []) {
    if (!bossMap.has(boss.name)) {
      bossMap.set(boss.name, boss);
    }
  }

  // å‰§é›†æ¦‚è¦åˆå¹¶ï¼ŒæŒ‰é›†æ•°å»é‡ï¼ˆæ–°çš„è¦†ç›–æ—§çš„ï¼Œä½†åªåœ¨æ–°çš„æœ‰æ•ˆæ—¶ï¼‰
  const episodeMap = new Map<number, EpisodeSummary>();
  for (const ep of existing.episodeSummaries || []) {
    episodeMap.set(ep.episodeNumber, ep);
  }
  for (const ep of newResult.episodeSummaries || []) {
    const existing = episodeMap.get(ep.episodeNumber);
    // å¦‚æœæ—§çš„æ˜¯"å¾…åˆ†æ"æˆ–æ— æ•ˆï¼Œæ–°çš„æœ‰å†…å®¹å°±è¦†ç›–
    const existingInvalid = !existing || !existing.summary || existing.summary === 'å¾…åˆ†æ' || existing.summary === 'å¾…å®š';
    const newValid = ep.summary && ep.summary !== 'å¾…åˆ†æ' && ep.summary !== 'å¾…å®š';
    if (existingInvalid || newValid) {
      episodeMap.set(ep.episodeNumber, ep);
    }
  }
  const mergedEpisodes = Array.from(episodeMap.values())
    .sort((a, b) => a.episodeNumber - b.episodeNumber);

  return {
    worldView,
    genre,
    visualStyle,
    keyTerms: mergedKeyTerms,
    characters: Array.from(charMap.values()),
    scenes: Array.from(sceneMap.values()),
    volumes: Array.from(volumeMap.values()),
    antagonists: Array.from(bossMap.values()),
    episodeSummaries: mergedEpisodes,
  };
}

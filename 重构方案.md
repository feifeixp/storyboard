# App.tsx é‡æ„æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­

å½“å‰ `App.tsx` **5362 è¡Œ**,å­˜åœ¨ä»¥ä¸‹é—®é¢˜:
- âŒ å•æ–‡ä»¶è¿‡å¤§,éš¾ä»¥ç»´æŠ¤
- âŒ çŠ¶æ€ç®¡ç†æ··ä¹±(60+ useState)
- âŒ ä¸šåŠ¡é€»è¾‘è€¦åˆåœ¨ç»„ä»¶ä¸­
- âŒ ç¼ºä¹æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†

## é‡æ„ç­–ç•¥:æ¸è¿›å¼è§£è€¦

### ç¬¬ä¸€é˜¶æ®µ:çŠ¶æ€ç®¡ç†é‡æ„(ä¼˜å…ˆçº§â­â­â­â­â­)

#### 1.1 åˆ›å»ºå…¨å±€çŠ¶æ€ç®¡ç†
```bash
npm install zustand
```

**åˆ›å»º stores/useAppStore.ts:**
```typescript
import create from 'zustand';
import { persist } from 'zustand/middleware';

interface AppState {
  // ç”¨æˆ·ç›¸å…³
  loggedIn: boolean;
  userPoints: PointsInfo | null;
  
  // é¡¹ç›®ç›¸å…³
  projects: Project[];
  currentProject: Project | null;
  currentEpisodeNumber: number | null;
  
  // å·¥ä½œæµçŠ¶æ€
  currentStep: AppStep;
  script: string;
  shots: Shot[];
  characterRefs: CharacterRef[];
  hqUrls: string[];
  
  // Actions
  setLoggedIn: (value: boolean) => void;
  setCurrentProject: (project: Project | null) => void;
  setShots: (shots: Shot[]) => void;
  // ... å…¶ä»– actions
}

export const useAppStore = create<AppState>()(
  persist(
    (set) => ({
      // åˆå§‹çŠ¶æ€
      loggedIn: isLoggedIn(),
      userPoints: null,
      projects: [],
      currentProject: null,
      currentEpisodeNumber: null,
      currentStep: AppStep.PROJECT_LIST,
      script: '',
      shots: [],
      characterRefs: [],
      hqUrls: [],
      
      // Actions
      setLoggedIn: (value) => set({ loggedIn: value }),
      setCurrentProject: (project) => set({ currentProject: project }),
      setShots: (shots) => set({ shots }),
      // ...
    }),
    {
      name: 'storyboard-storage',
      partialize: (state) => ({
        // åªæŒä¹…åŒ–å¿…è¦æ•°æ®
        currentStep: state.currentStep,
        currentEpisodeNumber: state.currentEpisodeNumber,
        script: state.script,
        shots: state.shots,
        characterRefs: state.characterRefs,
      }),
    }
  )
);
```

### ç¬¬äºŒé˜¶æ®µ:ç»„ä»¶æ‹†åˆ†(ä¼˜å…ˆçº§â­â­â­â­)

#### 2.1 æŒ‰åŠŸèƒ½åŸŸæ‹†åˆ†ç»„ä»¶

**åˆ›å»º components/ ç›®å½•ç»“æ„:**
```
components/
â”œâ”€â”€ Auth/
â”‚   â””â”€â”€ LoginGuard.tsx         # ç™»å½•å®ˆå«(æ›¿æ¢ if (!loggedIn))
â”œâ”€â”€ Projects/
â”‚   â”œâ”€â”€ ProjectListPage.tsx    # é¡¹ç›®åˆ—è¡¨é¡µ
â”‚   â”œâ”€â”€ ProjectWizardPage.tsx  # åˆ›å»ºé¡¹ç›®å‘å¯¼é¡µ
â”‚   â””â”€â”€ ProjectDashboardPage.tsx # é¡¹ç›®ä¸»ç•Œé¢
â”œâ”€â”€ Episodes/
â”‚   â”œâ”€â”€ EpisodeSelector.tsx    # å‰§é›†é€‰æ‹©å™¨
â”‚   â””â”€â”€ EpisodeWorkspace.tsx   # å‰§é›†ç¼–è¾‘å·¥ä½œåŒº
â”œâ”€â”€ Workflow/
â”‚   â”œâ”€â”€ StepTracker.tsx        # æ­¥éª¤è¿½è¸ªå™¨(å·²å­˜åœ¨)
â”‚   â”œâ”€â”€ ScriptInputStep.tsx    # æ­¥éª¤1:å‰§æœ¬è¾“å…¥
â”‚   â”œâ”€â”€ CharacterManageStep.tsx # æ­¥éª¤2:è§’è‰²ç®¡ç†
â”‚   â”œâ”€â”€ ShotGenerateStep.tsx   # æ­¥éª¤3:åˆ†é•œç”Ÿæˆ
â”‚   â”œâ”€â”€ ShotReviewStep.tsx     # æ­¥éª¤4:å®¡æ ¸ä¼˜åŒ–
â”‚   â”œâ”€â”€ PromptExtractStep.tsx  # æ­¥éª¤5:æç¤ºè¯æå–
â”‚   â””â”€â”€ FinalStoryboardStep.tsx # æ­¥éª¤6:æœ€ç»ˆæ•…äº‹æ¿
â””â”€â”€ Shared/
    â”œâ”€â”€ ModelSelector.tsx      # æ¨¡å‹é€‰æ‹©å™¨(å·²å­˜åœ¨)
    â””â”€â”€ LoadingOverlay.tsx     # åŠ è½½é®ç½©
```

**ç¤ºä¾‹:ScriptInputStep.tsx**
```typescript
import React from 'react';
import { useAppStore } from '@/stores/useAppStore';
import { useScriptManagement } from '@/hooks/useScriptManagement';

export const ScriptInputStep: React.FC = () => {
  const { script, setScript, currentStep } = useAppStore();
  const { handleScriptUpload, cleanScript } = useScriptManagement();
  
  if (currentStep !== AppStep.INPUT_SCRIPT) return null;
  
  return (
    <div className="script-input-step">
      <h2>æ­¥éª¤1:å¯¼å…¥å‰§æœ¬</h2>
      <textarea 
        value={script}
        onChange={(e) => setScript(e.target.value)}
      />
      <input 
        type="file" 
        onChange={handleScriptUpload}
      />
      <button onClick={cleanScript}>
        æ¸…æ´—å‰§æœ¬
      </button>
    </div>
  );
};
```

### ç¬¬ä¸‰é˜¶æ®µ:ä¸šåŠ¡é€»è¾‘æå–(ä¼˜å…ˆçº§â­â­â­â­)

#### 3.1 åˆ›å»ºè‡ªå®šä¹‰ Hooks

**åˆ›å»º hooks/ ç›®å½•:**
```
hooks/
â”œâ”€â”€ useProjectManagement.ts   # é¡¹ç›®ç®¡ç†é€»è¾‘
â”œâ”€â”€ useEpisodeManagement.ts   # å‰§é›†ç®¡ç†é€»è¾‘
â”œâ”€â”€ useScriptManagement.ts    # å‰§æœ¬å¤„ç†é€»è¾‘
â”œâ”€â”€ useCharacterManagement.ts # è§’è‰²ç®¡ç†é€»è¾‘
â”œâ”€â”€ useShotGeneration.ts      # åˆ†é•œç”Ÿæˆé€»è¾‘
â”œâ”€â”€ useShotReview.ts          # åˆ†é•œå®¡æ ¸é€»è¾‘
â””â”€â”€ useImageGeneration.ts     # ä¹å®«æ ¼ç”Ÿå›¾é€»è¾‘
```

**ç¤ºä¾‹:useProjectManagement.ts**
```typescript
import { useAppStore } from '@/stores/useAppStore';
import { getAllProjects, saveProject, deleteProject } from '@/services/d1Storage';

export const useProjectManagement = () => {
  const { projects, setProjects, setCurrentProject } = useAppStore();
  
  const loadProjects = async () => {
    const allProjects = await getAllProjects();
    setProjects(allProjects);
  };
  
  const selectProject = async (projectId: string) => {
    const fullProject = await getProject(projectId);
    setCurrentProject(fullProject);
    // ... åŠ è½½è§’è‰²åº“ç­‰é€»è¾‘
  };
  
  const createProject = async (project: Project) => {
    await saveProject(project, { includeEpisodes: true });
    await loadProjects();
  };
  
  const removeProject = async (projectId: string) => {
    await deleteProject(projectId);
    await loadProjects();
  };
  
  return {
    projects,
    loadProjects,
    selectProject,
    createProject,
    removeProject,
  };
};
```

### ç¬¬å››é˜¶æ®µ:é¡µé¢çº§ç»„ä»¶æ•´åˆ(ä¼˜å…ˆçº§â­â­â­)

**åˆ›å»º pages/ ç›®å½•:**
```
pages/
â”œâ”€â”€ LoginPage.tsx
â”œâ”€â”€ ProjectListPage.tsx
â”œâ”€â”€ ProjectWizardPage.tsx
â”œâ”€â”€ ProjectDashboardPage.tsx
â””â”€â”€ EpisodeWorkspacePage.tsx
```

**App.tsx ç®€åŒ–ä¸ºè·¯ç”±é…ç½®:**
```typescript
import React from 'react';
import { useAppStore } from '@/stores/useAppStore';
import { LoginPage } from '@/pages/LoginPage';
import { ProjectListPage } from '@/pages/ProjectListPage';
import { ProjectWizardPage } from '@/pages/ProjectWizardPage';
import { ProjectDashboardPage } from '@/pages/ProjectDashboardPage';
import { EpisodeWorkspacePage } from '@/pages/EpisodeWorkspacePage';

const App: React.FC = () => {
  const { loggedIn, currentStep } = useAppStore();
  
  if (!loggedIn) return <LoginPage />;
  
  switch (currentStep) {
    case AppStep.PROJECT_LIST:
      return <ProjectListPage />;
    case AppStep.PROJECT_WIZARD:
      return <ProjectWizardPage />;
    case AppStep.PROJECT_DASHBOARD:
      return <ProjectDashboardPage />;
    case AppStep.REANALYZE_PROJECT:
      return <ReanalyzePage />;
    default:
      // æ‰€æœ‰å·¥ä½œæµæ­¥éª¤ç»Ÿä¸€ç”± EpisodeWorkspacePage å¤„ç†
      return <EpisodeWorkspacePage />;
  }
};

export default App;
```

### ç¬¬äº”é˜¶æ®µ:TypeScript ç±»å‹ä¼˜åŒ–(ä¼˜å…ˆçº§â­â­â­)

#### 5.1 ç»Ÿä¸€ç±»å‹å®šä¹‰

**æ•´åˆ types/ ç›®å½•:**
```
types/
â”œâ”€â”€ index.ts               # ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ app.ts                 # AppStep ç­‰å…¨å±€ç±»å‹
â”œâ”€â”€ project.ts             # é¡¹ç›®ç›¸å…³ç±»å‹(å·²å­˜åœ¨)
â”œâ”€â”€ episode.ts             # å‰§é›†ç›¸å…³ç±»å‹
â”œâ”€â”€ shot.ts                # åˆ†é•œç›¸å…³ç±»å‹
â”œâ”€â”€ character.ts           # è§’è‰²ç›¸å…³ç±»å‹
â””â”€â”€ workflow.ts            # å·¥ä½œæµç›¸å…³ç±»å‹
```

### ç¬¬å…­é˜¶æ®µ:æ€§èƒ½ä¼˜åŒ–(ä¼˜å…ˆçº§â­â­)

#### 6.1 æ‡’åŠ è½½å¤§å‹ç»„ä»¶
```typescript
const ProjectWizardPage = lazy(() => import('@/pages/ProjectWizardPage'));
const FinalStoryboard = lazy(() => import('@/components/FinalStoryboard'));

// ä½¿ç”¨ Suspense åŒ…è£¹
<Suspense fallback={<LoadingOverlay />}>
  <ProjectWizardPage />
</Suspense>
```

#### 6.2 é¿å…å¤§æ•°æ®å­˜å‚¨åˆ° localStorage
```typescript
// ä»…å­˜å‚¨å¿…è¦å…ƒæ•°æ®,å¤§å›¾ç‰‡æ•°æ®ç”¨äº‘å­˜å‚¨
const STORAGE_EXCLUDE = ['hqUrls', 'reanalyzeResult'];
```

## å®æ–½è®¡åˆ’(åˆ†3å‘¨å®Œæˆ)

### Week 1:çŠ¶æ€ç®¡ç†é‡æ„ â­â­â­â­â­
- [ ] Day 1-2:å®‰è£… Zustand,åˆ›å»º useAppStore
- [ ] Day 3-4:è¿ç§» 60+ useState åˆ° Zustand
- [ ] Day 5:æµ‹è¯•çŠ¶æ€æŒä¹…åŒ–æ˜¯å¦æ­£å¸¸

### Week 2:ç»„ä»¶æ‹†åˆ† â­â­â­â­
- [ ] Day 1:åˆ›å»º components/ ç›®å½•ç»“æ„
- [ ] Day 2-3:æ‹†åˆ†å·¥ä½œæµæ­¥éª¤ç»„ä»¶(6ä¸ªæ­¥éª¤)
- [ ] Day 4:æ‹†åˆ†é¡¹ç›®ç®¡ç†ç»„ä»¶(3ä¸ªé¡µé¢)
- [ ] Day 5:æµ‹è¯•ç»„ä»¶é—´é€šä¿¡

### Week 3:é€»è¾‘æå–ä¸ä¼˜åŒ– â­â­â­
- [ ] Day 1-2:åˆ›å»ºè‡ªå®šä¹‰ Hooks(7ä¸ª)
- [ ] Day 3:åˆ›å»ºé¡µé¢çº§ç»„ä»¶
- [ ] Day 4:App.tsx ç®€åŒ–ä¸ºè·¯ç”±é…ç½®
- [ ] Day 5:æ•´ä½“æµ‹è¯•+æ€§èƒ½ä¼˜åŒ–

## é‡æ„åŸåˆ™

1. **æ¸è¿›å¼è¿ç§»**:ä¸è¦ä¸€æ¬¡æ€§é‡å†™,å…ˆä»æœ€ç—›çš„çŠ¶æ€ç®¡ç†å¼€å§‹
2. **ä¿æŒåŠŸèƒ½å®Œæ•´**:æ¯æ¬¡é‡æ„åå¿…é¡»é€šè¿‡åŠŸèƒ½æµ‹è¯•
3. **å‘åå…¼å®¹**:æ—§ä»£ç é€æ­¥åºŸå¼ƒ,ä¸ç›´æ¥åˆ é™¤
4. **ç±»å‹å®‰å…¨**:æ‰€æœ‰æ–°ä»£ç å¿…é¡»æœ‰ TypeScript ç±»å‹æ³¨è§£

## é£é™©æ§åˆ¶

- âœ… åœ¨ Git åˆ†æ”¯è¿›è¡Œé‡æ„,ä¿ç•™ main åˆ†æ”¯ä½œä¸ºå¤‡ä»½
- âœ… æ¯ä¸ªé˜¶æ®µå®Œæˆåæäº¤ä¸€æ¬¡,ä¾¿äºå›æ»š
- âœ… ä½¿ç”¨ React DevTools ç›‘æ§ç»„ä»¶æ¸²æŸ“æ€§èƒ½
- âœ… éƒ¨ç½²å‰è¿›è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•

## âœ… æ›´ä¼˜æ–¹æ¡ˆå»ºè®®ï¼ˆå®‰å…¨å‡çº§ç‰ˆï¼‰

> ç›®æ ‡ï¼šé™ä½â€œå¼€èƒ¸æ‰‹æœ¯â€é£é™©ï¼Œå…ˆå»ºç«‹å¯å›æ»šè¾¹ç•Œï¼Œå†é€æ­¥æ›¿æ¢ã€‚

### 1) è¾¹ç•Œå…ˆè¡Œï¼ˆå¥‘çº¦æ¥å£ï¼‰
**æ ¸å¿ƒæ€è·¯ï¼šå…ˆå®šä¹‰å¥‘çº¦ï¼Œå†è¿ç§»å®ç°ã€‚**
- å…ˆåœ¨ App.tsx å†…éƒ¨å»ºç«‹æ¸…æ™°çš„ **ä¸‰å±‚è¾¹ç•Œ**ï¼š
  1. **Data Layer**ï¼ˆAPI / storage / streamï¼‰
  2. **Business Layer**ï¼ˆæµç¨‹è§„åˆ™ / çŠ¶æ€æœºï¼‰
  3. **UI Layer**ï¼ˆç»„ä»¶æ¸²æŸ“ï¼‰
- å…ˆæŠ½è±¡æ¥å£ï¼ˆä¾‹å¦‚ï¼š`StoryboardService`ã€`AiStreamRunner`ã€`StorageAdapter`ï¼‰ã€‚
- è¿™æ ·åç»­æ‹†æ–‡ä»¶æˆ–æ›¿æ¢å®ç°ï¼Œéƒ½æ˜¯â€œæ›¿æ¢æ¨¡å—â€ï¼Œè€Œä¸æ˜¯â€œæ¬å®¶â€ã€‚

### 2) å…ˆåšæµç¨‹çŠ¶æ€æœºï¼Œå†åš Router
**Router åªæ˜¯åˆ‡é¡µé¢ï¼Œå¤æ‚åº¦åœ¨æµç¨‹æœ¬èº«ã€‚**
- å»ºè®®ç”¨ XState æˆ– Zustand state-machine æ¨¡å¼ï¼Œå…ˆç¨³å®š `AppStep` çš„æµç¨‹å›¾ã€‚
- UI åªæ¶ˆè´¹çŠ¶æ€æœºï¼Œæµç¨‹æ¸…æ™°åå†åšè·¯ç”±åŒ–ï¼Œé£é™©æ›´ä½ã€‚

### 3) æµå¼ AI é€»è¾‘ç‹¬ç«‹åŒ–ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
**è¿™æ˜¯æœ€é«˜å±åŒºåŸŸï¼Œå¿…é¡»éš”ç¦»ã€‚**
- å»ºä¸€ä¸ª `AiTaskRunner`ï¼ˆå•ä¾‹æ¨¡å— / Zustand slice / Web Workerï¼‰ã€‚
- UI åªè®¢é˜…çŠ¶æ€ï¼Œä¸æ‰§è¡Œæµå¼é€»è¾‘ã€‚
- é¡µé¢å¸è½½ä¸ä¼šå¯¼è‡´ AI ç”Ÿæˆä¸­æ–­ã€‚

### 4) Branch by Abstractionï¼ˆå¯å›æ»šæ›¿æ¢ï¼‰
**è¡Œä¸šæœ€å®‰å…¨é‡æ„ç­–ç•¥ï¼š**
1. å…ˆå†™æ¥å£
2. æ—§å®ç°ä¸æ–°å®ç°å¹¶å­˜
3. ç”¨ feature flag åˆ‡æ¢

### 5) æµ‹è¯•ç­–ç•¥å‡çº§ï¼ˆE2E + å¥‘çº¦æµ‹è¯•ï¼‰
- **E2E**ï¼šè¦†ç›–ä¸»æµç¨‹ï¼ˆä¸Šä¼ å‰§æœ¬ â†’ åˆ†é•œ â†’ å‡ºå›¾ï¼‰
- **å¥‘çº¦/æµç¨‹æµ‹è¯•**ï¼šè¦†ç›–çŠ¶æ€æœºå’Œæ•°æ®è¿ç§»ï¼ˆå°¤å…¶æ˜¯ LocalStorage è¿ç§»ï¼‰

### âœ… æ¨èæ‰§è¡Œé¡ºåºï¼ˆæ›´å®‰å…¨ï¼‰
1. **Phase 0ï¼šå¥‘çº¦å±‚ + æµç¨‹çŠ¶æ€æœº**
2. **Phase 1ï¼šæµå¼ AI ç‹¬ç«‹åŒ–**
3. **Phase 2ï¼šRouter + UI æ‹†åˆ†**
4. **Phase 3ï¼šæ•°æ®å±‚è¿ç§»ï¼ˆReact Query + Zustandï¼‰**
5. **Phase 4ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆè™šæ‹ŸåŒ–ï¼‰**

---

## é¢„æœŸæ”¶ç›Š

- ğŸ“‰ ä»£ç è¡Œæ•°: 5362 â†’ ~800 (App.tsx)
- âš¡ æ¸²æŸ“æ€§èƒ½: æå‡ 30% (å‡å°‘ä¸å¿…è¦çš„ re-render)
- ğŸ§ª å¯æµ‹è¯•æ€§: ä» 20% â†’ 80% (é€»è¾‘ä¸UIåˆ†ç¦»)
- ğŸ“š å¯ç»´æŠ¤æ€§: æ–°åŠŸèƒ½å¼€å‘æ—¶é—´å‡å°‘ 50%
- ğŸ› Bugä¿®å¤é€Ÿåº¦: æå‡ 40% (å®šä½é—®é¢˜æ›´å¿«)

## ç«‹å³å¯åšçš„å¿«é€Ÿä¼˜åŒ–(ä»Šæ™šå°±èƒ½å®Œæˆ)

### 1. æå– CoT(æ€ç»´é“¾)é€»è¾‘ â†’ hooks/useCoTGeneration.ts
å°† 1200+ è¡Œçš„æ€ç»´é“¾ç”Ÿæˆé€»è¾‘æŠ½ç¦»

### 2. æå–ä¹å®«æ ¼ç”Ÿå›¾é€»è¾‘ â†’ hooks/useImageGeneration.ts
å°† resumeNineGridTasksFromShots ç­‰å‡½æ•°æŠ½ç¦»

### 3. åˆ›å»º ProjectContext â†’ contexts/ProjectContext.tsx
é¿å… props drilling

éœ€è¦æˆ‘å¸®ä½ å¼€å§‹ç¬¬ä¸€æ­¥é‡æ„å—?å»ºè®®ä»"æå–CoTé€»è¾‘"å¼€å§‹,è¿™éƒ¨åˆ†æœ€ç‹¬ç«‹,é£é™©æœ€å°ã€‚
